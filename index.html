
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Galvan AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
   <style>
       /* --- START: SUPREME "CRYSTALLINE CORE" PROMPT BOX --- */

/* The outer container, now thinner for a sleek border effect */
.galvan-prompt-container {
    
/* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
             /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

           
       
  
  
  
    position: relative;
  
  border-radius: 40px; /* This will animate */
  padding: 3px; /* A thin, elegant border width */
  display: grid;
  place-content: center;
  z-index: 0;
  max-width: 270px;
  margin: 0 auto;
 
  transition: border-radius 0.5s var(--ease-out-quint);
}

/* The animated border, now invisible by default */
.galvan-prompt-container::before {
    content: '';
    
            /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
          
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(2px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

    position: absolute;
    inset: 0;
    z-index: -1;
    border-radius: inherit; /* Inherit the animated radius */
    background: conic-gradient(
        from var(--angle),
        var(--current-logo-stop-1),
        var(--current-logo-stop-2),
        var(--current-logo-stop-3),
        var(--current-logo-stop-2),
        var(--current-logo-stop-1)
    );
    opacity: 0; /* INVISIBLE BY DEFAULT */
    animation: spin 4s linear infinite paused; /* Ready, but not running */
    transition: opacity 0.4s var(--ease-smoother);
}




/* Shape-shifting class for when the input has multiple lines */

/* The main wrapper, clean and without shadow */
.galvan-prompt-wrapper {
  position: relative;
  width: 100%;
  border-radius: inherit; /* Always matches the animated container */
  
            /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

  padding: 5px;
  display: flex;
  align-items: center;
  gap: 5px;
}

/* The Text Input, now with inherited radius */
.prompt-input {
  padding: 8px;
  width: 100%;
     background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
             /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

  border: none;
  outline: none;
  color: var(--current-text-primary);
  font-size: 1rem;
  border-radius: 20px; /* Key for the shape-shifting effect */
  z-index: 1;
  height: 44px; /* A fixed, compact height */
  resize: none;
  order: 2;
  flex-grow: 1;
}
.prompt-input::placeholder { color: var(--current-text-placeholder); }


/* -- BUTTONS: Adapted for the new compact design -- */
.galvan-prompt-wrapper .prompt-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-shrink: 0;
    z-index: 2;
    position: relative;
    border: none;
   
            /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

    transition: all 0.3s var(--ease-spring-gentle);
}
.galvan-prompt-wrapper .prompt-btn:active:not(:disabled) {
    transform: scale(0.92);
}
.galvan-prompt-wrapper .prompt-btn svg { width: 20px; height: 20px; }

/* [+] Add / [x] Cancel Button on the LEFT, with MORPH animation */
#add-file-btn {
    order: 1;
    color: var(--current-icon-primary);
    overflow: hidden;
}
#add-file-btn .icon-add, #add-file-btn .icon-cancel-file {
    position: absolute;
    transition: transform 0.4s var(--ease-in-out-cubic), opacity 0.4s;
}
#add-file-btn .icon-add { transform: scale(1) rotate(0); opacity: 1; }
#add-file-btn .icon-cancel-file { transform: scale(0) rotate(-180deg); opacity: 0; }

.galvan-prompt-wrapper.file-attached #add-file-btn {
    background: var(--current-error-text);
    color: white;
    transform: rotate(135deg);
}
.galvan-prompt-wrapper.file-attached #add-file-btn .icon-add { transform: scale(0) rotate(180deg); opacity: 0; }
.galvan-prompt-wrapper.file-attached #add-file-btn .icon-cancel-file { transform: scale(1) rotate(0deg); opacity: 1; }

/* [▶️] Send / [⏹️] Stop Button on the RIGHT, with "COMET" & 3D FLIP animations */
#send-btn {
    order: 3;
    color: var(--current-icon-primary);
    background: none;
    transform: translateX(150%);
    opacity: 0;
    pointer-events: none;
    transition: all 0.5s var(--ease-out-quint);
}
.galvan-prompt-wrapper.has-text #send-btn {
    transform: translateX(0);
    opacity: 1;
    pointer-events: auto;
}
#send-btn:hover:not(:disabled) {
    transform: scale(1.1);
    filter: brightness(1.15);
}
#send-btn.stop-active {
    background: linear-gradient(135deg, var(--current-error-text), color-mix(in srgb, var(--current-error-text), black 20%));
}

#send-btn .icon-send, #send-btn .icon-stop {
    position: absolute;
    backface-visibility: hidden;
    transition: transform 0.5s var(--ease-in-out-cubic);
}
#send-btn .icon-send { transform: rotateY(0deg); }
#send-btn .icon-stop { transform: rotateY(180deg); }
#send-btn.stop-active .icon-send { transform: rotateY(-180deg); }
#send-btn.stop-active .icon-stop { transform: rotateY(0deg); }

/* --- END: SUPREME "CRYSTALLINE CORE" PROMPT BOX --- */

  /* --- START: Redesigned App Lock Screen --- */
/* [COMPLETELY NEW DESIGN] - The "Continuum" Lock Screen */
#galvan-pin-lock-overlay {
    position: fixed;
    inset: 0;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    background-color: hsl(220, 30%, 8%); /* Very dark, sophisticated blue */
    overflow: hidden;
    transition: opacity 0.6s var(--ease-smoother), visibility 0s 0.6s;
}
#galvan-pin-lock-overlay.visible {
    opacity: 1;
    visibility: visible;
}
/* Subtle, slow-moving mesh gradient for a premium feel */
#galvan-pin-lock-overlay::before {
    content: '';
    position: absolute;
    inset: -200px;
    background-image:
        radial-gradient(circle at 15% 20%, var(--current-icon-active), transparent 25%),
        radial-gradient(circle at 85% 70%, var(--current-logo-stop-3), transparent 25%);
    filter: blur(80px);
    opacity: 0.4;
    animation: continuum-flow 30s linear infinite alternate;
}
@keyframes continuum-flow {
    from { transform: rotate(0deg) scale(1.2); }
    to { transform: rotate(360deg) scale(1.2); }
}

.galvan-pin-lock-container {
    display: flex;
    
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    width: 100%;
    max-width: 360px;
    z-index: 1;
    transition: all 0.5s var(--ease-out-quint);
}
.galvan-pin-lock-container > * {
    opacity: 0;
    transform: translateY(25px);
    animation: continuumElementEnter 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}
@keyframes continuumElementEnter {
    to { opacity: 1; transform: translateY(0); }
}

/* Staggered animations */
#lock-screen-avatar-container { animation-delay: 0.1s; }
.galvan-pin-lock-title { animation-delay: 0.2s; }
.galvan-pin-lock-subtitle { animation-delay: 0.3s; }
#pin-input-area { animation-delay: 0.4s; width: 100%; }

#lock-screen-avatar-container {
    margin-bottom: 20px;
    filter: drop-shadow(0 0 10px color-mix(in srgb, var(--current-icon-active) 30%, transparent));
}
#lock-screen-avatar-container .galvan-vv-structure-container {
    width: 90px; height: 90px;
    animation: none; /* Disable default rotation for a cleaner look */
}

.galvan-pin-lock-title {
    font-size: 1.7rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 8px;
    text-shadow: 0 1px 5px rgba(0,0,0,0.2);
}
.galvan-pin-lock-subtitle {
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 30px;
}



/* NEW: Continuum Keypad */
.galvan-pin-keypad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 28px;
    
 
border-radius:20px;
max-height:1000px;
    margin-bottom: 25px;
    position: relative;
}
.galvan-pin-key {
    --ripple-color: color-mix(in srgb, var(--current-icon-active) 70%, #fff);
    position: relative;
    width: 40px; height: 40px;
    border-radius: 24px; /* Super-ellipse shape */
    
    border-image-slice: 1;
    border-image-source: linear-gradient(145deg, rgba(255,255,255,0.4), rgba(255,255,255,0.1));
   
            /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

    color: rgba(255, 255, 255, 0.8);
    font-size: 2rem;
    margin-left:4px;
    font-weight: 400;
    cursor: pointer;
    transition: transform 0.2s var(--ease-out-quint), background-color 0.2s;
    overflow: hidden; /* Important for ripple effect */
}
    /* NEW: "Nova Pulse" PIN Dots */
.galvan-pin-dots-container {
    display: flex;
    
    gap: 25px; /* A more spacious and modern gap */
    justify-content: center;
    margin-bottom: 40px;
    height: 24px; /* Fixed height to prevent any layout shift during animation */
    perspective: 200px; /* Helps with 3D-like animations if needed */
}

.galvan-pin-dot {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    /* The "unfilled" state is a very soft, semi-transparent ring */
    background-color: transparent;
    border: 2px solid rgba(255, 255, 255, 0.15);
    position: relative;
    box-shadow: inset 0 0 4px rgba(0,0,0,0.2);
    transition: border-color 0.3s;
}

/* The pseudo-element is our animated "nova" core */
.galvan-pin-dot::before {
    content: '';
    position: absolute;
    /* Center the pseudo-element */
    top: 50%;
    left: 50%;
    width: 100%;
    height: 100%;
    margin-left: -50%;
    margin-top: -50%;
    border-radius: 50%;
    background-color: #fff;
    /* Initially invisible and scaled down */
    transform: scale(0);
    opacity: 0;
    box-shadow: 0 0 0 #fff; /* Prepare for glowing */
}

/* This class triggers the new animation */
.galvan-pin-dot.filled::before {
    animation: nova-pulse 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28) forwards;
}

/* The animation itself */
@keyframes nova-pulse {
    0% {
        transform: scale(0);
        opacity: 0.5;
    }
    40% {
        /* The burst: expands beyond its final size with a bright glow */
        transform: scale(1.4);
        opacity: 1;
        box-shadow: 0 0 18px #fff, 0 0 28px var(--current-icon-active);
    }
    100% {
        /* Settle: shrinks back to the final size with a soft, stable glow */
        transform: scale(1);
        opacity: 1;
        box-shadow: 0 0 8px #fff, 0 0 12px var(--current-icon-active);
    }
}
.galvan-pin-key span { /* Put text in a span for z-index control */
    position: relative;
    z-index: 2;
    
}
.galvan-pin-key:hover {
    background-color: rgba(255, 255, 255, 0.07);
    border-image-source: linear-gradient(145deg, rgba(255,255,255,0.7), rgba(255,255,255,0.3));
}
/* Ripple effect on active */
.galvan-pin-key::after {
    content: '';
    position: absolute;
    z-index: 1;
    top: 50%; left: 50%;
    width: 10px; height: 10px;
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
    border-radius: 50%;
    background: radial-gradient(circle, var(--ripple-color) 20%, transparent 80%);
}
.galvan-pin-key:active {
    transform: scale(0.95);
    transition-duration: 0.1s;
}
.galvan-pin-key:active::after {
    animation: continuum-ripple 0.4s ease-out;
}
@keyframes continuum-ripple {
    from { transform: translate(-50%, -50%) scale(0); opacity: 0.8; }
    to { transform: translate(-50%, -50%) scale(20); opacity: 0; }
}

.galvan-pin-key.key-backspace { display: inline-flex; align-items: center; justify-content: center; }
#lock-screen-forgot-btn {
    background: none; border: none; font-size: 0.9rem; font-weight: 500;
    cursor: pointer; color: rgba(255, 255, 255, 0.5);
    transition: color 0.2s;
}
#lock-screen-forgot-btn:hover { color: #fff; }

/* NEW: Forgot PIN Popup styles */
#galvan-forgot-pin-popup {
    position: fixed; inset: 0;
    z-index: 10001; /* Above lock screen */
    display: flex; align-items: center; justify-content: center;
    background-color: rgba(0,0,0,0.3);
    backdrop-filter: blur(10px) saturate(120%);
    -webkit-backdrop-filter: blur(10px) saturate(120%);
    opacity: 0; visibility: hidden;
    transition: opacity 0.4s var(--ease-smoother), visibility 0s 0.4s;
}
#galvan-forgot-pin-popup.visible {
    opacity: 1; visibility: visible;
    transition-delay: 0s;
}
.popup-container {
   
            /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    border-radius: 28px;
    padding: 30px;
    width: 90%; max-width: 320px;
    text-align: center;
    transform: scale(0.9); opacity: 0;
    transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s;
}
#galvan-forgot-pin-popup.visible .popup-container {
    transform: scale(1);
    opacity: 1;
}
.popup-title {
    font-size: 1.3rem; font-weight: 600; color: #fff;
    margin-bottom: 15px;
}
.popup-text {
    font-size: 0.95rem; color: rgba(255,255,255,0.7);
    line-height: 1.6; margin-bottom: 25px;
}
.popup-ok-btn {
    background-color: var(--current-icon-active);
    color: #fff;
    border: none;
    border-radius: 16px;
    padding: 14px;
    width: 100%;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s, background-color 0.2s;
}
.popup-ok-btn:hover {
    background-color: var(--current-logo-stop-1);
}
.popup-ok-btn:active {
    transform: scale(0.96);
}

/* Landscape Layout */
@media (orientation: landscape) and (min-width: 700px) {
    .galvan-pin-lock-container {
        flex-direction: row; max-width: 800px;
        justify-content: space-evenly;
    }
    .galvan-pin-lock-info {
        display: flex; flex-direction: column;
        align-items: center; text-align: center;
    }
    #pin-input-area { max-width: 320px; }
    .galvan-pin-key { width: 75px; height: 75px; }
}

/* --- END: Redesigned App Lock Screen --- */
:root {
    --command-bar-expanded-height: 460px;
    --command-bar-tab-bar-height: 60px;
    --command-bar-expansion-offset: calc(var(--command-bar-expanded-height) - var(--galvan-command-bar-height-normal));
}
body.command-bar-expanded .galvan-main-content {
    transform: translateY(calc(-1 * var(--command-bar-expansion-offset)));
    border-radius: 24px; 
}
body.command-bar-expanded .galvan-toast-message {
    transform: translate(-50%, calc(-1 * var(--command-bar-expansion-offset)));
}
.galvan-command-bar-container {
    position: fixed;
    bottom: var(--galvan-command-bar-margin-bottom);
    left: 50%;
    transform: translateX(-50%) translateY(calc(var(--galvan-command-bar-height-normal) + var(--galvan-command-bar-margin-bottom) + var(--safe-bottom) + 20px));
    width: calc(100% - var(--galvan-command-bar-horizontal-padding) * 2);
    max-width: 300px;
    z-index: 50;
    border-radius: 34px; 
    background: rgba(255, 255, 255, 0.05);
   
 
    backdrop-filter: blur(5px) url(#liquid-refraction);
    -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    transition: background-color 0.1s var(--ease-smoother),
                border-color 0.5s var(--ease-smoother),
                box-shadow 0.5s var(--ease-smoother),
                height 0.3s var(--ease-out-quint),
                border-radius 0.6s var(--ease-out-quint),
                opacity 0.4s var(--ease-out-quint),
                transform 0.7s var(--ease-out-quint) var(--galvan-command-bar-entry-animation-delay);
    height: calc(var(--galvan-command-bar-height-normal) + var(--safe-bottom));
    overflow: hidden;
    will-change: height, transform, opacity, border-radius;
    display: flex;
    flex-direction: column;
    opacity: 0;
}
body.app-loaded .galvan-command-bar-container {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
.galvan-command-bar-container.expanded {
    height: calc(var(--command-bar-expanded-height) + var(--safe-bottom));
    border-radius: 38px;
    border-top-right-radius: 15px;
}
.galvan-command-bar-expanded-content-wrapper {
    opacity: 0;
    transition: opacity 0.3s var(--ease-out-quint);
}
.galvan-command-bar-container.expanded .galvan-command-bar-expanded-content-wrapper {
    opacity: 1;
    transition-delay: 0.35s;
}
.galvan-command-bar-container.collapsing .galvan-command-bar-expanded-content-wrapper {
    opacity: 0;
    transition-duration: 0.5s;
    transition-delay: 0s;
}
.galvan-command-bar-container.collapsing {
    animation: collapse-to-origin 0.2s var(--ease-in-out-cubic) 0.05s forwards;
}
.galvan-command-bar-content-view {
    opacity: 0;
    transform: translateY(20px);
   position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: calc(var(--command-bar-tab-bar-height) + var(--safe-bottom));
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 15px 5px 15px 20px;
    display: none;
}
.galvan-command-bar-container.expanded .galvan-command-bar-content-view.active-view {
    display: flex;
    flex-direction: column;
    opacity: 1;
    transform: translateY(0);
    transition-delay: 0.2s;
}
.galvan-command-bar-container.collapsing .galvan-command-bar-content-view.active-view {
    opacity: 0;
    transform: translateY(20px);
    transition-duration: 0.2s;
}
.galvan-command-bar {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 6px 8px calc(var(--safe-bottom) + 2px) 8px;
    height: calc(var(--galvan-command-bar-height-normal) + var(--safe-bottom));
    transition: opacity 0.3s var(--ease-soft-spring) 0.1s, transform 0.4s var(--ease-soft-spring) 0.1s;
    flex-shrink: 0;
    position: relative;
    z-index: 2;
    opacity: 1;
    transform: translateY(0) scale(1);
    gap: 5px;
}
.galvan-command-bar-container.expanded .galvan-command-bar {
    opacity: 0;
    pointer-events: none;
    transform: scale(0.9);
    transition-duration: 0.2s;
    transition-delay: 0s;
}
.galvan-nav-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--current-icon-primary);
    cursor: pointer;
    padding: 4px;
    border-radius: 20px;
    transition: all 0.25s var(--ease-out-quint);
    position: relative;
    overflow: visible;
    will-change: transform, color, background;
}
.galvan-nav-btn svg {
    width: 24px;
    height: 24px;
    transition: all 0.3s var(--ease-soft-spring);
}
.galvan-nav-btn .icon-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
}
.galvan-nav-btn .icon-wrapper > svg {
    position: absolute;
    top: 0;
    left: 0;
}
.galvan-nav-btn:hover:not(.active) {
    color: var(--current-icon-active);
}
.galvan-nav-btn:active {
    transform: scale(0.9);
    transition-duration: 0.1s;
}
.galvan-command-bar .galvan-nav-btn {
    flex-direction: column;
    flex-basis: 0;
    flex-grow: 1;
    max-width: 85px;
    min-height: 50px;
}
.galvan-command-bar .galvan-nav-btn::after {
    content: attr(aria-label);
    font-size: 11px;
    font-weight: 500;
    margin-top: 4px;
    line-height: 1.1;
    color: var(--current-text-secondary);
    transition: all 0.3s var(--ease-smoother);
}
#command-bar-settings-btn::after {
    content: 'Settings';
}
#theme-toggle-btn::after {
    content: 'Theme';
}
.galvan-command-bar .galvan-nav-btn:hover:not(.active) {
    transform: translateY(-2px);
}
.galvan-command-bar .galvan-nav-btn:hover:not(.active)::after {
    color: var(--current-icon-active);
}
.galvan-command-bar .galvan-nav-btn.active {
    color: var(--current-icon-active);
}
.galvan-command-bar .galvan-nav-btn.active::after {
    color: var(--current-icon-active);
    font-weight: 600;
}
.galvan-command-bar .galvan-nav-btn.active svg {
    transform: scale(1.05);
}
.galvan-command-bar-expanded-top-nav {
    display: flex;
    justify-content: space-around;
    align-items: stretch;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: calc(var(--command-bar-tab-bar-height) + var(--safe-bottom));
    padding: 0 10px var(--safe-bottom) 10px;
   
    background: var(--current-command-bar-bg);
    border-bottom-left-radius: 28px;
    border-bottom-right-radius: 28px;
    z-index: 10;
    opacity: 0;
    transform: translateY(15px);
    transition: opacity 0.4s var(--ease-out-quint), transform 0.4s var(--ease-out-quint);
}
.galvan-command-bar-expanded-top-nav .galvan-nav-btn {
    flex-grow: 1;
}
.galvan-command-bar-expanded-top-nav .galvan-nav-btn.active {
    color: var(--current-icon-active);
    font-weight: 600;
}
.galvan-command-bar-expanded-top-nav .galvan-nav-btn::before {
    content: '';
    position: absolute;
    bottom: 5px;
    height: 4px;
    width: 24px;
    background-color: var(--current-icon-active);
    border-radius: 2px;
    transform: scaleX(0);
    transition: transform 0.4s var(--ease-out-quint);
}
.galvan-command-bar-expanded-top-nav .galvan-nav-btn.active::before {
    transform: scaleX(1);
}
.galvan-command-bar-container.expanded .galvan-command-bar-expanded-top-nav {
    opacity: 1;
    transform: translateY(0);
    transition-delay: 0.15s;
}
.galvan-command-bar-expanded-top-nav .galvan-nav-btn {
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s, transform 0.4s;
}
.galvan-command-bar-container.expanded .galvan-command-bar-expanded-top-nav .galvan-nav-btn {
    opacity: 1;
    transform: translateY(0);
    transition-delay: calc(0.2s + var(--stagger-index) * 0.05s);
}
.galvan-command-bar-container.collapsing .galvan-command-bar-expanded-top-nav .galvan-nav-btn {
    opacity: 0;
    transform: translateY(10px);
    transition-duration: 0.2s;
    transition-delay: calc(var(--stagger-index-reverse) * 0.04s);
}
#theme-toggle-btn .icon-sun,
#theme-toggle-btn-cloned .icon-sun {
    opacity: 0;
    transform: scale(0.5) rotate(90deg);
}
#theme-toggle-btn .icon-moon,
#theme-toggle-btn-cloned .icon-moon {
    opacity: 0;
    transform: scale(0.5) rotate(-90deg);
}
body.light-mode #theme-toggle-btn .icon-sun,
body.light-mode #theme-toggle-btn-cloned .icon-sun {
    opacity: 1;
    transform: scale(1) rotate(0);
}
body:not(.light-mode) #theme-toggle-btn .icon-moon,
body:not(.light-mode) #theme-toggle-btn-cloned .icon-moon {
    opacity: 1;
    transform: scale(1) rotate(0);
}

.user-message .galvan-message-bubble {
  
            /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
      
            backdrop-filter:blur(10px);
     cursor: grab;
    
}

    /* THEME TOGGLE BUG FIX - Robust Selectors */
    #theme-toggle-btn .icon-sun, #theme-toggle-btn-cloned .icon-sun { opacity: 0; transform: scale(0.5) rotate(90deg); }
    #theme-toggle-btn .icon-moon, #theme-toggle-btn-cloned .icon-moon { opacity: 0; transform: scale(0.5) rotate(-90deg); }
    body.light-mode #theme-toggle-btn .icon-sun,
    body.light-mode #theme-toggle-btn-cloned .icon-sun { opacity: 1; transform: scale(1) rotate(0); }
    body:not(.light-mode) #theme-toggle-btn .icon-moon,
    body:not(.light-mode) #theme-toggle-btn-cloned .icon-moon { opacity: 1; transform: scale(1) rotate(0); }


  
    .user-message .galvan-message-bubble {
   
            /* Make the panel mostly transparent to let the backdrop show through */
           
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            
 color:var(--current-icon-primary);
    cursor: grab;
   
}
    
/* --- START: NEW FLOATING BOTTOM SHEET SELECTOR (REPLACEMENT) --- */
.galvan-custom-select-trigger {
    width: 150px;
    color:var(--current-icon-primary);
     background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    padding: 7px 30px 7px 12px;
    border-radius: 25px; /* Softer radius */
    font-size: 0.9rem;
    cursor: pointer;
    text-align: left;
    position: relative;
    will-change: transform, box-shadow;
    transition:
        border-color 0.25s var(--ease-smoother),
        box-shadow 0.35s var(--ease-out-quint),
        transform 0.35s var(--ease-spring);
}
.galvan-custom-select-trigger:hover {
    transform: translateY(-2.5px);
    box-shadow: 0 6px 16px -3px var(--current-shadow-strong);
    border-color: color-mix(in srgb, var(--current-icon-primary) 70%, transparent);
}
.galvan-custom-select-trigger::after {
    content: '';
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%) rotate(45deg);
    width: 7px;
    height: 7px;
    border: solid var(--current-icon-static);
    border-width: 0 2.5px 2.5px 0;
    transition: transform 0.3s var(--ease-out-quint);
}
.galvan-custom-select-trigger:hover::after {
    transform: translateY(-50%) rotate(45deg) scale(1.1);
}

#galvan-bottom-sheet-overlay {
    position: fixed;
    inset: 0;
    z-index: 1001;
    display: flex;
    justify-content: center;
    align-items: flex-end;
    background-color: rgba(0, 0, 0, 0); /* Darker overlay for focus */
    backdrop-filter: blur(5px); /* **NEW**: Blurs the main app content behind it */
    -webkit-backdrop-filter: blur(5px);
    transition: opacity 0.5s var(--ease-smoother), visibility 0s linear 0.5s;
    opacity: 0;
    visibility: hidden;
}
#galvan-bottom-sheet-overlay.visible {
    opacity: 1;
    visibility: visible;
    transition-delay: 0s;
}

.galvan-bottom-sheet-container {
    width:250px;
    max-width: 290px;
    margin: 0 auto var(--galvan-command-bar-margin-bottom);
      background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction); border-radius: 22px; /* **MORE** rounded corners */
    border: 1px solid color-mix(in srgb, var(--current-border-color) 40%, transparent);
    box-shadow: 0 0 0 1px rgba(255,255,255,0.08), 0 20px 60px -15px var(--current-shadow-strong);
    padding: 12px 12px calc(16px + var(--safe-bottom)) 12px;
    transform: translateY(calc(100% + 80px));
    transition: transform 0.8s cubic-bezier(0.22, 1, 0.36, 1); /* **NEW** fluid animation curve */
    will-change: transform;
    position: relative;
}

.galvan-bottom-sheet-container::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    width: 48px;
    height: 6px;
    background-color: color-mix(in srgb, var(--current-border-color) 80%, transparent);
    border-radius: 53px;
}

#galvan-bottom-sheet-overlay.visible .galvan-bottom-sheet-container {
    transform: translateY(0);
}

.galvan-bottom-sheet-header {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 24px 12px 18px 12px;
    position: relative;
    border-bottom: 1px solid var(--current-border-color);
    margin-bottom: 10px;
}
.galvan-bottom-sheet-title {
    font-size: 1.25rem;
    font-weight: 600;
    text-align: center;
}
.galvan-bottom-sheet-close-btn {
    position: absolute;
    top: 22px;
    right: 14px;
    background: var(--current-bg-tertiary);
    border: none;
    border-radius: 50%;
    width: 32px; height: 32px;
    color: var(--current-text-secondary);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: transform 0.25s var(--ease-out-quint), background-color 0.25s;
}
.galvan-bottom-sheet-close-btn:hover {
    background-color: var(--current-border-color);
    transform: scale(1.1);
}
.galvan-bottom-sheet-close-btn:active {
    transform: scale(0.9);
}
.galvan-bottom-sheet-close-btn svg {
    width: 16px; height: 16px;
}

.galvan-bottom-sheet-options {
    list-style: none;
    max-height: 50vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    padding: 8px;
}
.galvan-bottom-sheet-option {
    display: flex;
    align-items: center;
    padding: 18px;
    border-radius: 500px; /* **MORE** rounded options */
    font-size: 1.1rem;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s;
    opacity: 0;
    transform: translateY(30px) scale(0.95);
    margin-bottom: 8px;
    border: 1px solid transparent;
}
#galvan-bottom-sheet-overlay.visible .galvan-bottom-sheet-option {
    animation: optionEnterBottomSheet 0.8s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

@keyframes optionEnterBottomSheet {
    to { opacity: 1; transform: translateY(0) scale(1); }
}

.galvan-bottom-sheet-option:hover {
    background-color: var(--current-bg-tertiary);
    transform: scale(1.02);
}

/* **NEW** Selected option style */
.galvan-bottom-sheet-option.selected {
    background-color: var(--current-icon-primary);
    color: var(--app-bg-primary-light);
    font-weight: 600;
}

/* **NEW** Special Ticking Effect */
.galvan-bottom-sheet-option .check-icon {
    margin-left: auto;
    position: relative; /* For pseudo-element */
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: currentColor;
}

.galvan-bottom-sheet-option .check-icon::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 50%;
    background-color: var(--app-bg-primary-light); /* Ripple color */
    transform: scale(0);
    opacity: 0;
}

.galvan-bottom-sheet-option.selected .check-icon::before {
    animation: checkRipple 0.7s var(--ease-out-quint) forwards;
}

@keyframes checkRipple {
    0% { transform: scale(0); opacity: 0.6; }
    100% { transform: scale(1.6); opacity: 0; }
}

.galvan-bottom-sheet-option .check-icon svg {
    position: relative;
    z-index: 1; /* Keep SVG above ripple */
    width: 24px;
    height: 24px;
    opacity: 0;
    transform: scale(0.4) rotate(-180deg);
    transition: opacity 0.5s var(--ease-out-quint) 0.1s, transform 0.5s var(--ease-out-quint) 0.1s;
}

.galvan-bottom-sheet-option.selected .check-icon svg {
    opacity: 1;
    transform: scale(1) rotate(0);
}


@media (max-width: 410px) {
    .galvan-bottom-sheet-container {
        width: 100%;
        margin: 0;
        border-radius: 32px 32px 0 0;
        border-bottom: none;
    }
}


/* --- START: Prompt Navigation Buttons CSS --- */
.galvan-prompt-nav-buttons {
    display: flex;
    justify-content: center;
    gap: 80px; /* Space between buttons */
    margin-bottom: 12px;
    height: 28px;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s var(--ease-out-quint), transform 0.4s var(--ease-out-quint), height 0.4s var(--ease-out-quint), margin-bottom 0.4s var(--ease-out-quint);
    pointer-events: none;
}
.galvan-prompt-nav-buttons.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}
.galvan-prompt-nav-btn {
    width: 28px; height: 28px;
    background: var(--current-bg-secondary);
    border: 1px solid var(--current-border-color);
    border-radius: 50%;
    color: var(--current-icon-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px -2px var(--current-shadow-color);
    transition: transform 0.2s var(--ease-spring), background-color 0.2s, color 0.2s;
}
.galvan-prompt-nav-btn:hover:not(:disabled) {
    transform: scale(1.15);
    background: var(--current-bg-tertiary);
}
.galvan-prompt-nav-btn:active:not(:disabled) {
    transform: scale(0.9);
}
.galvan-prompt-nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    background: var(--current-bg-tertiary);
}
.galvan-prompt-nav-btn svg {
    width: 18px;
    height: 18px;
}
/* --- END: Prompt Navigation Buttons CSS --- */
  /* --- START OF REQUESTED CSS CHANGES --- */

/* This rule adds the vertical space BETWEEN each history item in the list. */
.galvan-history-list-view { 
    gap: 12px; 
    padding-top: 5px !important; 
    padding-right: 15px;
}

/* 
  These rules style each individual history item to be clickable.
  - `cursor: pointer;` makes the mouse cursor change to a hand.
  - The `:hover` style provides visual feedback when the user's mouse is over an item.
*/
.galvan-history-item {
   background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    padding: 15px 20px; 
    border-radius: 18px; 
   
    transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
    display: flex; 
    flex-direction: column; 
    gap: 12px;
    box-shadow: 0 4px 10px -5px var(--current-shadow-color);
    cursor: pointer; /* This makes the entire item clickable */
}
.galvan-history-item:hover { 
     background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    box-shadow: 0 6px 15px -5px var(--current-shadow-strong);
}

/* --- END OF REQUESTED CSS CHANGES --- */
/* --- START OF REQUESTED CSS CHANGES --- */
    :root {
        --safe-top: env(safe-area-inset-top, 0px);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --ease-out-quint: cubic-bezier(0.23, 1, 0.32, 1);
        --ease-in-out-cubic: cubic-bezier(0.65, 0, 0.35, 1);
        --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        --ease-spring-gentle: cubic-bezier(0.25, 1.5, 0.5, 1);
        --ease-soft-spring: cubic-bezier(0.4, 1.3, 0.6, 1);
        --ease-smoother: cubic-bezier(0.4, 0, 0.2, 1);
        --header-height: 52px;
        
        --galvan-command-bar-margin-bottom: 10px; /* MODIFIED: Gap reduction */
        --galvan-command-bar-horizontal-padding: 16px;
        --galvan-command-bar-height-normal: 64px; 
        --galvan-command-bar-height-expanded: 630px; 
        --galvan-command-bar-border-radius: 32px; 
        --galvan-command-bar-expanded-top-nav-height: 58px;
        --galvan-command-bar-entry-animation-delay: 0.5s;
        
        --galvan-logo-center-top: 28%;
        --galvan-logo-scroll-up-translate: -55px;
        --galvan-logo-final-size: 36px;     --galvan-logo-final-bottom: calc(var(--safe-bottom) + var(--galvan-command-bar-margin-bottom) + (var(--galvan-command-bar-height-normal) - var(--galvan-logo-final-size)) / 2);
        --galvan-logo-final-right: calc(var(--galvan-command-bar-horizontal-padding) + 18px);

        --galvan-suggestions-top-offset: 50%;
        --galvan-suggestions-container-border-radius: 38px;
        --galvan-suggestions-item-border-radius: 28px;
        
        --galvan-prompt-border-radius: 32px; 
        --galvan-prompt-height: 48px;
        --galvan-prompt-border-width: 2px;

        --galvan-logo-glow-std-deviation-large: 4.5; 
        --galvan-logo-glow-std-deviation-small: 2.8; 
        --galvan-logo-glow-opacity: 0.9;          
        --galvan-vv-border-stroke-width-large: 10; 
        --galvan-vv-border-stroke-width-small: 16; 

        --galvan-blur-intensity-multiplier: 1; 
        --galvan-ui-backdrop-blur-amount: 12px; 
        --galvan-background-main-blur-amount: 12px; 
        --galvan-background-main-blur-amount-dark-override: 15px;

        /* [NEW] Galvan Default Palette (Light) */
        --galvan-body-bg-light: #F4F7FA;
        --galvan-bg-primary-light: #FFFFFF;
        --galvan-bg-secondary-light: #F8F9FC;
        --galvan-bg-tertiary-light: #EFF2F7;
        --galvan-text-primary-light: #111827;
        --galvan-text-secondary-light: #000000;
        --galvan-text-placeholder-light: #000000;
        --galvan-border-color-light: #E5E7EB;
        --galvan-icon-primary-light: #2563EB;
        --galvan-icon-active-light: #1D4ED8;
        --galvan-icon-static-light: #6B7280;
        --galvan-user-msg-bg-light: linear-gradient(135deg, #3B82F6, #2563EB);
        --galvan-bot-msg-bg-light: #F3F4F6;
        --galvan-logo-stop-1-light: #c1f63bbc;
        --galvan-logo-stop-2-light: #06a5c5;
        --galvan-logo-stop-3-light: #34D399;
        --galvan-logo-glow-color-light: #60fa9e;
        --galvan-wave-color-light: rgba(59, 130, 246, 0.08);
        --galvan-logo-blur-grad-light: radial-gradient(circle at 20% 80%, hsla(223, 100%, 50%, 0.727), transparent 45%), radial-gradient(circle at 80% 30%, hsl(76, 100%, 50%), transparent 45%);
        --galvan-greeting-grad-light: linear-gradient(120deg, #1D4ED8, #3B82F6);

        /* [NEW] Galvan Default Palette (Dark) */
        --galvan-body-bg-dark: #030f46;
        --galvan-bg-primary-dark: #111827;
        --galvan-bg-secondary-dark: #1F2937;
        --galvan-bg-tertiary-dark: #374151;
        --galvan-text-primary-dark: #F9FAFB;
        --galvan-text-secondary-dark: #D1D5DB;
        --galvan-text-placeholder-dark: #9CA3AF;
        --galvan-border-color-dark: #4a4c4f;
        --galvan-icon-primary-dark: #60A5FA;
        --galvan-icon-active-dark: #93C5FD;
        --galvan-icon-static-dark: #eff5ff;
        --galvan-user-msg-bg-dark: linear-gradient(135deg, #2563EB, #3B82F6);
        --galvan-bot-msg-bg-dark: #374151;
        --galvan-logo-stop-1-dark: #c1f63bbc;
        --galvan-logo-stop-2-dark: #06a5c5;
        --galvan-logo-stop-3-dark: #34D399;
        --galvan-logo-glow-color-dark: #60A5FA;
        --galvan-wave-color-dark: rgba(96, 165, 250, 0.07);
       --galvan-logo-blur-grad-dark: radial-gradient(circle at 20% 80%, hsla(138, 100%, 50%, 0.916), transparent 45%), radial-gradient(circle at 80% 30%, hsl(201, 100%, 50%), transparent 45%);
        --galvan-greeting-grad-dark: linear-gradient(120deg, #1D4ED8, #3B82F6);
        /* Base Theme Colors - Light Mode (Can be overridden by palettes) */
        --app-body-bg-light: var(--galvan-body-bg-light);
        --app-bg-primary-light: var(--galvan-bg-primary-light);
        --app-bg-secondary-light: var(--galvan-bg-secondary-light);
        --app-bg-tertiary-light: var(--galvan-bg-tertiary-light);
        --app-text-primary-light: var(--galvan-text-primary-light);
        --app-text-secondary-light: var(--galvan-text-secondary-light);
        --app-text-placeholder-light: var(--galvan-text-placeholder-light);
        --app-border-color-light: var(--galvan-border-color-light);
        --app-icon-primary-light: var(--galvan-icon-primary-light);
        --app-icon-active-light: var(--galvan-icon-active-light);
        --app-icon-static-light: var(--galvan-icon-static-light);
        --app-shadow-color-light: rgba(76, 81, 191, 0.07);
        --app-shadow-strong-light: rgba(76, 81, 191, 0.12);
        --app-error-text-light: #E53E3E;
        --app-link-color-light: var(--galvan-icon-active-light);
        --app-toast-bg-light: rgba(17, 24, 39, 0.92);
        --app-toast-text-light: #F9FAFB;
        --app-user-msg-bg-light: var(--galvan-user-msg-bg-light);
        --app-bot-msg-bg-light: var(--galvan-bot-msg-bg-light);
        --app-suggestions-bg-light: rgba(248, 249, 252, 0.3); /* Reduced opacity for better blur */
        --app-command-bar-bg-light: rgba(255, 255, 255, 0.78); /* Reduced opacity */
        --app-chat-blur-bg-light: rgba(240, 244, 248, 0.6);
        --app-like-color-light: #10B981;
        --app-dislike-color-light: #EF4444;
        --app-logo-blur-grad-light: var(--galvan-logo-blur-grad-light);
        --app-logo-stop-1-light: var(--galvan-logo-stop-1-light);
        --app-logo-stop-2-light: var(--galvan-logo-stop-2-light);
        --app-logo-stop-3-light: var(--galvan-logo-stop-3-light);
        --app-logo-glow-color-light: var(--galvan-logo-glow-color-light);
        --app-switch-bg-light: #D1D5DB;
        --app-switch-thumb-light: #FFFFFF;
     
        --app-wave-color-light: var(--galvan-wave-color-light);
        --app-font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --app-font-size: 16px;
        --app-greeting-grad-light: var(--galvan-greeting-grad-light);

        /* Base Theme Colors - Dark Mode (Can be overridden by palettes) */
        --app-body-bg-dark: var(--galvan-body-bg-dark); 
        --app-bg-primary-dark: var(--galvan-bg-primary-dark);
        --app-bg-secondary-dark: var(--galvan-bg-secondary-dark);
        --app-bg-tertiary-dark: var(--galvan-bg-tertiary-dark);
        --app-text-primary-dark: var(--galvan-text-primary-dark);
        --app-text-secondary-dark: var(--galvan-text-secondary-dark);
        --app-text-placeholder-dark: var(--galvan-text-placeholder-dark);
        --app-border-color-dark: var(--galvan-border-color-dark);
        --app-icon-primary-dark: var(--galvan-icon-primary-dark);
        --app-icon-active-dark: var(--galvan-icon-active-dark);
        --app-icon-static-dark: var(--galvan-icon-static-dark);
        --app-shadow-color-dark: rgba(0, 0, 0, 0.30);
        --app-shadow-strong-dark: rgba(0, 0, 0, 0.45);
        --app-error-text-dark: #F87171;
        --app-link-color-dark: #93C5FD;
        --app-toast-bg-dark: rgba(249, 250, 251, 0.92);
        --app-toast-text-dark: #1F2937;
        --app-user-msg-bg-dark: var(--galvan-user-msg-bg-dark);
        --app-bot-msg-bg-dark: var(--galvan-bot-msg-bg-dark);
        --app-suggestions-bg-dark: rgba(31, 41, 55, 0.05); /* Reduced opacity */
        --app-command-bar-bg-dark: rgba(17, 24, 39, 0.8); /* Reduced opacity */
        --app-chat-blur-bg-dark: rgba(31, 41, 55, 0.65);
        --app-like-color-dark: #34D399;
        --app-dislike-color-dark: #F87171;
        --app-logo-blur-grad-dark: var(--galvan-logo-blur-grad-dark);
        --app-logo-stop-1-dark: var(--galvan-logo-stop-1-dark);
        --app-logo-stop-2-dark: var(--galvan-logo-stop-2-dark);
        --app-logo-stop-3-dark: var(--galvan-logo-stop-3-dark);
        --app-logo-glow-color-dark: var(--galvan-logo-glow-color-dark);
        --app-switch-bg-dark: #4B5563;
        --app-switch-thumb-dark: #111827;
      
        --app-wave-color-dark: var(--galvan-wave-color-dark);
        --app-greeting-grad-dark: var(--galvan-greeting-grad-dark);

        /* Current Theme Variables (Pointers) */
        --current-body-bg: var(--app-body-bg-light);
        --current-bg-primary: var(--app-bg-primary-light);
        --current-bg-secondary: var(--app-bg-secondary-light);
        --current-bg-tertiary: var(--app-bg-tertiary-light);
        --current-text-primary: var(--app-text-primary-light);
        --current-text-secondary: var(--app-text-secondary-light);
        --current-text-placeholder: var(--app-text-placeholder-light);
        --current-border-color: var(--app-border-color-light);
        --current-icon-primary: var(--app-icon-primary-light);
        --current-icon-active: var(--app-icon-active-light);
        --current-icon-static: var(--app-icon-static-light);
        --current-shadow-color: var(--app-shadow-color-light);
        --current-shadow-strong: var(--app-shadow-strong-light);
        --current-error-text: var(--app-error-text-light);
        --current-thinking-text: var(--app-text-secondary-light);
        --current-link-color: var(--app-link-color-light);
        --current-toast-bg: var(--app-toast-bg-light);
        --current-toast-text: var(--app-toast-text-light);
        --current-user-msg-bg: var(--app-user-msg-bg-light);
        --current-bot-msg-bg: var(--app-bot-msg-bg-light);
        --current-suggestions-bg: var(--app-suggestions-bg-light);
        --current-command-bar-bg: var(--app-command-bar-bg-light);
        --current-chat-blur-bg: var(--app-chat-blur-bg-light);
        --current-background-main-blur-amount-actual: var(--galvan-background-main-blur-amount);
        --current-like-color: var(--app-like-color-light);
        --current-dislike-color: var(--app-dislike-color-light);
        --current-action-active-bg: color-mix(in srgb, var(--app-icon-active-light) 10%, transparent);
        --current-prompt-focus-shadow: color-mix(in srgb, var(--app-icon-active-light) 20%, transparent);
        --current-prompt-border-color: var(--app-border-color-light);
        --current-logo-blur-grad: var(--app-logo-blur-grad-light);
        --current-logo-stop-1: var(--app-logo-stop-1-light);
        --current-logo-stop-2: var(--app-logo-stop-2-light);
        --current-logo-stop-3: var(--app-logo-stop-3-light);
        --current-logo-glow-color: var(--app-logo-glow-color-light);
        --current-suggestion-grad-idle: linear-gradient(135deg, var(--app-bg-primary-light), color-mix(in srgb, var(--app-bg-secondary-light) 80%, var(--app-bg-primary-light)));
        --current-suggestion-grad-active: linear-gradient(135deg, color-mix(in srgb, var(--app-icon-active-light) 5%, var(--app-bg-primary-light)), color-mix(in srgb, var(--app-icon-active-light) 15%, var(--app-bg-secondary-light)));
        --current-internal-animated-grad: linear-gradient(120deg, rgba(173, 216, 230, 0.55), rgba(144, 238, 144, 0.55), rgba(255, 255, 224, 0.6), rgba(255, 192, 203, 0.55), rgba(173, 216, 230, 0.55));
        --current-switch-bg: var(--app-switch-bg-light);
        --current-switch-bg-active: var(--app-icon-active-light);
        --current-switch-thumb: var(--app-switch-thumb-light);
        --current-logo-glow-std-deviation: var(--galvan-logo-glow-std-deviation-large);
        --current-history-item-hover-bg: color-mix(in srgb, var(--app-bg-tertiary-light) 70%, var(--app-bg-secondary-light) 30%);
        --current-history-action-btn-bg: var(--app-bg-tertiary-light);
        --current-history-action-btn-hover-bg: color-mix(in srgb, var(--app-border-color-light) 70%, var(--app-bg-tertiary-light) 30%);
        --current-history-load-btn-bg: var(--app-icon-static-light);
        --current-history-load-btn-text: var(--app-bg-primary-light);
        --current-history-load-btn-hover-bg: var(--app-icon-primary-light);
       
        --current-settings-select-bg: var(--app-bg-tertiary-light);
        --current-font-family: var(--app-font-family);
        --current-font-size: var(--app-font-size);
        --current-wave-color: var(--app-wave-color-light);
        --current-greeting-grad: var(--app-greeting-grad-light);
        --current-suggestion-swipe-send-bg: var(--app-like-color-light);
        --current-suggestion-swipe-delete-bg: var(--app-dislike-color-light);
        --current-pin-bg: rgba(255,255,255,0.7);
        --current-pin-dot-bg: #1F2937;
        --current-lock-forgot-color: #E53E3E;

        /* Animations */
        --logo-rotate-speed: 2s; 
        --logo-blur-rotate-speed: 10s;
        --logo-blur-rotate-speed-inner: 14s;
        --typing-speed: 15ms;
        --logo-transition-speed: 1.3s; 
        --welcome-fade-speed: 0.4s;
        --chat-bg-rotate-speed: 25s;
        --internal-gradient-anim-speed: 8s;
        --message-fade-out-duration: 0.3s; 
        --message-regen-out-duration: 0.4s;
    }

    body.light-mode {
        --current-body-bg: var(--app-body-bg-light);
        --current-bg-primary: var(--app-bg-primary-light);
        --current-bg-secondary: var(--app-bg-secondary-light);
        --current-bg-tertiary: var(--app-bg-tertiary-light);
        --current-text-primary: var(--app-text-primary-light);
        --current-text-secondary: var(--app-text-secondary-light);
        --current-text-placeholder: var(--app-text-placeholder-light);
        --current-border-color: var(--app-border-color-light);
        --current-icon-primary: var(--app-icon-primary-light);
        --current-icon-active: var(--app-icon-active-light);
        --current-icon-static: var(--app-icon-static-light);
        --current-shadow-color: var(--app-shadow-color-light);
        --current-shadow-strong: var(--app-shadow-strong-light);
        --current-error-text: var(--app-error-text-light);
        --current-link-color: var(--app-link-color-light);
        --current-toast-bg: var(--app-toast-bg-light);
        --current-toast-text: var(--app-toast-text-light);
        --current-user-msg-bg: var(--app-user-msg-bg-light);
        --current-bot-msg-bg: var(--app-bot-msg-bg-light);
        --current-suggestions-bg: var(--app-suggestions-bg-light);
        --current-command-bar-bg: var(--app-command-bar-bg-light);
        --current-chat-blur-bg: var(--app-chat-blur-bg-light);
        --current-background-main-blur-amount-actual: var(--galvan-background-main-blur-amount);
        --current-like-color: var(--app-like-color-light);
        --current-dislike-color: var(--app-dislike-color-light);
        --current-logo-blur-grad: var(--app-logo-blur-grad-light);
        --current-logo-stop-1: var(--app-logo-stop-1-light);
        --current-logo-stop-2: var(--app-logo-stop-2-light);
        --current-logo-stop-3: var(--app-logo-stop-3-light);
        --current-logo-glow-color: var(--app-logo-glow-color-light);
        --current-switch-bg: var(--app-switch-bg-light);
        --current-switch-bg-active: var(--app-icon-active-light);
        --current-switch-thumb: var(--app-switch-thumb-light);
        --current-notice-dot-color: var(--app-notice-dot-color-light);
        --current-settings-select-bg: var(--app-bg-tertiary-light);
        --current-history-item-hover-bg: color-mix(in srgb, var(--app-bg-tertiary-light) 70%, var(--app-bg-secondary-light) 30%);
        --current-history-action-btn-bg: var(--app-bg-tertiary-light);
        --current-history-action-btn-hover-bg: color-mix(in srgb, var(--app-border-color-light) 70%, var(--app-bg-tertiary-light) 30%);
        --current-history-load-btn-bg: var(--app-icon-static-light);
        --current-history-load-btn-text: var(--app-bg-primary-light);
        --current-history-load-btn-hover-bg: var(--app-icon-primary-light);
        --current-action-active-bg: color-mix(in srgb, var(--app-icon-active-light) 10%, transparent);
        --current-prompt-focus-shadow: color-mix(in srgb, var(--app-icon-active-light) 20%, transparent);
        --current-prompt-border-color: var(--app-border-color-light);
        --current-suggestion-grad-idle: linear-gradient(135deg, var(--app-bg-primary-light), color-mix(in srgb, var(--app-bg-secondary-light) 80%, var(--app-bg-primary-light)));
        --current-suggestion-grad-active: linear-gradient(135deg, color-mix(in srgb, var(--app-icon-active-light) 5%, var(--app-bg-primary-light)), color-mix(in srgb, var(--app-icon-active-light) 15%, var(--app-bg-secondary-light)));
        --current-wave-color: var(--app-wave-color-light);
        --current-greeting-grad: var(--app-greeting-grad-light);
        --current-suggestion-swipe-send-bg: var(--app-like-color-light);
        --current-suggestion-swipe-delete-bg: var(--app-dislike-color-light);
        --current-pin-bg: rgba(249, 250, 251, 0.75);
        --current-pin-dot-bg: #111827;
        --current-lock-forgot-color: #E53E3E;
    }

    body:not(.light-mode) { /* Dark Mode */
        --current-body-bg: var(--app-body-bg-dark);
        --current-bg-primary: var(--app-bg-primary-dark);
        --current-bg-secondary: var(--app-bg-secondary-dark);
        --current-bg-tertiary: var(--app-bg-tertiary-dark);
        --current-text-primary: var(--app-text-primary-dark);
        --current-text-secondary: var(--app-text-secondary-dark);
        --current-text-placeholder: var(--app-text-placeholder-dark);
        --current-border-color: var(--app-border-color-dark);
        --current-icon-primary: var(--app-icon-primary-dark);
        --current-icon-active: var(--app-icon-active-dark);
        --current-icon-static: var(--app-icon-static-dark);
        --current-shadow-color: var(--app-shadow-color-dark);
        --current-shadow-strong: var(--app-shadow-strong-dark);
        --current-error-text: var(--app-error-text-dark);
        --current-link-color: var(--app-link-color-dark);
        --current-toast-bg: var(--app-toast-bg-dark);
        --current-toast-text: var(--app-toast-text-dark);
        --current-user-msg-bg: var(--app-user-msg-bg-dark);
        --current-bot-msg-bg: var(--app-bot-msg-bg-dark);
        --current-suggestions-bg: var(--app-suggestions-bg-dark);
        --current-command-bar-bg: var(--app-command-bar-bg-dark);
        --current-chat-blur-bg: var(--app-chat-blur-bg-dark);
        --current-background-main-blur-amount-actual: var(--galvan-background-main-blur-amount-dark-override);
        --current-like-color: var(--app-like-color-dark);
        --current-dislike-color: var(--app-dislike-color-dark);
        --current-logo-blur-grad: var(--app-logo-blur-grad-dark);
        --current-logo-stop-1: var(--app-logo-stop-1-dark);
        --current-logo-stop-2: var(--app-logo-stop-2-dark);
        --current-logo-stop-3: var(--app-logo-stop-3-dark);
        --current-logo-glow-color: var(--app-logo-glow-color-dark);
        --current-switch-bg: var(--app-switch-bg-dark);
        --current-switch-bg-active: var(--app-icon-active-dark);
        --current-switch-thumb: var(--app-switch-thumb-dark);
        --current-notice-dot-color: var(--app-notice-dot-color-dark);
        --current-settings-select-bg: var(--app-bg-tertiary-dark);
        --current-history-item-hover-bg: color-mix(in srgb, var(--app-bg-tertiary-dark) 70%, var(--app-bg-secondary-dark) 30%);
        --current-history-action-btn-bg: var(--app-bg-tertiary-dark);
        --current-history-action-btn-hover-bg: color-mix(in srgb, var(--app-border-color-dark) 70%, var(--app-bg-tertiary-dark) 30%);
        --current-history-load-btn-bg: var(--app-icon-static-dark);
        --current-history-load-btn-text: var(--app-bg-primary-dark);
        --current-history-load-btn-hover-bg: var(--app-icon-primary-dark);
        --current-action-active-bg: color-mix(in srgb, var(--app-icon-active-dark) 10%, transparent);
        --current-prompt-focus-shadow: color-mix(in srgb, var(--app-icon-active-dark) 20%, transparent);
        --current-prompt-border-color: var(--app-border-color-dark);
        --current-suggestion-grad-idle: linear-gradient(135deg, var(--app-bg-primary-dark), color-mix(in srgb, var(--app-bg-secondary-dark) 80%, var(--app-bg-primary-dark)));
        --current-suggestion-grad-active: linear-gradient(135deg, color-mix(in srgb, var(--app-icon-active-dark) 5%, var(--app-bg-primary-dark)), color-mix(in srgb, var(--app-icon-active-dark) 15%, var(--app-bg-secondary-dark)));
        --current-wave-color: var(--app-wave-color-dark);
        --current-greeting-grad: var(--app-greeting-grad-dark);
        --current-suggestion-swipe-send-bg: var(--app-like-color-dark);
        --current-suggestion-swipe-delete-bg: var(--app-dislike-color-dark);
        --current-pin-bg: rgba(31, 41, 55, 0.8);
        --current-pin-dot-bg: #F9FAFB;
        --current-lock-forgot-color: #F87171;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html { height: 100%; }

    body {
        height: 100%;
        overscroll-behavior-y: contain;
        font-family: var(--current-font-family);
        font-size: var(--current-font-size);
        display: flex; justify-content: center; align-items: flex-start;
        color: var(--current-text-primary);
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        transition: color 0.5s var(--ease-smoother), font-family 0.3s var(--ease-smoother), font-size 0.3s var(--ease-smoother), background-color 0.5s var(--ease-smoother);
        
        background-color: var(--current-body-bg); 
        background-attachment: fixed;
        overflow: hidden; 
        position: relative;
    }
    
    .galvan-chat-background-blur, .galvan-user-image-background-blur {
        position: fixed; top: -10%; left: -10%; right: -10%; bottom: -10%;
        z-index: 0;
        pointer-events: none;
        will-change: opacity, filter, transform, background-image;
        transition: opacity 1.2s var(--ease-smoother), background-image 0.1s linear, filter 1s var(--ease-smoother);
    }

    .galvan-chat-background-blur { 
        background: var(--current-logo-blur-grad);
        filter: blur(var(--galvan-background-main-blur-amount)) ; 
        opacity: 0; 
        animation: rotateBackground var(--chat-bg-rotate-speed) linear infinite alternate, fadeInBackground 1.5s var(--ease-out-quint) forwards;
    }
    body.chats-active:not(.user-bg-active) .galvan-chat-background-blur { 
       
    
        filter: blur(calc(var(--current-background-main-blur-amount-actual) * var(--galvan-blur-intensity-multiplier))) ;
    }
    body:not(.light-mode).chats-active:not(.user-bg-active) .galvan-chat-background-blur {
         opacity: 0.55; 
       
         filter: blur(calc(var(--current-background-main-blur-amount-actual) * var(--galvan-blur-intensity-multiplier))) ; 
    }

    .galvan-user-image-background-blur { 
        background-size: cover;
        background-position: center center;
        background-repeat: no-repeat;
       
        filter: blur(calc(var(--current-background-main-blur-amount-actual) * var(--galvan-blur-intensity-multiplier) * 1.2)) ;
        opacity: 0;
    }
    body.user-bg-active .galvan-chat-background-blur { opacity: 0 !important; transition-delay: 0s !important; } 
    body.user-bg-active .galvan-user-image-background-blur { opacity: 0.7; } 
    body:not(.light-mode).user-bg-active .galvan-user-image-background-blur { 
        opacity: 0.6; 
        backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
        filter: blur(calc(var(--current-background-main-blur-amount-actual) * var(--galvan-blur-intensity-multiplier) * 1.5)) ; 
    }
    
    @keyframes fadeInBackground { from { opacity: 0; transform: scale(1.3) rotate(0deg); } to { opacity: 0.65; transform: scale(1) rotate(0deg); } }
    @keyframes rotateBackground { 
        0% { transform: scale(1.1) rotate(0deg) translateX(-5%) translateY(5%); }
        50% { transform: scale(1.2) rotate(180deg) translateX(5%) translateY(-5%); }
        100% { transform: scale(1.1) rotate(360deg) translateX(-5%) translateY(5%); }
    }

    .galvan-wave-background-container {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        overflow: hidden;
        z-index: 0;
        pointer-events: none;
    }

    .galvan-wave {
        background: var(--current-wave-color); 
        border-radius: 1000% 1000% 0 0;
        position: absolute; 
        width: 200%;
        height: 12em;
        animation: waveAnimation 10s -3s linear infinite;
        transform: translate3d(0, 0, 0);
        opacity: 0.8;
        bottom: 0;
        left: 0;
        transition: background 0.5s var(--ease-smoother);
    }

    .galvan-wave:nth-of-type(2) {
        bottom: -1.25em;
        animation: waveAnimation 18s linear reverse infinite;
        opacity: 0.8;
    }

    .galvan-wave:nth-of-type(3) {
        bottom: -2.5em;
        animation: waveAnimation 20s -1s reverse infinite;
        opacity: 0.9;
    }

    @keyframes waveAnimation {
        0% { transform: translateX(0); }
        25% { transform: translateX(-25%); }
        50% { transform: translateX(-50%); }
        75% { transform: translateX(-25%); }
        100% { transform: translateX(0); }
    }

    .galvan-container {
        width: 80%; 
        max-width: 90%; 
        height: 100%;
        background: none; /* Set background to match the page body */
        display: flex; 
        flex-direction: column; 
        overflow: hidden;
        position: relative;
        z-index: 1;
        transition: background-color 0.5s var(--ease-smoother); /* Removed transitions for radius */
        padding-top: var(--safe-top);
        box-shadow: none; /* Removed the shadow */
        border-radius: 0; /* Removed the rounded corners */
    }
    .galvan-container.locked {
        pointer-events: none;
    }
    /* This rule is now redundant but we keep the block for structure */
    @media (max-width: 410px) { 
        .galvan-container { border-radius: 0; }
    }

    /* FIX: When the command bar expands, prevent the main content from shrinking/blurring */
    body.command-bar-expanded .galvan-main-content {
        transform: none !important;
        filter: none !important;
        border-radius: 0 !important;
    }

    /* FIX: Ensure the container doesn't get rounded corners on mobile when the command bar is expanded */
    body.command-bar-expanded .galvan-container {
        border-radius: 0 !important;
    }

    .galvan-header-bar { height: var(--header-height); position: absolute; top: var(--safe-top); left:0; right: 0; z-index: 10; pointer-events: none; }
    
    .galvan-user-greeting {
        position: absolute;
        top: 25%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: clamp(2rem, 8vw, 2.6rem);
        font-weight: 700;
        text-align: center;
        background: var(--current-greeting-grad);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
        opacity: 1;
        transition: opacity 0.8s var(--ease-out-quint);
        z-index: 4;
        white-space: nowrap;
        pointer-events: none;
        will-change: opacity;
    }
    .galvan-welcome-screen.has-user-name .galvan-user-greeting {
        opacity: 1;
    }

    .galvan-vv-structure-container {
        width: 100px; height: 100px;
        position: fixed;
        top: var(--galvan-logo-center-top); 
        left: 50%;
        transform: translate(-50%, -80%) scale(1) translateY(0);
        z-index: 55; /* High z-index to be above command bar */
        justify-content: center; align-items: center; flex-shrink: 0; display: flex; opacity: 1;
        transition:
            opacity 0.8s var(--ease-smoother),
            transform var(--logo-transition-speed) var(--ease-in-out-cubic),
            top var(--logo-transition-speed) var(--ease-in-out-cubic),
            left var(--logo-transition-speed) var(--ease-in-out-cubic),
            right var(--logo-transition-speed) var(--ease-in-out-cubic),
            bottom var(--logo-transition-speed) var(--ease-in-out-cubic),
            width var(--logo-transition-speed) var(--ease-in-out-cubic),
            height var(--logo-transition-speed) var(--ease-in-out-cubic),
            filter var(--logo-transition-speed) var(--ease-in-out-cubic);
        will-change: transform, opacity, top, left, right, bottom, width, height, filter;
        cursor: pointer;
        filter: drop-shadow(0 6px 12px color-mix(in srgb, var(--current-shadow-color) 35%, transparent));
        --current-logo-glow-std-deviation: var(--galvan-logo-glow-std-deviation-large);
        pointer-events: auto;
    }
    
    body.suggestions-scrolled .galvan-vv-structure-container { transform: translate(-50%, -50%) scale(0.85) translateY(var(--galvan-logo-scroll-up-translate)); opacity: 0.7; }

    /* --- PASTE this new block in its place --- */

body.chats-active .galvan-vv-structure-container {
    width: var(--galvan-logo-final-size); 
    height: var(--galvan-logo-final-size);
    top: calc(var(--safe-top) + (var(--header-height) - var(--galvan-logo-final-size)) / 2);
    left: 16px;
    right: auto; /* Explicitly unset right */
    bottom: auto; /* Explicitly unset bottom */
    transform: translate(0, 0) scale(1); 
    opacity: 1;
    filter: drop-shadow(0 3px 6px color-mix(in srgb, var(--current-shadow-color) 25%, transparent));
    --current-logo-glow-std-deviation: var(--galvan-logo-glow-std-deviation-small);
    cursor: pointer;
}
    /* [NEW] UI 30 - Logo animates to top-left when command bar is expanded */
    body.command-bar-expanded .galvan-vv-structure-container {
        width: 40px; 
        height: 40px;
        top: calc(var(--safe-top) + 12px);
        left: 16px;
        right: auto;
        bottom: auto;
        transform: translate(0, 0) scale(1);
        filter: drop-shadow(0 3px 6px color-mix(in srgb, var(--current-shadow-color) 25%, transparent));
        --current-logo-glow-std-deviation: var(--galvan-logo-glow-std-deviation-small);
        cursor: pointer;
    }

    .galvan-vv-structure-container.vv-image-staged { animation: vvImageSelectPulse 0.8s var(--ease-spring) forwards; }
    @keyframes vvImageSelectPulse {
        0% { transform: translate(-50%, -80%) scale(1); }
        30% { transform: translate(-50%, -80%) scale(1.25); }
        60% { transform: translate(-50%, -80%) scale(0.9); }
        100% { transform: translate(-50%, -80%) scale(1); }
    }
    body.chats-active .galvan-vv-structure-container.vv-image-staged,
    body.command-bar-expanded .galvan-vv-structure-container.vv-image-staged {
         animation: vvImageSelectPulseSmall 0.8s var(--ease-spring-gentle) forwards;
    }
    @keyframes vvImageSelectPulseSmall {
        0% { transform: scale(1); } 30% { transform: scale(1.2); } 60% { transform: scale(0.95); } 100% { transform: scale(1); }
    }

    .galvan-vv-structure-svg { width: 100%; height: 100%; overflow: visible; position: relative; }
   
    .galvan-vv-structure-svg #vvBorder {
        stroke-width: var(--galvan-vv-border-stroke-width-large);
        transition: stroke-width var(--logo-transition-speed) var(--ease-in-out-cubic), stroke 0.5s var(--ease-smoother);
        stroke: url(#vvBorderGradient);
        animation: 
            vvBorderHueRotate 10s linear infinite,
            vvBorderPulse 3s var(--ease-in-out-cubic) infinite alternate;
    }
    @keyframes vvBorderHueRotate {
        from { filter: url(#vvGlowEffect) hue-rotate(0deg); }
        to   { filter: url(#vvGlowEffect) hue-rotate(360deg); }
    }
    body.user-bg-active .galvan-vv-structure-svg #vvBorder,
    .galvan-vv-structure-container.vv-image-staged .galvan-vv-structure-svg #vvBorder {
         animation: 
            vvBorderHueRotate 10s linear infinite,
            vvBorderPulse 3s var(--ease-in-out-cubic) infinite alternate;
    }
    @keyframes vvBorderPulse {
        0% { stroke-opacity: 0.85; }
        50% { stroke-opacity: 1; }
        100% { stroke-opacity: 0.85; }
    }
    body.chats-active .galvan-vv-structure-svg #vvBorder,
    body.command-bar-expanded .galvan-vv-structure-svg #vvBorder {
        stroke-width: var(--galvan-vv-border-stroke-width-small);
    }
    
    .galvan-vv-control-btn {
        position: absolute; z-index: 10;
        background-color: color-mix(in srgb, var(--current-bg-tertiary) 80%, transparent);
        color: var(--current-icon-primary); border: 1px solid var(--current-border-color);
        border-radius: 50%; width: 36px; height: 36px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; padding: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background-color 0.2s, color 0.2s, transform 0.2s var(--ease-spring), opacity 0.3s, visibility 0.3s;
        opacity: 0; visibility: hidden; transform: scale(0.8); pointer-events: none;
    }
    .galvan-vv-control-btn.visible { opacity: 1; visibility: visible; transform: scale(1); pointer-events: auto; }
    .galvan-vv-control-btn:hover { background-color: var(--current-icon-active); color: var(--current-bg-primary); }
    .galvan-vv-control-btn svg { width: 100%; height: 100%; }
    #vvSaveBtn { top: -5px; right: -5px; }
    #vvRemoveBtn { bottom: -5px; right: -5px; background-color: color-mix(in srgb, var(--current-error-text) 80%, black 20%); color: white; }
    #vvRemoveBtn:hover { background-color: var(--current-error-text); }
    body.chats-active .galvan-vv-control-btn, body.command-bar-expanded .galvan-vv-control-btn {
        width: 24px; height: 24px; padding: 4px; top: -3px; right: -3px; 
    }
    body.chats-active #vvRemoveBtn, body.command-bar-expanded #vvRemoveBtn { bottom: -3px; }
    
    .galvan-main-content {
        flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; z-index: 2;
        transition: transform 0.6s var(--ease-out-quint), filter 0.6s var(--ease-out-quint), border-radius 0.6s var(--ease-out-quint);
        will-change: transform, filter;
    }

    body.command-bar-expanded .galvan-main-content {
        transform: scale(0.92) translateY(-14px);
        filter: blur(5px) brightness(0.9);
        border-radius:20px;
        overflow: hidden;
        pointer-events: none;
        user-select: none;
    }
    body.command-bar-expanded .galvan-container {
        border-radius: 22px; /* Force radius even on small screens */
    }

    
    .galvan-suggestions-wrapper { position: absolute; bottom: 0; left: 0; right: 0; top: var(--galvan-suggestions-top-offset); z-index: 4; display: flex; flex-direction: column; overflow: hidden; opacity: 1; visibility: visible; pointer-events: auto; will-change: opacity, top, transform, visibility;  }
    .galvan-welcome-screen.has-user-name .galvan-suggestions-wrapper {
        top: calc(var(--galvan-suggestions-top-offset) + 40px);
    }
    body.chats-active .galvan-suggestions-wrapper, body.hide-suggestions .galvan-suggestions-wrapper, body.adding-suggestion-chip .galvan-suggestions-wrapper { opacity: 0; visibility: hidden; pointer-events: none;  }

   .galvan-suggestions {
        width: 100%; max-width: 300px; margin: 0 auto; flex-grow: 1; overflow-y: auto;
        padding: 30px 12px calc(15px + var(--safe-bottom)) 12px;
           /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
      
            border: 1px solid rgba(255, 255, 255, 0.2);
           
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter:blur(15px);
            
        border-top-left-radius:45px; 
        border-top-right-radius: 45px;
        mask-image: linear-gradient(to bottom, black calc(100% - 70px), transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black calc(100% - 70px), transparent 100%);
        scrollbar-width: none;
       
       
    }
   
   
    .galvan-suggestions-item {
        margin-bottom: 16px;
        position: relative;
        background-color: transparent;
        border-radius: var(--galvan-suggestions-item-border-radius);
        user-select: none;
        overflow: hidden; /* Important for revealing the background */
    }

    .galvan-suggestion-actions-background {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }
   
    .galvan-suggestion-item-inner {
     display: flex
;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    background: var(--current-suggestion-grad-active);
    /* border: 2px solid rgba(255, 255, 255, 0.2); */
    backdrop-filter: blur(15px) url(#liquid-refraction);
    -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    border-radius: 100px;
    padding: 18px 12px 18px 22px;
    cursor: pointer;
    position: relative;
    will-change: transform;
    touch-action: pan-y;
    opacity: 0;
    
    }
    .galvan-suggestions-item.deleting {
       
    }
    
    @keyframes suggestionItemEnter { to { opacity: 1; transform: translateY(0); } }

    .galvan-suggestion-item-inner:active {
        background: var(--current-suggestion-grad-active);

        
    }
    
    .galvan-suggestion-content {
        display: flex;
        align-items: center;
        flex-grow: 1;
        text-align: left;
        pointer-events: none; /* Let parent handle clicks/drags */
    }
    .galvan-suggestion-content .icon { margin-right: 18px; width: 26px; height: 26px; color: var(--current-icon-primary); flex-shrink: 0; transition: color 0.4s var(--ease-smoother); display: flex; align-items: center; justify-content: center; }
    .galvan-suggestion-content .icon svg { width: 100%; height: 100%; } 
    .galvan-suggestion-content .text { flex-grow: 1; line-height: 1.4; font-size: 1.0rem; font-weight: 500; color: var(--current-text-primary); }
    
    

    .galvan-chats-container { flex-grow: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: calc(var(--safe-top) + var(--header-height) + 15px) 18px calc(20px + var(--safe-bottom) + var(--galvan-command-bar-margin-bottom) + var(--galvan-command-bar-height-normal)) 18px; display: flex; flex-direction: column; gap: 20px; opacity: 0; transition: opacity 0.8s var(--ease-spring) 0.1s, transform 0.8s var(--ease-spring) 0.1s, padding-bottom 0.4s var(--ease-smoother); position: relative; z-index: 2; visibility: hidden; transform: translateY(25px) scale(0.97); will-change: scroll-position, opacity, transform, visibility, padding-bottom; }
    

/* ... other styles ... */

body.command-bar-expanded .galvan-prompt-form {
  padding-bottom: 50px;
}
    body.chats-active .galvan-chats-container { opacity: 1; visibility: visible; transform: translateY(0) scale(1); }
    
    .galvan-message {
        display: flex; max-width: 92%; align-items: flex-end; gap: 8px;
        line-height: 1.5; animation: messageSlideIn 0.8s var(--ease-soft-spring); animation-fill-mode: backwards;
        align-self: center; width: fit-content; will-change: transform, opacity;
        user-select: none; -webkit-user-select: none;
        position: relative;
    }
    @keyframes messageSlideIn { from { opacity: 0; transform: translateY(40px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
    
    .galvan-message.message-fading-out {
        animation: messageFadeOut var(--message-fade-out-duration) var(--ease-out-quint) forwards;
        pointer-events: none;
    }
    @keyframes messageFadeOut {
        from { opacity: 1; transform: scale(1) translateY(0); max-height: 200px; }
        to { opacity: 0; transform: scale(0.9) translateY(-15px); max-height: 0px; padding-top: 0; padding-bottom: 0; margin-bottom: -10px; overflow: hidden;}
    }

    /* [NEW] UI 30 - More dynamic regeneration animation */
    .galvan-message.message-regenerating-out {
        animation: messageRegenerateOut var(--message-regen-out-duration) var(--ease-in-out-cubic) forwards;
        pointer-events: none;
    }
    @keyframes messageRegenerateOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.5) rotate(15deg); max-height: 0px; padding: 0; margin-bottom: -10px; overflow: hidden; }
    }


    .galvan-message-content { display: flex; flex-direction: column; width: 100%; }
    .galvan-message-bubble {
        padding: 14px 18px; border-radius: 22px; word-wrap: break-word;
    }
    .user-message .galvan-message-bubble {
     color:var(--current-icon-primary);
     
          
        cursor: grab;
        border-radius:30px;
    }
    .user-message .galvan-message-bubble:active { cursor: grabbing;border-radius: 30px;}

    .bot-message .galvan-message-bubble {
    
            /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
      
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    border-radius:30px; color: var(--current-icon-primary);
   
    /* Add border-radius to the existing transition property */
    transition: background 0.5s var(--ease-smoother), color 0.5s var(--ease-smoother), 
                border-color 0.5s var(--ease-smoother), box-shadow 0.5s var(--ease-smoother), 
                border-width 0.3s var(--ease-smoother), 
                border-radius 1.2s var(--ease-in-out-cubic); /* <- Added this line */
}

.bot-message.loading .galvan-message-bubble {
    /* Set the initial, less-rounded state while loading */
    border-radius: 22px;
}
    body:not(.light-mode) .bot-message .galvan-message-bubble {
         border-color: color-mix(in srgb, var(--current-border-color) 40%, transparent);
    }


    .galvan-message-text { white-space: pre-wrap; font-size: 1.05rem; }
    .galvan-message-text .elastic-span {
        display: inline-block; opacity: 0;
        animation: elastic-appear-message 0.6s var(--ease-spring) forwards;
    }
    @keyframes elastic-appear-message {
        0% { opacity: 0; transform: translateY(8px) scale(0.8); }
        60% { opacity: 1; transform: translateY(-2px) scale(1.05); }
        80% { transform: translateY(1px) scale(0.98); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .galvan-message-text pre {
        background-color: color-mix(in srgb, var(--current-text-primary) 5%, var(--current-bg-tertiary) 95%);
        color: var(--current-text-primary);
        padding: 12px 16px;
        border-radius: 10px;
        margin: 10px 0;
        overflow-x: auto;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        font-size: 0.9em;
        line-height: 1.6;
        border: 1px solid color-mix(in srgb, var(--current-border-color) 70%, transparent);
        box-shadow: inset 0 1px 3px color-mix(in srgb, var(--current-shadow-color) 10%, transparent);
    }
    .galvan-message-text pre code { 
        white-space: pre; 
        font-family: inherit;
        background: none;
        padding: 0;
        border-radius: 0;
        box-shadow: none;
        border: none;
    }
    .galvan-message-text > code, .galvan-message-text em > code, .galvan-message-text strong > code, .galvan-message-text li > code { 
        background-color: color-mix(in srgb, var(--current-text-primary) 8%, transparent);
        color: var(--current-text-primary);
        padding: 0.15em 0.4em;
        border-radius: 4px;
        font-size: 0.9em;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    }
    .galvan-message-text strong, .galvan-message-text em { font-style: normal; font-weight: normal; } /* Reset for elastic spans */
    .galvan-message-text strong .elastic-span { font-weight: bold; }
    .galvan-message-text em .elastic-span { font-family: monospace; }
    .galvan-message-text code .elastic-span { 
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    }
    .galvan-message-text h1, .galvan-message-text h2, .galvan-message-text h3, .galvan-message-text h4, .galvan-message-text h5, .galvan-message-text h6 {
        margin-top: 0.8em; margin-bottom: 0.4em; line-height: 1.2;
    }
    .galvan-message-text h1 { font-size: 1.8em; } .galvan-message-text h2 { font-size: 1.5em; } .galvan-message-text h3 { font-size: 1.3em; }
    .galvan-message-text h4 { font-size: 1.15em; } .galvan-message-text h5 { font-size: 1.05em; } .galvan-message-text h6 { font-size: 1em; }
    .galvan-message-text ul, .galvan-message-text ol { margin: 0.5em 0 0.8em 1.5em; padding-left: 1em; }
    .galvan-message-text li { margin-bottom: 0.3em; }
    .galvan-message-text blockquote {
        border-left: 4px solid var(--current-border-color);
        padding-left: 1em; margin: 0.8em 0;
        color: var(--current-text-secondary); font-family: monospace;
    }
    .galvan-message-text hr { border: none; border-top: 1px solid var(--current-border-color); margin: 1em 0; }


    .galvan-message a { color: var(--current-link-color); text-decoration: underline; font-weight: 500; text-decoration-thickness: 1.5px; text-underline-offset: 3px; }
    .galvan-img-attachment { max-width: 100%; border-radius: 16px; margin-top: 12px; display: block; box-shadow: 0 3px 8px color-mix(in srgb, var(--current-shadow-color) 70%, black); }
    .galvan-file-attachment {
      display: flex
;
    align-items: center;
    gap: 12px;
    background: rgba(225, 225, 225, 0.05);
    padding: 12px 16px;
    /* border-radius: 16px; */
    margin-top: 12px;
    font-size: 0.92em;
    border-radius: 100px;
    overflow: hidden;
    color: var(--current-text-secondary);
    }
    .galvan-file-attachment .file-icon-svg { width: 24px; height: 24px; fill: currentColor; }
    .galvan-file-attachment p { margin: 0; line-height: 1.3; }

    .galvan-thinking-dots-pulse {
        display: none; 
        align-items: center;
        gap: 4px;
        margin-right: 8px;
        vertical-align: middle; 
    }
    .galvan-thinking-dots-pulse span {
        width: 7px;
        height: 7px;
        background-color: var(--current-thinking-text);
        border-radius: 50%;
        animation: thinkingPulseAnimation 1.4s infinite ease-in-out;
    }
    .galvan-thinking-dots-pulse span:nth-child(1) { animation-delay: 0s; }
    .galvan-thinking-dots-pulse span:nth-child(2) { animation-delay: 0.2s; }
    .galvan-thinking-dots-pulse span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes thinkingPulseAnimation {
        0%, 100% { opacity: 0.3; transform: scale(0.7); }
        50% { opacity: 1; transform: scale(1); }
    }


    .bot-message.loading .galvan-message-text {
        display: flex; align-items: center; gap: 0px; 
        font-style: italic; color: var(--current-thinking-text); min-height: 26px;border-radius:40px;
    }
    body.hide-ai-thoughts .bot-message.loading .galvan-thinking-dots-pulse { display: none !important; }
    body.hide-ai-thoughts .bot-message.loading .galvan-message-text { gap: 8px; }
    body.hide-ai-thoughts .bot-message.loading .galvan-thinking-stage-text { display: none !important; }
    body.hide-ai-thoughts .bot-message.loading .galvan-message-text::before { content: "Thinking..."; font-family: monospace; }


    .galvan-thinking-stage-text { font-size: 0.98em; display: inline-block; vertical-align: middle; }
    .galvan-thinking-stage-text .elastic-span {
        display: inline-block; opacity: 0;
        animation: elastic-appear-thinking 0.5s var(--ease-spring-gentle) forwards;
        margin-right: 0.1em;
    }
    @keyframes elastic-appear-thinking {
        0% { opacity: 0; transform: translateY(5px) scale(0.9); }
        70% { opacity: 1; transform: translateY(-2px) scale(1.03); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    .galvan-ai-response-actions {
        display: flex; gap: 8px; margin-top: 14px; padding-top: 12px;
        border-top: 1px solid var(--current-border-color);
        transition: border-top-color 0.5s var(--ease-smoother);
        animation: fadeInActions 0.8s var(--ease-soft-spring) 0.5s both; will-change: opacity, transform;
    }
    @keyframes fadeInActions { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .galvan-response-action-button {
        background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.289);
             /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(2px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(2px) url(#liquid-refraction); padding: 8px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        color: var(--current-icon-primary); cursor: pointer;
        transition: background 0.25s var(--ease-out-quint), transform 0.25s var(--ease-spring), color 0.25s var(--ease-out-quint);
        will-change: transform, background, color;
    }
    .galvan-response-action-button:hover {  transform: scale(1.2); }
    .galvan-response-action-button svg { width: 20px; height: 20px; } 
    .galvan-response-action-button:active { transform: scale(0.85); background: var(--current-action-active-bg); }
    .galvan-response-action-button.liked, .galvan-response-action-button.disliked { transition: background 0.25s var(--ease-out-quint), transform 0.3s var(--ease-spring), color 0.25s var(--ease-out-quint); }
    .galvan-response-action-button.liked { color: var(--current-like-color); }
    .galvan-response-action-button.disliked { color: var(--current-dislike-color); }
    .galvan-response-action-button.liked svg, .galvan-response-action-button.disliked svg { fill: currentColor; stroke: none; } 
    .galvan-response-action-button.liked:active { background: color-mix(in srgb, var(--current-like-color) 18%, transparent); }
    .galvan-response-action-button.disliked:active { background: color-mix(in srgb, var(--current-dislike-color) 18%, transparent); }
    .galvan-response-action-button .icon-copy-check { font-size: 20px; transition: color 0.25s var(--ease-out-quint); display: flex; align-items: center; justify-content: center;}
    .galvan-response-action-button .icon-copy-check svg { fill: currentColor !important; stroke: none !important; } 

    .galvan-prompt-form {
        padding: 8px 12px calc(8px + var(--safe-bottom) + var(--galvan-command-bar-margin-bottom) + var(--galvan-command-bar-height-normal)) 12px; /* MODIFIED: Gap reduction */
        background-color: transparent; border-top: none; flex-shrink: 0; z-index: 5; position: relative;
        transition: background-color 0.5s var(--ease-smoother), padding-bottom 0.4s var(--ease-smoother), transform 0.4s var(--ease-out-quint);
    }
    body.command-bar-expanded .galvan-prompt-form {
      padding-bottom: 510px;  }

    .galvan-file-upload-wrapper {
        display:none; align-items: center; justify-content: space-between; padding: 8px 14px;
        background-color: var(--current-bg-tertiary); border-radius: 58px; margin-bottom: 2px;
        margin:0 auto;
        transition: background-color 0.5s var(--ease-smoother), box-shadow 0.4s var(--ease-smoother);
        will-change: opacity, transform, box-shadow, background-position;
    
        box-shadow: 0 3px 6px -1px var(--current-shadow-color); position: relative; overflow: hidden;

        max-width:300px;
    }
    .galvan-file-upload-wrapper.active {
        display: flex;align-items:center;justify-content:center;   background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
             /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

           
        animation: filePreviewEnter 0.6s var(--ease-soft-spring), moveInternalGradient var(--internal-gradient-anim-speed) linear infinite;
    }
    @keyframes moveInternalGradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @keyframes filePreviewEnter { from { opacity: 0; transform: translateY(-15px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }

    .galvan-file-preview-container { display: flex; align-items: center; gap: 12px;max-width:300px; overflow: hidden; position: relative; z-index: 1; }
    .file-preview-icon-svg { width: 22px; height: 22px; fill: var(--current-icon-primary); flex-shrink: 0; }
    .galvan-file-preview-container img.file-preview { width: 28px; height: 28px; border-radius: 26px; object-fit: cover; flex-shrink: 0; }
    .galvan-file-name { font-size: 0.9em; color: var(--current-text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 0.5s var(--ease-smoother); }
    #cancel-file-btn { background: none; border: none; color: var(--current-icon-primary); cursor: pointer; padding: 4px; line-height: 1; display: flex; align-items: center; justify-content: center; position: relative; z-index: 1; transition: color 0.5s var(--ease-smoother), transform 0.25s var(--ease-spring-gentle); }
    #cancel-file-btn svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2.4; }
    #cancel-file-btn:hover { transform: scale(1.2); }
    #cancel-file-btn:active { transform: scale(0.9); }
    
/* --- START: Prompt Navigation Buttons CSS --- */
.galvan-prompt-nav-buttons {
    display: flex;
    justify-content: center;
    gap: 80px; /* Space between buttons */
    margin-bottom: 12px;
    height: 28px;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s var(--ease-out-quint), transform 0.4s var(--ease-out-quint), height 0.4s var(--ease-out-quint), margin-bottom 0.4s var(--ease-out-quint);
    pointer-events: none;
}
.galvan-prompt-nav-buttons.visible {
    opacity: 1;
    transform: translateY(0);
    pointer-events: auto;
}
.galvan-prompt-nav-btn {
    width: 38px; height: 38px;
    margin-bottom:20px;
      background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
             /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
    border-radius: 50%;
    color: var(--current-icon-primary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px -2px var(--current-shadow-color);
    transition: transform 0.2s var(--ease-spring), background-color 0.2s, color 0.2s;
}
.galvan-prompt-nav-btn:hover:not(:disabled) {
    transform: scale(1.15);
   
}
.galvan-prompt-nav-btn:active:not(:disabled) {
    transform: scale(0.9);
}
.galvan-prompt-nav-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    
}
.galvan-prompt-nav-btn svg {
    width: 18px;
    height: 18px;
}
/* --- END: Prompt Navigation Buttons CSS --- */


    
    

    
    #theme-toggle-btn .icon-sun, #theme-toggle-btn-cloned .icon-sun { opacity: 1; transform: scale(1) rotate(0deg); }
    #theme-toggle-btn .icon-moon, #theme-toggle-btn-cloned .icon-moon { opacity: 0; transform: scale(0.5) rotate(-100deg); }
    body:not(.light-mode) #theme-toggle-btn .icon-sun, body:not(.light-mode) #theme-toggle-btn-cloned .icon-sun { opacity: 0; transform: scale(0.5) rotate(100deg); }
    body:not(.light-mode) #theme-toggle-btn .icon-moon, body:not(.light-mode) #theme-toggle-btn-cloned .icon-moon { opacity: 1; transform: scale(1) rotate(0deg); }

    #command-bar-settings-btn .icon-gear, #command-bar-settings-btn-cloned .icon-gear { opacity: 1; transform: rotate(0deg); transition: opacity 0.35s, transform 0.5s var(--ease-in-out-cubic); }
    #command-bar-settings-btn .icon-close, #command-bar-settings-btn-cloned .icon-close { opacity: 0; transform: rotate(-90deg) scale(0.7); position: absolute; transition: opacity 0.35s, transform 0.5s var(--ease-in-out-cubic); }
    .galvan-command-bar-container.settings-view-active #command-bar-settings-btn .icon-gear,
    .galvan-command-bar-container.settings-view-active #command-bar-settings-btn-cloned .icon-gear { opacity: 0; transform: rotate(90deg) scale(0.7); }
    .galvan-command-bar-container.settings-view-active #command-bar-settings-btn .icon-close,
    .galvan-command-bar-container.settings-view-active #command-bar-settings-btn-cloned .icon-close { opacity: 1; transform: rotate(0deg) scale(1); }

    .galvan-command-bar-expanded-top-nav .galvan-nav-btn.active { color: var(--current-icon-active); }
    .galvan-command-bar-expanded-top-nav .galvan-nav-btn.active svg { transform: scale(1.12); filter: drop-shadow(0 1px 2px color-mix(in srgb, var(--current-icon-active) 20%, transparent)); }
    body:not(.light-mode) .galvan-command-bar-expanded-top-nav .galvan-nav-btn.active { color: var(--current-icon-primary); } 
    body:not(.light-mode) .galvan-command-bar-expanded-top-nav .galvan-nav-btn.active svg { transform: scale(1.08); filter: none; }

    .galvan-command-bar-expanded-content-wrapper {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        opacity: 0; visibility: hidden;
        transform: translateY(20px) scale(0.97); 
        transition: opacity 0.4s var(--ease-out-quint), visibility 0s linear 0.4s, transform 0.4s var(--ease-out-quint); 
        display: flex; flex-direction: column; z-index: 1;
    }
    .galvan-command-bar-container.expanded .galvan-command-bar-expanded-content-wrapper {
        opacity: 1; visibility: visible;
        transform: translateY(0) scale(1);
        transition-delay: 0.15s; z-index: 3;
    }

    .galvan-command-bar-expanded-top-nav {
        display: flex; justify-content: space-around; align-items: stretch; 
        padding: 4px 8px; height: var(--galvan-command-bar-expanded-top-nav-height);
        flex-shrink: 0; background-color: transparent; 
        border-bottom: 1px solid color-mix(in srgb, var(--current-border-color) 30%, transparent);
        border-top-left-radius: calc(var(--galvan-command-bar-border-radius) - 1.5px);
        border-top-right-radius: calc(var(--galvan-command-bar-border-radius) - 1.5px);
        transition: background-color 0.5s var(--ease-smoother), border-color 0.5s var(--ease-smoother);
    }
    .galvan-command-bar-expanded-top-nav .galvan-nav-btn {
        min-height: 48px; opacity: 0; 
        transform: translateY(10px) scale(0.9); 
    }
    .galvan-command-bar-expanded-top-nav .galvan-nav-btn .icon-wrapper { width: 24px; height: 24px; }
    @keyframes topNavIconEnter { to { opacity: 1; transform: translateY(0) scale(1); } }
    
    .galvan-command-bar-content-view > * {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
        animation: panelContentItemEnter 0.6s var(--ease-soft-spring) forwards;
    }
    @keyframes panelContentItemEnter {
        to { opacity: 1; transform: translateY(0) scale(1); }
    }


    .galvan-command-bar-settings-list { gap: 0; padding-right: 15px; }
    .galvan-command-bar-setting-item {
        display: flex; align-items: center; justify-content: space-between;
        padding: 14px 0; 
        border-bottom: 1px solid var(--current-border-color);
        color: var(--current-text-secondary);
    }
    .galvan-command-bar-setting-item:last-child { border-bottom: none; }
    .galvan-command-bar-setting-item > .setting-label { font-size: 0.95rem; flex-grow: 1; margin-right: 12px; } 
    
    .galvan-setting-action-button {
        background: var(--current-bg-tertiary); color: var(--current-icon-primary);
       border:none; padding: 6px 12px; 
        border-radius: 512px; font-size: 0.85rem; font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s, transform 0.2s var(--ease-spring-gentle);
    }
    .galvan-setting-action-button:hover {
        background-color: var(--current-icon-active); color: var(--current-bg-primary);
        border-color: var(--current-icon-active); transform: scale(1.05);
    }
    .galvan-setting-action-button:active { transform: scale(0.95); }
    .galvan-setting-action-button:disabled {
        background: color-mix(in srgb, var(--current-bg-tertiary) 50%, var(--current-border-color));
        color: var(--current-text-placeholder);
        border-color: var(--current-border-color);
        cursor: not-allowed; transform: none;
    }


    .galvan-slider-container { display: flex; align-items: center; gap: 10px; }
    .galvan-slider-container input[type="range"] {
        -webkit-appearance: none; appearance: none; 
        width: 120px; height: 25px; /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.2);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);


 
        border-radius: 115px; outline: none; opacity: 0.9; 
        transition: opacity .2s, background-color 0.3s var(--ease-smoother); cursor: pointer;
    }
    .galvan-slider-container input[type="range"]:hover { opacity: 1; }
    .galvan-slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; 
        width: 22px; height: 22px; background: var(--current-icon-primary); 
        border-radius: 50%; cursor: pointer;
        border: 3px solid var(--current-bg-tertiary);
        box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        transition: background-color 0.3s var(--ease-smoother), border-color 0.3s var(--ease-smoother);
    }
    .galvan-slider-container input[type="range"]::-moz-range-thumb {
        width: 18px; height: 18px; background: var(--current-icon-primary);
        border-radius: 50%; cursor: pointer; border: 3px solid var(--current-bg-tertiary);
        box-shadow: 0 1px 4px rgba(0,0,0,0.25);
        transition: background-color 0.3s var(--ease-smoother), border-color 0.3s var(--ease-smoother);
    }
    .galvan-slider-value { font-size: 0.8rem; min-width: 30px; text-align: right; }
    .galvan-blur-control-notice { font-size: 0.8rem; color: var(--current-text-placeholder); text-align: right; flex-grow: 1;}


/* --- END: NEW FLOATING BOTTOM SHEET SELECTOR (REPLACEMENT) --- */
    
    .galvan-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0;}
    .galvan-switch input { opacity: 0; width: 0; height: 0; }
    .galvan-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.282);
          
        
           
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);
; transition: .3s var(--ease-smoother); border-radius: 24px; }
    .galvan-switch .slider:before { 
        position: absolute; content: ""; height: 18px; width: 18px; 
        left: 3px; bottom: 3px; background-color: var(--current-switch-thumb); 
        transition: transform .35s var(--ease-spring-gentle), width 0.3s var(--ease-spring-gentle); border-radius: 50%; 
        
    }
    .galvan-switch .slider .icon-toggle-on, .galvan-switch .slider .icon-toggle-off {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 14px;
        color: white;
        transition: opacity 0.3s;
    }
    .galvan-switch .slider .icon-toggle-on {
        right: 5px; opacity: 0;
        color:white;
    }
    .galvan-switch .slider .icon-toggle-off {
        left: 5px; opacity: 1;
        color: white;
    }
    .galvan-switch input:checked + .slider { background-color: var(--current-switch-bg-active); }
    .galvan-switch input:focus-visible + .slider { box-shadow: 0 0 0 3px color-mix(in srgb, var(--current-switch-bg-active) 30%, transparent); }
    .galvan-switch input:checked + .slider:before { transform: translateX(20px); }
    .galvan-switch input:checked + .slider .icon-toggle-on { opacity: 1; }
    .galvan-switch input:checked + .slider .icon-toggle-off { opacity: 0; }
    .galvan-switch input:active + .slider:before { width: 24px; }
    .galvan-switch input:checked:active + .slider:before { transform: translateX(14px); }


    .galvan-toast-message {
        position: fixed; bottom: calc(var(--safe-bottom) + var(--galvan-command-bar-margin-bottom) + var(--galvan-command-bar-height-normal) + 15px); left: 50%; /* MODIFIED: Gap reduction */
        transform: translate(-50%, 35px) scale(0.9);
        background-color: var(--current-toast-bg); color: var(--current-toast-text);
        padding: 14px 24px; border-radius: 24px; font-size: 0.95rem; z-index: 100;
        opacity: 0; visibility: hidden;
        transition: opacity 0.45s var(--ease-spring), transform 0.45s var(--ease-spring), visibility 0s linear 0.45s, background-color 0.5s var(--ease-smoother), color 0.5s var(--ease-smoother), bottom 0.35s var(--ease-smoother);
        pointer-events: none; 
        backdrop-filter: blur(calc(var(--galvan-ui-backdrop-blur-amount) * var(--galvan-blur-intensity-multiplier) * 0.8)) saturate(160%); 
        -webkit-backdrop-filter: blur(calc(var(--galvan-ui-backdrop-blur-amount) * var(--galvan-blur-intensity-multiplier) * 0.8)) saturate(160%);
        box-shadow: 0 8px 30px -5px var(--current-shadow-strong);
        will-change: opacity, transform, visibility, bottom, backdrop-filter;
    }
    .galvan-toast-message.show { opacity: 1; transform: translate(-50%, 0) scale(1); visibility: visible; transition: opacity 0.45s var(--ease-spring), transform 0.45s var(--ease-spring), visibility 0s linear 0s, bottom 0.35s var(--ease-smoother); }
    body.command-bar-expanded .galvan-toast-message {
        bottom: calc(var(--safe-bottom) + var(--galvan-command-bar-margin-bottom) + var(--galvan-command-bar-height-expanded) + 15px); /* MODIFIED: Gap reduction */
    }
    
    /* --- START: Redesigned History View CSS --- */
    .galvan-history-list-view { 
        gap: 0; /* Let the items and headers control the spacing */
        padding-top: 5px !important; 
        padding-right: 15px;
    }
    
    .galvan-history-options-toolbar {
        display: flex; justify-content: flex-end; padding-bottom: 10px;
        margin-bottom: 5px; flex-shrink: 0;
        border-bottom: 1px solid var(--current-border-color);
    }
    .galvan-history-action-btn { 
        background: var(--current-history-action-btn-bg); color: var(--current-icon-primary);
        border: 1px solid var(--current-border-color); padding: 8px 15px;
        border-radius: 12px; font-size: 0.9rem; font-weight: 500; cursor: pointer;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s, transform 0.2s;
    }
    .galvan-history-action-btn:hover {
        background-color: var(--current-history-action-btn-hover-bg);
        color: var(--current-icon-active); border-color: var(--current-icon-active);
    }
    .galvan-history-action-btn:active { transform: scale(0.95); }
    #history-clear-all-btn { color: var(--current-error-text);
    background: rgb(235 13 13 / 9%);
    border-radius: 150px;
    border: 1px solid red; }
    #history-clear-all-btn:hover { border-color: var(--current-error-text); background-color: color-mix(in srgb, var(--current-error-text) 10%, transparent); }

    .galvan-history-date-header {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--current-text-secondary);
        padding: 18px 0 17px 5px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky;
        top: -3px; /* Stick just below the top padding */
        background: rgba(255, 255, 255, 0.238);
          
        
            border: 1px solid rgba(255, 255, 255, 0.289);
             /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(2px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(2px) url(#liquid-refraction);
text-align:center;           
    border:var(--current-text-secondary);
    margin-bottom:10px;
    margin-top:10px;
        border-radius:30px;
        z-index: 1;
    }

    .galvan-history-date-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .galvan-history-item {
        background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
             /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(5px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(5px) url(#liquid-refraction);

           
       
  
  
        padding: 12px 18px; /* Slightly adjusted padding */
        border-radius: 38px; 
       
        transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s, transform 0.2s;
        display: flex; flex-direction: column; gap: 8px; /* Reduced gap */
        box-shadow: 0 4px 10px -5px var(--current-shadow-color);
        cursor: pointer;
    }
    .galvan-history-item:hover { 
        background-color: var(--current-history-item-hover-bg);
        border-color: color-mix(in srgb, var(--current-icon-primary) 30%, transparent);
        box-shadow: 0 6px 15px -5px var(--current-shadow-strong);
        transform: translateY(-2px);
    }
    .galvan-history-item:active {
        transform: translateY(-2px) scale(0.98);
    }
    .galvan-history-item-header { display: flex; justify-content: space-between; align-items: center; }
    .galvan-history-item-timestamp { font-size: 0.75rem; color: var(--current-text-secondary); }
    
    .galvan-history-item-delete-btn {
        background: none; border: none; color: var(--current-icon-static); cursor: pointer; padding: 4px;
        display: flex; align-items: center; justify-content: center;
        border-radius: 50%;
        transition: color 0.2s, transform 0.2s, background-color 0.2s;
        z-index: 2; /* Ensure it's clickable over the parent */
    }
    .galvan-history-item-delete-btn:hover { 
        color: var(--current-error-text); 
        transform: scale(1.1);
        background-color: color-mix(in srgb, var(--current-error-text) 10%, transparent);
    }
    .galvan-history-item-delete-btn svg { width: 18px; height: 18px; }
    
    .galvan-history-item-query { 
        font-size: 0.95rem; 
        line-height: 1.45;
        font-weight: 500; 
        color: var(--current-text-primary); 
        max-height: 4.35em; /* approx 3 lines */
        overflow: hidden; text-overflow: ellipsis; 
        display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
        pointer-events: none; /* Let parent handle click */
    }
    
    .galvan-history-list-view.empty-history { 
        display: flex; flex-direction: column;
        align-items: center; justify-content: center; text-align: center;
        flex-grow: 1; 
        color: var(--current-text-placeholder); font-family: monospace;
    }
    .galvan-empty-history-message svg {
        width: 60px; height: 60px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    /* --- END: Redesigned History View CSS --- */


    .galvan-notice-list-view { gap: 15px; padding-right: 15px; }
    .galvan-notice-version-group {
      /* Make the panel mostly transparent to let the backdrop show through */
        
 padding: 20px; 
        border-radius: 18px; 
        border:none;
       
    }
    body:not(.light-mode) .galvan-notice-version-group {
        border-color: var(--current-border-color);
    }
    .galvan-notice-version-group h3 {
        font-size: 1.25rem; 
        color: var(--current-text-primary); 
        margin-bottom: 12px; padding-bottom: 10px; 
        border-bottom: 1px dashed var(--current-border-color);
    }
    .galvan-notice-version-group ul { list-style-type: disc; padding-left: 20px; font-size: 0.95rem; color: var(--current-text-secondary); } /* MODIFIED: Notice style */
    .galvan-notice-version-group li { margin-bottom: 10px; line-height: 1.55; padding-left: 8px; } /* MODIFIED: Notice style */
    .galvan-notice-version-group ul ul { margin-top: 8px; margin-bottom: 8px; list-style-type: '›'; }
    .galvan-notice-version-group ul ul li { font-size: 0.9rem; margin-bottom: 5px; }

    .galvan-notice-list-view-header {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--current-text-primary);
        padding-bottom: 15px;
        margin-bottom: 15px;
        border-bottom: 1.5px solid var(--current-border-color);
        text-align: center;
        flex-shrink: 0;
    }
    
    .galvan-color-palette-setting-item { 
        flex-direction: column; 
       /* Make the panel mostly transparent to let the backdrop show through */
           
              border-radius:30px;
             margin-top:10px;
             max-width:260px;
        gap: 2px;
        margin-bottom:10px;
    }
    .galvan-color-palette-container {
        display: grid;
     
        gap: 1px;
        width: 100%;
    }
    .galvan-color-palette-item {
       /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(25px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(25px) url(#liquid-refraction);

        
         border-radius:100px;
        margin-left:10px;
        margin-right:10px;
        margin-top:15px;
        padding: 8px;
        cursor: pointer;
        transition: transform 0.2s var(--ease-spring-gentle), box-shadow 0.2s, border-color 0.2s;
        text-align: center;
        position: relative;
    }
    .galvan-color-palette-item:hover {
        transform: translateY(-3px);
       
        box-shadow: 0 6px 12px -3px var(--current-shadow-strong);
        border-color: var(--current-icon-primary);
    }
    .galvan-color-palette-item.active-palette {
        border-color: var(--current-icon-active);
        
        box-shadow: 0 0 0 3px var(--current-icon-active);
    }
    .galvan-palette-preview-wrapper {
     width: auto;
    padding: 5px 8px;
     border-radius:100px;
    font-size: 0.2rem;
    text-align: left;
    color: #ffffff00;
    margin-left: auto;
    margin-bottom: 2px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .galvan-palette-preview-wrapper .preview-bubble {
       width: 55%;
    padding: 5px 8px;
    border-radius: 128px;
    font-size: 0.8rem;
    text-align: center;
    color: rgb(255, 255, 255);
    margin-left: auto;
    margin-right: 5px;
    margin-bottom: 4px;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .galvan-palette-preview-wrapper .preview-accent-bar {
        height: 19px;
          border-radius:100px;
       
        display: flex;
        overflow: hidden;
    }
    .galvan-palette-preview-wrapper .preview-accent-bar span {
        flex-grow: 1;
    max-width: 60px;
    border-radius: 100px;
    margin-top:5px;
    border-top-right-radius: 10px;
   
    margin-left: 12px;
    }
    .galvan-palette-name {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--current-text-secondary);
    }
    
    #galvan-reset-overlay {
        position: fixed; inset: 0; 
         /* Make the panel mostly transparent to let the backdrop show through */
            backdrop-filter: blur(2px);          
        
        color: var(--current-text-primary); 
        z-index: 9999; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; 
        opacity: 0; 
        transition: opacity 0.4s var(--ease-smoother);
        pointer-events: none;
    }
    #galvan-reset-overlay.show { opacity: 1; pointer-events: auto; }
    #galvan-reset-overlay .reset-content {
         /* Make the panel mostly transparent to let the backdrop show through */
            background: rgba(255, 255, 255, 0.05);
          
        
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            
            /* The core of the effect: blur + SVG filter URL */
            backdrop-filter: blur(2px) url(#liquid-refraction);
            -webkit-backdrop-filter: blur(2px) url(#liquid-refraction); 
        padding: 10px 90px;
        border-radius: 120px;
        box-shadow: 0 10px 30px var(--current-shadow-strong);
        text-align: center;
    }
    #galvan-reset-overlay .spinner {
        width: 60px; height: 60px; 
        border: 3px solid var(--current-border-color);
        border-top-color: var(--current-icon-active);
        border-radius: 50%;
        animation: spin 3s linear infinite;
        margin-bottom: 25px;
    }
    #galvan-reset-overlay .reset-text {
        font-size: 1.0em; 
        font-weight: 200;
        color: var(--current-text-primary);
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* [NEW & ENHANCED] UI 30 - Redesigned App Lock Screen */
    #galvan-pin-lock-overlay {
        position: fixed;
        inset: 0;
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s var(--ease-smoother), visibility 0s 0.5s, background-color 0.5s, backdrop-filter 0.5s;
        background-color: transparent;
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
    }
    #galvan-pin-lock-overlay.visible {
        opacity: 1;
        visibility: visible;
        transition-delay: 0s;
        background-color: color-mix(in srgb, var(--current-bg-primary) 85%, transparent);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
    }
    .galvan-pin-lock-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
        width: 100%;
        max-width: 320px;
    }
    .galvan-pin-lock-container > * {
        opacity: 0;
        transform: translateY(20px);
        animation: pinElementEnter 0.7s var(--ease-out-quint) forwards;
    }
    @keyframes pinElementEnter {
        to { opacity: 1; transform: translateY(0); }
    }
    #lock-screen-avatar-container { animation-delay: 0.1s; }
    .galvan-pin-lock-title { animation-delay: 0.2s; }
    .galvan-pin-lock-subtitle { animation-delay: 0.25s; }
    #pin-input-area { animation-delay: 0.3s; width: 100%; }

    #lock-screen-avatar-container {
        margin-bottom: 30px;
        pointer-events: none;
    }
    #lock-screen-avatar-container .galvan-vv-structure-container {
        position: relative;
        top: 0; left: 0;
        transform: none;
        width: 90px;
        height: 90px;
        animation: lockScreenRotate 30s linear infinite;
    }
    @keyframes lockScreenRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .galvan-pin-lock-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--current-text-primary);
        margin-bottom: 10px;
    }
    .galvan-pin-lock-subtitle {
        font-size: 0.95rem;
        color: var(--current-text-secondary);
        margin-bottom: 25px;
        min-height: 1.2em;
    }
    .galvan-pin-dots-container {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 30px;
    }
    .galvan-pin-dot {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background-color: transparent;
        border: 2px solid var(--current-text-placeholder);
        transition: background-color 0.2s, transform 0.25s var(--ease-spring-gentle), border-color 0.2s;
    }
    .galvan-pin-dot.filled {
        background-color: var(--current-icon-active);
        border-color: var(--current-icon-active);
        transform: scale(1.2);
    }
    .galvan-pin-lock-container.error .galvan-pin-dot.filled {
        background-color: var(--current-error-text);
        border-color: var(--current-error-text);
        animation: pinErrorShake 0.35s;
    }
    @keyframes pinErrorShake {
      10%, 90% { transform: translateX(-1px) scale(1.2); }
      20%, 80% { transform: translateX(2px) scale(1.2); }
      30%, 50%, 70% { transform: translateX(-4px) scale(1.2); }
      40%, 60% { transform: translateX(4px) scale(1.2); }
    }

    .galvan-pin-keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        margin-bottom: 25px;
    }
    .galvan-pin-key {
        width: 75px;
        height: 75px;
        border-radius: 50%;
        border: none;
        background-color: var(--current-pin-bg);
        color: var(--current-text-primary);
        font-size: 2rem;
        font-family: var(--current-font-family);
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.15s;
        backdrop-filter: blur(5px);
    }
    .galvan-pin-key:hover {
        backgroundcolor: color-mix(in srgb, var(--current-icon-static) 15%, transparent);
    }
    .galvan-pin-key:active {
        transform: scale(0.9);
        background-color: color-mix(in srgb, var(--current-icon-static) 25%, transparent);
    }
    .galvan-pin-key.key-backspace {
        font-size: 1.5rem;
    }
    #lock-screen-forgot-btn {
        background: none;
        border: none;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        color: var(--current-lock-forgot-color);
        opacity: 0.8;
        transition: opacity 0.2s;
    }
    #lock-screen-forgot-btn:hover {
        opacity: 1;
    }

</style>
</head>
<body class="light-mode">
    <div class="galvan-wave-background-container">
        <div class="galvan-wave"></div>
        <div class="galvan-wave"></div>
        <div class="galvan-wave"></div>
    </div>
    <div class="galvan-chat-background-blur"></div>
    <div class="galvan-user-image-background-blur"></div>

    <div class="galvan-vv-structure-container">
        <svg class="galvan-vv-structure-svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
            <defs>
                <filter id="vvGlowEffect" x="-50%" y="-50%" width="200%" height="200%">
                    <feDropShadow dx="0" dy="0" stdDeviation="var(--current-logo-glow-std-deviation)" flood-color="var(--current-logo-glow-color)" flood-opacity="var(--galvan-logo-glow-opacity)"/>
                </filter>
                <linearGradient id="vvBorderGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="var(--current-logo-stop-1)" />
                    <stop offset="50%" stop-color="var(--current-logo-stop-2)" />
                    <stop offset="100%" stop-color="var(--current-logo-stop-3)" />
                </linearGradient>
                    <path id="vvShapePath" d="M50,5 A45,45 0 1,1 49.9,5 Z" transform-origin="center"></path>
                    <clipPath id="vvMainClip"><use href="#vvShapePath" fill-rule="evenodd"/></clipPath>
            </defs>
            <g id="vvImageGroup" clip-path="url(#vvMainClip)">
                <rect id="vvBackgroundRect" x="0" y="0" width="100" height="100" fill="var(--current-bg-primary)"/>
                <image id="vvUserImage" href="" x="0" y="0" width="100" height="100" preserveAspectRatio="xMidYMid slice" style="display: none;"/>
            </g>
            <use id="vvBorder" href="#vvShapePath" fill="none" fill-rule="evenodd" />
        </svg>
        <input type="file" id="vvImageInput" hidden accept="image/*">
        <button id="vvSaveBtn" class="galvan-vv-control-btn" aria-label="Save Image">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
        </button>
        <button id="vvRemoveBtn" class="galvan-vv-control-btn" aria-label="Remove Image">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </button>
    </div>

    <div class="galvan-container">
        <div class="galvan-header-bar"></div>
        
        <div class="galvan-main-content">
            <div class="galvan-welcome-screen">
                <h1 class="galvan-user-greeting"></h1>
                <div class="galvan-suggestions-wrapper">
                    <div class="galvan-suggestions">
                        <!-- Suggestion items will be dynamically populated here -->
                    </div>
                 </div>
            </div>
            <div class="galvan-chats-container"></div>
        </div>
        
        <form class="galvan-prompt-form">
            <div class="galvan-file-upload-wrapper">
                 <div class="galvan-file-preview-container">
                     <svg class="file-preview-icon-svg" viewBox="0 0 24 24"></svg>
                     <img src="#" alt="file preview" class="file-preview" />
                     <p class="galvan-file-name">file_name.ext</p>
                 </div>
                 <button type="button" id="cancel-file-btn" aria-label="Cancel file">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                 </button>
            </div>
            <!-- NEW: Prompt History Navigation Buttons -->
            <div class="galvan-prompt-nav-buttons">
                <button type="button" id="prompt-nav-up" class="galvan-prompt-nav-btn" aria-label="Previous Prompt">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                </button>
                <button type="button" id="prompt-nav-down" class="galvan-prompt-nav-btn" aria-label="Next Prompt">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
            </div>
            <!-- New two-layer structure for the Neumorphic effect -->
<div class="galvan-prompt-container">
    <div class="galvan-prompt-wrapper">

        <!-- The Add/Cancel button with two icons for morphing -->
        <button type="button" id="add-file-btn" class="prompt-btn" aria-label="Attach file">
            <span class="icon-add">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </span>
            <span class="icon-cancel-file">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </span>
        </button>

        <textarea class="prompt-input" placeholder="Prompt me" required></textarea>
        <input type="file" id="file-input" hidden accept="image/*,.txt,.pdf,.csv,.doc,.docx,.xls,.xlsx,.rtf,.ppt,.pptx,.key,.pages,.numbers,.zip">

        <!-- The Send/Stop button with two icons for 3D flip -->
        <button type="submit" id="send-btn" class="prompt-btn" aria-label="Send message">
            <span class="icon-send">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </span>
            <span class="icon-stop">
                 <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="1"></rect></svg>
            </span>
        </button>

    </div>
</div>
        </form>

        <div class="galvan-command-bar-container">
            <div class="galvan-command-bar">
                 <button class="galvan-nav-btn active" id="home-btn" aria-label="Home">
                    <span class="icon-wrapper">
                        <svg class="icon-home-filled" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.09954L3 9.99954V21.9995H9V15.9995H15V21.9995H21V9.99954L12 2.09954Z"/></svg>
                        <svg class="icon-home-outline" style="display:none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    </span>
                 </button>
                 <button class="galvan-nav-btn" id="history-btn" aria-label="History">
                    <span class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                    </span>
                 </button>
                 <button class="galvan-nav-btn" id="notice-btn" aria-label="Notices">
                    <span class="icon-wrapper">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                    </span>
                </button>
                <button id="theme-toggle-btn" class="galvan-nav-btn" aria-label="Toggle Theme Mode">
                    <span class="icon-wrapper">
                        <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </span>
                </button>
                <button id="command-bar-settings-btn" class="galvan-nav-btn" aria-label="Open Settings">
                    <span class="icon-wrapper">
                        <svg class="icon-gear" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                        <svg class="icon-close" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </span>
                </button>
                <div id="command-bar-logo-placeholder"></div>
            </div>
            <div class="galvan-command-bar-expanded-content-wrapper">
                <div class="galvan-command-bar-expanded-top-nav">
                    <!-- Cloned nav icons will be populated here by JS -->
                </div>
                <div id="expanded-command-bar-settings-view" class="galvan-command-bar-content-view galvan-command-bar-settings-list" data-view="settings">
                    <div class="galvan-command-bar-setting-item" id="blur-control-setting-item">
                        <span class="setting-label">Adjust Blur</span>
                        <div class="galvan-slider-container">
                            <input type="range" id="setting-blur-slider" min="0" max="2" step="0.1" value="1">
                            <span id="blur-slider-value" class="galvan-slider-value">1.0x</span>
                        </div>
                         <span id="blur-control-notice" class="galvan-blur-control-notice" style="display: none;font-family:monospace;">A Background First</span>
                    </div>
                    <!-- UPDATED: Custom Selects are now just triggers for the bottom sheet -->
                              <!-- UPDATED: Custom Selects are now just triggers for the bottom sheet -->
                    <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Logo design</span>
                        <button class="galvan-custom-select-trigger" data-select-id="vv-shape"></button>
                    </div>
                     <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Font</span>
                        <button class="galvan-custom-select-trigger" data-select-id="font-family"></button>
                    </div>
                    <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Wave Size</span>
                        <button class="galvan-custom-select-trigger" data-select-id="font-size"></button>
                    </div>
                    <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Dark Mode</span>
                        <label class="galvan-switch"><input type="checkbox" id="setting-toggle-dark-mode"><span class="slider"><span class="icon-toggle-off"></span><span class="icon-toggle-on"></span></span></label>
                    </div>
                     <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Auto Light-Dark mode</span>
                        <label class="galvan-switch"><input type="checkbox" id="setting-toggle-system-theme" checked><span class="slider"><span class="icon-toggle-off"></span><span class="icon-toggle-on"></span></span></label>
                    </div>
                    <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Model Thoughts</span>
                        <label class="galvan-switch"><input type="checkbox" id="setting-toggle-ai-thoughts" checked><span class="slider"><span class="icon-toggle-off"></span><span class="icon-toggle-on"></span></span></label>
                    </div>
                    <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Like Suggestions</span>
                        <label class="galvan-switch"><input type="checkbox" id="setting-toggle-suggestions" checked><span class="slider"><span class="icon-toggle-off"></span><span class="icon-toggle-on"></span></span></label>
                    </div>
                     <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Want Attachments</span>
                        <label class="galvan-switch"><input type="checkbox" id="setting-toggle-attachments" checked><span class="slider"><span class="icon-toggle-off"></span><span class="icon-toggle-on"></span></span></label>
                    </div>
                   
                     <div class="galvan-command-bar-setting-item" id="app-lock-type-setting" style="display: none;">
                        <span class="setting-label">Lock Type</span>
                        <button class="galvan-custom-select-trigger" data-select-id="app-lock-type"></button>
                    </div>
                     <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Auto-check for Updates</span>
                        <label class="galvan-switch"><input type="checkbox" id="setting-toggle-auto-update" checked><span class="slider"><span class="icon-toggle-off"></span><span class="icon-toggle-on"></span></span></label>
                    </div>
                    <div class="galvan-command-bar-setting-item galvan-color-palette-setting-item">
                        <span class="setting-label">Theme pallete</span>
                        <div class="galvan-color-palette-container" id="color-palette-options">
                            <!-- Palette buttons will be injected here by JS -->
                        </div>
                    </div>
                    <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">App Version</span>
                        <span id="setting-app-version" style="font-family: monospace; text-align: right; flex-grow:0;font-size:0.9em;"></span>
                    </div>
                   
                     <div class="galvan-command-bar-setting-item">
                        <span class="setting-label">Reset</span>
                        <button id="setting-reset-all-btn" class="galvan-setting-action-button" style="background-color: var(--current-error-text); color: white;">Reset</button>
                    </div>
                </div>

                <div id="expanded-command-bar-history-view" class="galvan-command-bar-content-view galvan-history-list-view" data-view="history">
                    <div class="galvan-history-options-toolbar">
                         <button id="history-clear-all-btn" class="galvan-history-action-btn">Clear All History</button>
                    </div>
                    <!-- History items will be populated here -->
                </div>

                <div id="expanded-command-bar-notices-view" class="galvan-command-bar-content-view galvan-notice-list-view" data-view="notices">
                    <!-- Notices will be populated here by JS -->
                </div>
            </div>
        </div>
    </div>

    <div class="galvan-toast-message" id="toast-message"></div>
    <div id="galvan-reset-overlay">
        <div class="reset-content">
            <div class="spinner"></div>
            <div class="reset-text">Resetting...</div>
        </div>
    </div>

    <!-- [NEW] UI 30 - Redesigned App Lock Screen -->
    <div id="galvan-pin-lock-overlay">
        <div class="galvan-pin-lock-container">
            <div id="lock-screen-avatar-container">
                <!-- JS will clone avatar here -->
            </div>
            <h2 class="galvan-pin-lock-title">Enter PIN</h2>
            <p class="galvan-pin-lock-subtitle">Enter your 4-digit PIN to continue.</p>
            
            <div id="pin-input-area">
                <div class="galvan-pin-dots-container">
                    <div class="galvan-pin-dot"></div>
                    <div class="galvan-pin-dot"></div>
                    <div class="galvan-pin-dot"></div>
                    <div class="galvan-pin-dot"></div>
                </div>
                <div class="galvan-pin-keypad">
                    <button class="galvan-pin-key" data-key="1">1</button>
                    <button class="galvan-pin-key" data-key="2">2</button>
                    <button class="galvan-pin-key" data-key="3">3</button>
                    <button class="galvan-pin-key" data-key="4">4</button>
                    <button class="galvan-pin-key" data-key="5">5</button>
                    <button class="galvan-pin-key" data-key="6">6</button>
                    <button class="galvan-pin-key" data-key="7">7</button>
                    <button class="galvan-pin-key" data-key="8">8</button>
                    <button class="galvan-pin-key" data-key="9">9</button>
                    <div style="grid-column: 2 / 3;">
                        <button class="galvan-pin-key" data-key="0">0</button>
                    </div>
                    <button class="galvan-pin-key key-backspace" data-key="backspace">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
                    </button>
                </div>
                <button id="lock-screen-forgot-btn">Forgot PIN?</button>
            </div>
        </div>
    </div>
    
    <!-- NEW: Bottom Sheet Selector HTML -->
    <div id="galvan-bottom-sheet-overlay">
        <div class="galvan-bottom-sheet-container">
            <div class="galvan-bottom-sheet-header">
                <h3 class="galvan-bottom-sheet-title">Select an Option</h3>
                <button class="galvan-bottom-sheet-close-btn" aria-label="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <ul class="galvan-bottom-sheet-options">
                <!-- Options will be populated here by JS -->
            </ul>
        </div>
    </div>

</body>
<body>

    <!-- 
  KEY SVG IMPLEMENTATION:
  This filter defines the displacement map that creates the refraction.
  - feImage loads the displacement map (created with blurred gray shape over gradients).
  - feDisplacementMap uses this map to distort the SourceGraphic (the content behind the panel).
-->
<svg style="position:absolute; width:0; height:0">
  <filter id="liquid-refraction">
    <!-- 
      Source: An embedded SVG displacement map, created as you described.
      - A blurred, neutral-gray rounded rectangle is placed over linear gradients.
      - This creates distortion primarily at the feathered edges.
    -->
    <feImage xlink:href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJ4R3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMDgwODAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNGRjgwODAiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0ieUdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjODAwMDgwIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjODBGRjgwIi8+PC9saW5lYXJHcmFkaWVudD48ZmlsdGVyIGlkPSJibHVyLW1hc2stZmlsdGVyIj48ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxMCIvPjwvZmlsdGVyPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3hHcmFkKSIvPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjeUdyYWQpIiBzdHlsZT0ibWl4LWJsZW5kLW1v%0D%0AZGU6IHNjcmVlbjsiLz48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjUiIHJ5PSIyNSIgZmlsbD0iIzgwODA4MCIgZmlsdGVyPSJ1cmwoI2JsdXItbWFzay1maWx0ZXIpIi8+PC9zdmc+" 
             x="0" y="0" width="100%" height="100%" result="dispMap" />
    
    <!-- Combiner: Applies the map to the background content (SourceGraphic) -->
    <feDisplacementMap in="SourceGraphic" in2="dispMap" scale="35" xChannelSelector="R" yChannelSelector="G" />
  </filter>
</svg>

</body>
<body>
    <!-- 
  KEY SVG IMPLEMENTATION:
  This filter defines the displacement map that creates the refraction.
  - feImage loads the displacement map (created with blurred gray shape over gradients).
  - feDisplacementMap uses this map to distort the SourceGraphic (the content behind the panel).
-->
<svg style="position:absolute; width:0; height:0">
  <filter id="liquid-refraction">
    <!-- 
      Source: An embedded SVG displacement map, created as you described.
      - A blurred, neutral-gray rounded rectangle is placed over linear gradients.
      - This creates distortion primarily at the feathered edges.
    -->
    <feImage xlink:href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJ4R3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMDgwODAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNGRjgwODAiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0ieUdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjODAwMDgwIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjODBGRjgwIi8+PC9saW5lYXJHcmFkaWVudD48ZmlsdGVyIGlkPSJibHVyLW1hc2stZmlsdGVyIj48ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxMCIvPjwvZmlsdGVyPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3hHcmFkKSIvPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjeUdyYWQpIiBzdHlsZT0ibWl4LWJsZW5kLW1v%0D%0AZGU6IHNjcmVlbjsiLz48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjUiIHJ5PSIyNSIgZmlsbD0iIzgwODA4MCIgZmlsdGVyPSJ1cmwoI2JsdXItbWFzay1maWx0ZXIpIi8+PC9zdmc+" 
             x="0" y="0" width="100%" height="100%" result="dispMap" />
    
    <!-- Combiner: Applies the map to the background content (SourceGraphic) -->
    <feDisplacementMap in="SourceGraphic" in2="dispMap" scale="35" xChannelSelector="R" yChannelSelector="G" />
  </filter>
</svg>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const background = document.getElementById('bg');
        const bgSelector = document.getElementById('bg-selector');
        const controlsContainer = document.getElementById('controls');
        const effectToggle = document.getElementById('effect-toggle');
        const unsplashQuery = document.getElementById('unsplash-query');
        const unsplashSearchBtn = document.getElementById('unsplash-search-btn');
        const galleryContainer = document.querySelector('.gallery');
        const resetBtn = document.getElementById('reset-btn');

        const defaultBg = 'https://images.unsplash.com/photo-1554141323-945767233671?q=80&w=2070&auto=format&fit=crop';
        const unsplashApiKey = 'YOUR_UNSPLASH_API_KEY';

        const predefinedImages = [
            'https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1974&auto=format&fit=crop',
            'https://images.unsplash.com/photo-1532274402911-5a369e4c4bb5?q=80&w=1974&auto=format&fit=crop',
            'https://images.unsplash.com/photo-1470770841072-f978cf4d019e?q=80&w=1974&auto=format&fit=crop',
            'https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=1974&auto=format&fit=crop'
        ];

        const setBackground = (url) => {
            background.style.backgroundImage = `url('${url}')`;
        };

        const populateGallery = () => {
            galleryContainer.innerHTML = '';
            predefinedImages.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.classList.add('gallery-img');
                img.alt = 'Predefined background image';
                img.loading = 'lazy';
                img.addEventListener('click', () => setBackground(url));
                galleryContainer.appendChild(img);
            });
        };

        bgSelector.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => setBackground(e.target.result);
                reader.readAsDataURL(file);
            }
        });

        const searchUnsplash = async () => { /* ... Unsplash logic unchanged ... */ };
        unsplashSearchBtn.addEventListener('click', searchUnsplash);
        unsplashQuery.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); searchUnsplash(); } });

        // Updated toggle to control the new refraction effect
        effectToggle.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            if (isEnabled) {
                controlsContainer.style.backdropFilter = 'blur(5px) url(#liquid-refraction)';
                controlsContainer.style.webkitBackdropFilter = 'blur(5px) url(#liquid-refraction)';
                controlsContainer.style.background = 'rgba(255, 255, 255, 0.05)';
                controlsContainer.style.border = '1px solid rgba(255, 255, 255, 0.2)';
            } else {
                controlsContainer.style.backdropFilter = 'none';
                controlsContainer.style.webkitBackdropFilter = 'none';
                controlsContainer.style.background = 'rgba(0, 0, 0, 0.4)';
                controlsContainer.style.border = '1px solid transparent';
            }
        });

        resetBtn.addEventListener('click', () => {
            setBackground(defaultBg);
            background.style.backgroundPosition = 'center center';
        });

        // Dragging logic remains unchanged
        let isDragging = false, startX, startY, currentBgX, currentBgY, animationFrameId;
        const getClientCoords = (e) => ({ x: e.touches ? e.touches[0].clientX : e.clientX, y: e.touches ? e.touches[0].clientY : e.clientY });
        const startDrag = (e) => {
            if (controlsContainer.contains(e.target)) return;
            isDragging = true;
            const coords = getClientCoords(e);
            startX = coords.x;
            startY = coords.y;
            const bgPos = window.getComputedStyle(background).backgroundPosition.split(' ');
            currentBgX = parseFloat(bgPos[0]);
            currentBgY = parseFloat(bgPos[1]);
            background.style.cursor = 'grabbing';
            background.style.transition = 'none';
        };
        const stopDrag = () => { if (!isDragging) return; isDragging = false; background.style.cursor = 'grab'; cancelAnimationFrame(animationFrameId); };
        const onDrag = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(() => {
                const coords = getClientCoords(e);
                const deltaX = coords.x - startX;
                const deltaY = coords.y - startY;
                background.style.backgroundPosition = `${currentBgX + deltaX}px ${currentBgY + deltaY}px`;
            });
        };

        document.addEventListener('mousedown', startDrag);
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('mousemove', onDrag, { passive: false });
        document.addEventListener('touchstart', startDrag, { passive: true });
        window.addEventListener('touchend', stopDrag);
        window.addEventListener('touchmove', onDrag, { passive: false });
        
        populateGallery();
    });
</script>
<body>
<svg style="position:absolute; width:0; height:0">
  <filter id="liquid-refraction">
    
    <feImage xlink:href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGRlZnM+PGxpbmVhckdyYWRpZW50IGlkPSJ4R3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMCUiPjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMwMDgwODAiLz48c3RvcCBvZmZzZXQ9IjEwMCUiIHN0b3AtY29sb3I9IiNGRjgwODAiLz48L2xpbmVhckdyYWRpZW50PjxsaW5lYXJHcmFkaWVudCBpZD0ieUdyYWQiIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMCUiIHkyPSIxMDAlIj48c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjODAwMDgwIi8+PHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjODBGRjgwIi8+PC9saW5lYXJHcmFkaWVudD48ZmlsdGVyIGlkPSJibHVyLW1hc2stZmlsdGVyIj48ZmVHYXVzc2lhbkJsdXIgc3RkRGV2aWF0aW9uPSIxMCIvPjwvZmlsdGVyPjwvZGVmcz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI3hHcmFkKSIvPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjeUdyYWQpIiBzdHlsZT0ibWl4LWJsZW5kLW1v%0D%0AZGU6IHNjcmVlbjsiLz48cmVjdCB4PSIxMCIgeT0iMTAiIHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iMjUiIHJ5PSIyNSIgZmlsbD0iIzgwODA4MCIgZmlsdGVyPSJ1cmwoI2JsdXItbWFzay1maWx0ZXIpIi8+PC9zdmc+" 
             x="0" y="0" width="100%" height="100%" result="dispMap" />
    
    
    <feDisplacementMap in="SourceGraphic" in2="dispMap" scale="35" xChannelSelector="R" yChannelSelector="G" />
  </filter>
</svg>
</body>
<script>

  const container = document.querySelector(".galvan-container");
    const body = document.body;
    const chatsContainer = document.querySelector(".galvan-chats-container");
    const promptForm = document.querySelector(".galvan-prompt-form");
    const promptWrapper = promptForm.querySelector(".galvan-prompt-wrapper");
    const promptInput = promptForm.querySelector(".prompt-input");
    const fileInput = promptForm.querySelector("#file-input");
    const fileUploadWrapper = promptForm.querySelector(".galvan-file-upload-wrapper");
    const filePreviewIconSVG = fileUploadWrapper.querySelector(".file-preview-icon-svg");
    const filePreviewImage = fileUploadWrapper.querySelector(".file-preview");
    const fileNameElement = fileUploadWrapper.querySelector(".galvan-file-name");
    const cancelFileBtn = document.querySelector("#cancel-file-btn");
    const themeToggleBtn = document.querySelector("#theme-toggle-btn");
    const addFileBtn = promptForm.querySelector("#add-file-btn");
    const mainContent = document.querySelector('.galvan-main-content');
    const welcomeScreen = document.querySelector('.galvan-welcome-screen');
    const suggestionsWrapper = document.querySelector('.galvan-suggestions-wrapper');
    const suggestionsContainer = document.querySelector('.galvan-suggestions');
    const homeBtn = document.querySelector("#home-btn");
    const sendBtn = promptForm.querySelector('#send-btn');
    const toastMessageElement = document.querySelector("#toast-message");
    const resetOverlay = document.getElementById('galvan-reset-overlay');
    
    const userGreeting = document.querySelector('.galvan-user-greeting');
    const vvStructureContainer = document.querySelector('.galvan-vv-structure-container');
    const vvStructureSVG = vvStructureContainer.querySelector('.galvan-vv-structure-svg');
    const vvUserImage = vvStructureSVG.querySelector('#vvUserImage');
    const vvBackgroundRect = vvStructureSVG.querySelector('#vvBackgroundRect');
    const vvShapePath = vvStructureSVG.querySelector('#vvShapePath');
    const vvImageInput = vvStructureContainer.querySelector('#vvImageInput');
    const vvSaveBtn = vvStructureContainer.querySelector('#vvSaveBtn');
    const vvRemoveBtn = vvStructureContainer.querySelector('#vvRemoveBtn');

    const chatBackgroundBlur = document.querySelector('.galvan-chat-background-blur');
    const userImageBackgroundBlur = document.querySelector('.galvan-user-image-background-blur');

    const commandBarContainer = document.querySelector('.galvan-command-bar-container');
    const commandBar = commandBarContainer.querySelector('.galvan-command-bar');
    const commandBarSettingsBtn = document.querySelector('#command-bar-settings-btn');
    const mainHistoryNavBtn = document.querySelector("#history-btn");
    const noticeNavBtn = document.querySelector("#notice-btn");

    const commandBarExpandedContentWrapper = document.querySelector('.galvan-command-bar-expanded-content-wrapper');
    const commandBarExpandedTopNav = commandBarExpandedContentWrapper.querySelector('.galvan-command-bar-expanded-top-nav');
    
    const settingsView = document.getElementById('expanded-command-bar-settings-view');
    const historyView = document.getElementById('expanded-command-bar-history-view');
    const noticesView = document.getElementById('expanded-command-bar-notices-view');

    const historyClearAllBtnIncommandBar = historyView.querySelector("#history-clear-all-btn");

    const settingToggleSuggestionsSwitch = document.querySelector('#setting-toggle-suggestions');
    const settingToggleAIThoughtsSwitch = document.querySelector('#setting-toggle-ai-thoughts');
    const settingToggleDarkModeSwitch = document.querySelector('#setting-toggle-dark-mode');
    const settingToggleSystemThemeSwitch = document.getElementById('setting-toggle-system-theme');
    const settingBlurSliderItem = document.getElementById('blur-control-setting-item');
    const settingBlurSlider = document.querySelector('#setting-blur-slider');
    const blurSliderValueDisplay = document.querySelector('#blur-slider-value');
    const blurControlNotice = document.getElementById('blur-control-notice');
    const settingAppVersionDisplay = document.querySelector('#setting-app-version');
    const settingCheckUpdatesBtn = document.querySelector('#setting-check-updates-btn');
    const settingResetAllBtn = document.querySelector('#setting-reset-all-btn');
    const settingToggleAttachmentsSwitch = document.querySelector('#setting-toggle-attachments');
    const settingToggleAutoUpdateSwitch = document.querySelector('#setting-toggle-auto-update');
    const colorPaletteOptionsContainer = document.getElementById('color-palette-options');

    // [NEW/REFACTORED] UI 30 - App Lock Elements
    const pinLockOverlay = document.getElementById('galvan-pin-lock-overlay');
    const pinLockContainer = pinLockOverlay.querySelector('.galvan-pin-lock-container');
    const pinLockAvatarContainer = document.getElementById('lock-screen-avatar-container');
    const pinLockTitle = pinLockOverlay.querySelector('.galvan-pin-lock-title');
    const pinLockSubtitle = pinLockOverlay.querySelector('.galvan-pin-lock-subtitle');
    const pinInputArea = document.getElementById('pin-input-area');
    const pinDots = pinInputArea.querySelectorAll('.galvan-pin-dot');
    const pinKeypad = pinInputArea.querySelector('.galvan-pin-keypad');
    const lockScreenForgotBtn = document.getElementById('lock-screen-forgot-btn');
    const settingToggleAppLock = document.getElementById('setting-toggle-app-lock');
    const appLockTypeSettingItem = document.getElementById('app-lock-type-setting');

    // NEW: Bottom Sheet Selector Elements
    const bottomSheetOverlay = document.getElementById('galvan-bottom-sheet-overlay');
    const bottomSheetContainer = bottomSheetOverlay.querySelector('.galvan-bottom-sheet-container');
    const bottomSheetTitle = bottomSheetOverlay.querySelector('.galvan-bottom-sheet-title');
    const bottomSheetCloseBtn = bottomSheetOverlay.querySelector('.galvan-bottom-sheet-close-btn');
    const bottomSheetOptionsList = bottomSheetOverlay.querySelector('.galvan-bottom-sheet-options');

    // NEW: Prompt History Navigation Elements
    const promptNavButtonsContainer = document.querySelector('.galvan-prompt-nav-buttons');
    const promptNavUpBtn = document.getElementById('prompt-nav-up');
    const promptNavDownBtn = document.getElementById('prompt-nav-down');


    const API_KEY = "AIzaSyBJvbheSp3kd5EhT0ZEFbaBz7y4_KBWBqo"; // IMPORTANT: Replace with your actual Gemini API Key
    const IS_API_KEY_VALID = API_KEY && API_KEY !== "YOUR_API_KEY_HERE" && API_KEY.length > 30;
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;
    
    const STORAGE_KEY = 'galvanAi_v30_settings'; // Updated storage key for new structure

    let controller, typingInterval, thinkingTimeout, toastTimeout, scrollTimeout;
    let longPressTimeout, isLongPress = false, messageBeingEditedTimestamp = null;
    
    let appSettings = {};
    let currentChatSession = []; 
    const userData = { message: "", file: {} };
    const isLocalStorageAvailable = (() => { try { localStorage.setItem('_test', '1'); localStorage.removeItem('_test'); return true; } catch (e) { return false; } })();
    let messageCounter = 0;
    let vvSelectedImageData = null; 
    let vvIsEditing = false; 
    const CURRENT_APP_VERSION_FOR_NOTICE = "Galvan Ui 8.5";
    let currentThemeIsLight = true;
    let activecommandBarView = null; 
    let activecommandBarMainButtonOpener = null; 
    
    // App Lock State
    let pinInput = '';
    let lockState = 'locked'; // 'locked', 'set', 'confirm'
    let temporaryLockValue = '';

    // NEW: Prompt History State
    let promptHistoryIndex = -1; // -1 means new prompt, 0+ is an index in the user prompts array
    let userPromptsHistory = []; // Stores just the user prompts from the current session for navigation
    
    const VV_SHAPES = {
        'circle': { name: 'Circle', path: "M50,5 A45,45 0 1,1 49.9,5 Z" },
        'square': { name: 'Square', path: "M5,5 H95 V95 H5 Z" },
        'rounded-square': { name: 'Rounded Square', path: "M20,5 H80 A15,15 0 0 1 95,20 V80 A15,15 0 0 1 80,95 H20 A15,15 0 0 1 5,80 V20 A15,15 0 0 1 20,5 Z" },
        'wavy-rounded-square': { name: 'Wavy Rounded Sq.', path: "M15,5 H85 C95,5 95,5 95,15 V30 C95,35 90,35 90,40 C90,45 95,45 95,50 V65 C95,75 95,75 85,75 H15 C5,75 5,75 5,65 V50 C5,45 10,45 10,40 C10,35 5,35 5,30 V15 C5,5 5,5 15,5 Z" },
        'triangle': { name: 'Triangle', path: "M50,5 L95,90 H5 Z" },
        'trapezium': { name: 'Trapezium', path: "M20,5 H80 L95,95 H5 Z" },
        'rhombus': { name: 'Rhombus', path: "M50,5 L95,50 L50,95 L5,50 Z" }
    };
    let currentVVShape = 'circle';
    
    const FONT_FAMILIES = {
        'default': { name: 'Inter' },
        'system': { name: 'System Default' },
        'arial': { name: 'Arial' },
        'times': { name: 'Times New Roman' },
        'courier': { name: 'Courier New' },
    };
    const FONT_SIZES = {
        '14px': { name: 'Small' }, '16px': { name: 'Medium' }, '18px': { name: 'Large' }, '20px': { name: 'Extra Large' }
    };
     const APP_LOCK_TYPES = {
        'pin': { name: 'PIN' } // Simplified to PIN-only for UI 30 redesign focus
    };

    const baseThemeVariables = { light: {}, dark: {} };
    const paletteVariableMap = { 
        appBodyBg: 'body-bg', appBgPrimary: 'bg-primary', appBgSecondary: 'bg-secondary', appBgTertiary: 'bg-tertiary',
        appTextPrimary: 'text-primary', appTextSecondary: 'text-secondary', appTextPlaceholder: 'text-placeholder',
        appBorderColor: 'border-color', appIconPrimary: 'icon-primary', appIconActive: 'icon-active',
        appIconStatic: 'icon-static', appUserMsgBg: 'user-msg-bg', appBotMsgBg: 'bot-msg-bg',
        appLogoStop1: 'logo-stop-1', appLogoStop2: 'logo-stop-2', appLogoStop3: 'logo-stop-3',
        appLogoGlowColor: 'logo-glow-color', appWaveColor: 'wave-color', appLogoBlurGrad: 'logo-blur-grad',
        appGreetingGrad: 'greeting-grad'
    };

    function captureBaseThemeVariables() {
        const root = document.documentElement;
        Object.keys(paletteVariableMap).forEach(paletteKey => {
            const cssSuffix = paletteVariableMap[paletteKey];
            baseThemeVariables.light[`--app-${cssSuffix}-light`] = getComputedStyle(root).getPropertyValue(`--app-${cssSuffix}-light`).trim();
            baseThemeVariables.dark[`--app-${cssSuffix}-dark`] = getComputedStyle(root).getPropertyValue(`--app-${cssSuffix}-dark`).trim();
        });
    }

    const COLOR_PALETTES = [
        { 
            id: 'galvan', name: '', isDefault: true,
            preview: { bg: 'rgb(212 255 205)', bubble: 'linear-gradient(135deg, #007cff, #e8ff00)', accent1: '#3b1dd8', accent2: '#b9bc29' }
        },
        {
            id: 'cosmic_latte', name: '',
            light: {
                appBodyBg: '#FDFCF7', appBgPrimary: '#FFFFFF', appBgSecondary: '#F5F2E9', appBgTertiary: '#EAE5D9',
                appTextPrimary: '#4E342E', appTextSecondary: '#795548', appTextPlaceholder: '#A1887F',
                appBorderColor: '#D7CCC8', appIconPrimary: '#FF9800', appIconActive: '#E65100', appIconStatic: '#BCAAA4',
                appUserMsgBg: 'linear-gradient(135deg, #ff4d4d, #ff9800)', appBotMsgBg: '#F5F2E9',
                appLogoStop1: '#FFB74D', appLogoStop2: '#FF7043', appLogoStop3: '#795548', appLogoGlowColor: '#FFCC80',
                appWaveColor: 'rgba(255, 152, 0, 0.07)', appGreetingGrad: 'linear-gradient(120deg, #FF9800, #E65100)'
            },
            dark: {
                appBodyBg: '#1C1B1A', appBgPrimary: '#2E2B27', appBgSecondary: '#3E3A36', appBgTertiary: '#4E4A45',
                appTextPrimary: '#ECEFF1', appTextSecondary: '#CFD8DC', appTextPlaceholder: '#90A4AE',
                appBorderColor: '#54504D', appIconPrimary: '#FFCC80', appIconActive: '#FFAB40', appIconStatic: '#B0BEC5',
                appUserMsgBg: 'linear-gradient(135deg, #FFA726, #F57C00)', appBotMsgBg: '#3E3A36',
                appLogoStop1: '#FFB74D', appLogoStop2: '#FF8A65', appLogoStop3: '#FFD180', appLogoGlowColor: '#FFAB40',
                appWaveColor: 'rgba(255, 171, 64, 0.08)', appGreetingGrad: 'linear-gradient(120deg, #FFCC80, #FFAB40)'
            },
            preview: { bg: 'rgb(91 4 4)', bubble: 'linear-gradient(135deg, #ff4d4d, #ff9800)', accent1: '#E65100', accent2: '#795548' }
        },
        {
            id: 'oceanic_deep', name: '',
            light: {
                appBodyBg: '#E1F5FE', appBgPrimary: '#FFFFFF', appBgSecondary: '#F0F8FF', appBgTertiary: '#E0F2F1',
                appTextPrimary: '#004D40', appTextSecondary: '#00695C', appTextPlaceholder: '#4DB6AC',
                appBorderColor: '#B2DFDB', appIconPrimary: '#00838F', appIconActive: '#006064', appIconStatic: '#80DEEA',
                appUserMsgBg: 'linear-gradient(135deg, #26A69A, #00838F)', appBotMsgBg: '#E0F7FA',
                appLogoStop1: '#4DD0E1', appLogoStop2: '#4DB6AC', appLogoStop3: '#80DEEA', appLogoGlowColor: '#4DD0E1',
                appWaveColor: 'rgba(0, 131, 143, 0.09)', appGreetingGrad: 'linear-gradient(120deg, #00838F, #006064)'
            },
            dark: {
                appBodyBg: '#01192D', appBgPrimary: '#012A4A', appBgSecondary: '#013A63', appBgTertiary: '#024C7D',
                appTextPrimary: '#E0F7FA', appTextSecondary: '#B2EBF2', appTextPlaceholder: '#80DEEA',
                appBorderColor: '#035E98', appIconPrimary: '#4DD0E1', appIconActive: '#80DEEA', appIconStatic: '#B2EBF2',
                appUserMsgBg: 'linear-gradient(135deg, #29B6F6, #0277BD)', appBotMsgBg: '#013A63',
                appLogoStop1: '#4DD0E1', appLogoStop2: '#80DEEA', appLogoStop3: '#29B6F6', appLogoGlowColor: '#80DEEA',
                appWaveColor: 'rgba(77, 208, 225, 0.07)', appGreetingGrad: 'linear-gradient(120deg, #4DD0E1, #80DEEA)'
            },
            preview: { bg: '#012A4A', bubble: 'linear-gradient(135deg, #29B6F6, #0277BD)', accent1: '#4DD0E1', accent2: '#29B6F6' }
        },
        {
            id: 'evergreen', name: '',
            light: {
                appBodyBg: '#F1F8E9', appBgPrimary: '#FFFFFF', appBgSecondary: '#FAFCF7', appBgTertiary: '#E8F5E9',
                appTextPrimary: '#33691E', appTextSecondary: '#558B2F', appTextPlaceholder: '#9CCC65',
                appBorderColor: '#DCEDC8', appIconPrimary: '#689F38', appIconActive: '#558B2F', appIconStatic: '#AED581',
                appUserMsgBg: 'linear-gradient(135deg, #9CCC65, #7CB342)', appBotMsgBg: '#F1F8E9',
                appLogoStop1: '#AED581', appLogoStop2: '#DCE775', appLogoStop3: '#8BC34A', appLogoGlowColor: '#C5E1A5',
                appWaveColor: 'rgba(104, 159, 56, 0.08)', appGreetingGrad: 'linear-gradient(120deg, #689F38, #558B2F)'
            },
            dark: {
                appBodyBg: '#0F2212', appBgPrimary: '#1B311F', appBgSecondary: '#254028', appBgTertiary: '#355438',
                appTextPrimary: '#E8F5E9', appTextSecondary: '#C8E6C9', appTextPlaceholder: '#A5D6A7',
                appBorderColor: '#436846', appIconPrimary: '#AED581', appIconActive: '#CCFF90', appIconStatic: '#C5E1A5',
                appUserMsgBg: 'linear-gradient(135deg, #00ff1c, #33691E)', appBotMsgBg: '#254028',
                appLogoStop1: '#AED581', appLogoStop2: '#9CCC65', appLogoStop3: '#CCFF90', appLogoGlowColor: '#CCFF90',
                appWaveColor: 'rgba(174, 213, 129, 0.06)', appGreetingGrad: 'linear-gradient(120deg, #AED581, #CCFF90)'
            },
            preview: { bg: '#1B311F', bubble: 'linear-gradient(135deg, #00ff1c, #33691E)', accent1: '#89ff00', accent2: '#66bd00' }
        },
    ];

    // --- Settings Management ---
    const getDefaultSettings = () => ({
        themeMode: 'light',
        showSuggestions: true,
        showAiThoughts: true,
        vvImage: null,
        blurIntensity: 1.0,
        lastSeenNotice: "0.0.0",
        vvShape: 'circle',
        fontFamily: 'default',
        fontSize: '16px',
        enableAttachments: true,
        autoUpdate: true,
        colorPalette: 'galvan',
        customSuggestions: [],
        appLockEnabled: false,
        appLockType: 'pin',
        appLockCode: null,
        syncWithSystemTheme: true,
        chatHistory: []
    });

    const loadSettings = () => {
        if (!isLocalStorageAvailable) {
            appSettings = getDefaultSettings();
            return;
        }
        try {
            const storedSettings = JSON.parse(localStorage.getItem(STORAGE_KEY));
            appSettings = { ...getDefaultSettings(), ...storedSettings };
        } catch (e) {
            console.error("Failed to load settings, using defaults.", e);
            appSettings = getDefaultSettings();
        }
    };
    
    const saveSettings = () => {
        if (!isLocalStorageAvailable) return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appSettings));
    };

    const getUserData = (key) => appSettings[key];
    
    const setUserData = (key, value) => {
        appSettings[key] = value;
        saveSettings();
    };

    const showTemporaryToast = (message) => {
         clearTimeout(toastTimeout);
         toastMessageElement.textContent = message;
         toastMessageElement.classList.add('show');
         toastTimeout = setTimeout(() => {
             toastMessageElement.classList.remove('show');
         }, 3300);
    };

    const scrollToBottom = (behavior = "smooth") => {
         // Debounce scroll requests to prevent jank, especially while AI is typing
         clearTimeout(scrollTimeout);
         scrollTimeout = setTimeout(() => {
            if (chatsContainer.scrollHeight > chatsContainer.clientHeight) {
                 chatsContainer.scrollTo({ top: chatsContainer.scrollHeight, behavior: behavior });
            }
         }, 50);
    };
    
    const updateBlurControlVisibility = () => {
        const hasUserImage = body.classList.contains('user-bg-active');
        if (settingBlurSliderItem) settingBlurSliderItem.style.display = 'flex'; 
        if (settingBlurSlider) settingBlurSlider.style.display = hasUserImage ? 'block' : 'none';
        if (blurSliderValueDisplay) blurSliderValueDisplay.style.display = hasUserImage ? 'block' : 'none';
        if (blurControlNotice) blurControlNotice.style.display = hasUserImage ? 'none' : 'block';
    };


    const applyVVShape = (shapeId) => {
        if (VV_SHAPES[shapeId] && vvShapePath) {
            vvShapePath.setAttribute('d', VV_SHAPES[shapeId].path);
            currentVVShape = shapeId;
            setUserData('vvShape', shapeId);
        }
    };
    const loadVVShapePreference = () => {
        let storedShape = getUserData('vvShape') || 'circle';
        if (!VV_SHAPES[storedShape]) storedShape = 'circle';
        applyVVShape(storedShape);
        updateCustomSelect('vv-shape', storedShape);
    };
    
    const setVVImage = (base64Data) => {
        if (base64Data) {
            vvUserImage.setAttribute('href', base64Data);
            vvUserImage.style.display = 'block';
            userImageBackgroundBlur.style.backgroundImage = `url(${base64Data})`;
            body.classList.add('user-bg-active');
            vvStructureContainer.classList.add('has-image'); 
        } else {
            vvUserImage.setAttribute('href', '');
            vvUserImage.style.display = 'none';
            userImageBackgroundBlur.style.backgroundImage = 'none';
            body.classList.remove('user-bg-active');
            vvStructureContainer.classList.remove('has-image', 'vv-image-staged'); 
        }
        updateBlurControlVisibility(); 
    };
    
    const triggerVVAnimation = (animationClass) => {
        vvStructureContainer.classList.remove('vv-image-staged'); 
        if (animationClass) vvStructureContainer.classList.add(animationClass);
    };

    const clearVVDisplay = () => { setVVImage(null); vvSelectedImageData = null; };

    const saveVVImagePreference = (base64Data) => {
        setUserData('vvImage', base64Data);
        setVVImage(base64Data); 
    };
    
    const loadVVImagePreference = () => {
        const savedImage = getUserData('vvImage');
        if (savedImage) setVVImage(savedImage);
        else clearVVDisplay();
        updateVVControlsVisibility();
        updateBlurControlVisibility();
    };

    const updateVVControlsVisibility = () => {
        const hasStoredImage = !!getUserData('vvImage');
        if (vvIsEditing) {
            vvSaveBtn.classList.toggle('visible', !!vvSelectedImageData); 
            vvRemoveBtn.classList.toggle('visible', hasStoredImage && !vvSelectedImageData); 
        } else {
            vvSaveBtn.classList.remove('visible');
            vvRemoveBtn.classList.remove('visible');
        }
    };
    
    function _goHome(animateSuggestions = true) {
        if (commandBarContainer.classList.contains('expanded')) closecommandBarExpandedView();
        
        body.classList.remove('chats-active', 'suggestions-scrolled');
        if (body.classList.contains("bot-responding")) stopResponseGeneration();
        
        if (suggestionsContainer && animateSuggestions && !body.classList.contains('hide-suggestions')) {
            suggestionsContainer.scrollTo({ top: 0, behavior: 'smooth'});
            suggestionsContainer.style.animation = 'none';
            void suggestionsContainer.offsetWidth; 
            suggestionsContainer.style.animation = 'suggestionsEnterNew 1s var(--ease-soft-spring) 0.2s both';
            
            suggestionsContainer.querySelectorAll(".galvan-suggestions-item").forEach((item, index) => {
                const inner = item.querySelector('.galvan-suggestion-item-inner');
                if (inner) {
                    inner.style.animation = 'none';
                    void inner.offsetWidth;
                    inner.style.animation = `suggestionItemEnter 0.7s var(--ease-soft-spring) ${0.35 + index * 0.08}s forwards`;
                }
            });
        }
        
        vvIsEditing = false; 
        vvStructureContainer.classList.remove('vv-image-staged');
        updateVVControlsVisibility();
        
        currentChatSession = [];
        renderChatHistoryToDOM(currentChatSession); 
        messageBeingEditedTimestamp = null;
        setActiveNavButton(homeBtn, commandBar);
    }

    vvStructureContainer.addEventListener('click', (e) => {
        if (e.target.closest('.galvan-vv-control-btn')) return; 
        if (body.classList.contains('chats-active') || body.classList.contains('command-bar-expanded')) {
             _goHome(); return;
        }
        if (!vvIsEditing) { 
            const hasStoredImage = !!getUserData('vvImage');
            if (hasStoredImage) vvIsEditing = true;
            else vvImageInput.click(); 
        } else { vvImageInput.click(); }
        updateVVControlsVisibility();
    });

    vvImageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                vvSelectedImageData = e.target.result; 
                vvUserImage.setAttribute('href', vvSelectedImageData);
                vvUserImage.style.display = 'block';
                vvIsEditing = true; 
                triggerVVAnimation('vv-image-staged'); 
                updateVVControlsVisibility();
            };
            reader.readAsDataURL(file);
        }
        event.target.value = null; 
    });

    vvSaveBtn.addEventListener('click', () => {
        if (vvSelectedImageData) {
            saveVVImagePreference(vvSelectedImageData);
            showTemporaryToast("Image saved as background.");
            vvStructureContainer.classList.remove('vv-image-staged'); 
        }
        vvSelectedImageData = null; vvIsEditing = false; updateVVControlsVisibility();
    });

    vvRemoveBtn.addEventListener('click', () => {
        saveVVImagePreference(null); 
        showTemporaryToast("Background image removed.");
        vvSelectedImageData = null; vvIsEditing = false;
        vvStructureContainer.classList.remove('vv-image-staged');
        updateVVControlsVisibility();
    });
    
    document.addEventListener('click', (e) => {
        if (vvIsEditing && !vvStructureContainer.contains(e.target) && !vvSelectedImageData) {
            vvIsEditing = false; updateVVControlsVisibility();
        }
    });

    const applyBlurIntensity = (intensity) => {
        document.documentElement.style.setProperty('--galvan-blur-intensity-multiplier', intensity);
        if(blurSliderValueDisplay) blurSliderValueDisplay.textContent = `${parseFloat(intensity).toFixed(1)}x`;
        setUserData('blurIntensity', intensity);
    };
    const loadBlurPreference = () => {
        let storedIntensity = getUserData('blurIntensity') ?? 1.0;
        if (settingBlurSlider) settingBlurSlider.value = storedIntensity;
        applyBlurIntensity(storedIntensity);
        updateBlurControlVisibility();
    };
    if (settingBlurSlider) settingBlurSlider.addEventListener('input', (e) => applyBlurIntensity(e.target.value));

    const applyFontFamily = (fontFamilyKey) => {
        const fontFamiliesMap = {
            'default': "'Inter', -apple-system, sans-serif",
            'system': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
            'arial': 'Arial, Helvetica, sans-serif',
            'times': '"Times New Roman", Times, serif',
            'courier': '"Courier New", Courier, monospace',
        };
        const fontFamily = fontFamiliesMap[fontFamilyKey] || fontFamiliesMap['default'];
        document.documentElement.style.setProperty('--current-font-family', fontFamily);
        setUserData('fontFamily', fontFamilyKey);
    };
    const applyFontSize = (fontSizeKey) => {
        const fontSize = FONT_SIZES[fontSizeKey] ? fontSizeKey : '16px';
        document.documentElement.style.setProperty('--current-font-size', fontSize);
        setUserData('fontSize', fontSizeKey);
    };
    const loadFontPreferences = () => {
        const storedFamilyKey = getUserData('fontFamily') || 'default';
        applyFontFamily(storedFamilyKey);
        updateCustomSelect('font-family', storedFamilyKey);

        const storedSizeKey = getUserData('fontSize') || '16px';
        applyFontSize(storedSizeKey);
        updateCustomSelect('font-size', storedSizeKey);
    };
    
    const applyLightDarkMode = (isLight, forcePaletteUpdate = false) => {
        body.classList.toggle("light-mode", isLight);
        currentThemeIsLight = isLight;

        if (forcePaletteUpdate) {
            const currentPaletteId = getUserData('colorPalette') || 'galvan';
            applyColorPalette(currentPaletteId, false); 
        }
        [themeToggleBtn, commandBarExpandedTopNav.querySelector('#theme-toggle-btn-cloned')].forEach(btn => {
            if (btn) btn.classList.toggle('active', !isLight); // active when dark
        });
        if (settingToggleDarkModeSwitch) settingToggleDarkModeSwitch.checked = !isLight;
        
        requestAnimationFrame(() => { 
            if(vvBackgroundRect) vvBackgroundRect.style.fill = getComputedStyle(document.documentElement).getPropertyValue('--current-bg-primary');
        });
    };

    const saveLightDarkModePreference = () => {
        setUserData('themeMode', currentThemeIsLight ? "light" : "dark");
    };
    const loadLightDarkModePreference = () => {
        let storedIsLight = (getUserData('themeMode') !== "dark");
        applyLightDarkMode(storedIsLight, true); 
    };
    
    if(themeToggleBtn) themeToggleBtn.addEventListener("click", () => { applyLightDarkMode(!body.classList.contains("light-mode"), true); saveLightDarkModePreference(); });
    if(settingToggleDarkModeSwitch) settingToggleDarkModeSwitch.addEventListener('change', (e) => { applyLightDarkMode(!e.target.checked, true); saveLightDarkModePreference(); });
    
    const MQL = window.matchMedia('(prefers-color-scheme: dark)');
    MQL.addEventListener('change', e => {
        if (getUserData('syncWithSystemTheme')) {
            applyLightDarkMode(!e.matches, true);
            saveLightDarkModePreference();
        }
    });

    if (settingToggleSystemThemeSwitch) {
        settingToggleSystemThemeSwitch.addEventListener('change', (e) => {
            setUserData('syncWithSystemTheme', e.target.checked);
            if (e.target.checked) {
                applyLightDarkMode(!MQL.matches, true);
                saveLightDarkModePreference();
            }
        });
    }


    const saveFullChatHistory = () => {
        const fullChatHistory = getUserData('chatHistory');
        if (!fullChatHistory) return;

        const MAX_HISTORY_ITEMS = 100; 
        if (fullChatHistory.length > MAX_HISTORY_ITEMS * 2) { // Rough check
            let turnCount = 0; let pruneIndex = fullChatHistory.length;
            for (let i = fullChatHistory.length - 1; i >= 0; i--) {
                if (fullChatHistory[i].role === 'user') {
                    turnCount++;
                    if (turnCount > MAX_HISTORY_ITEMS) { pruneIndex = i; break; }
                }
                if (turnCount <= MAX_HISTORY_ITEMS && i === 0) { pruneIndex = 0; }
            }
            const prunedHistory = fullChatHistory.slice(pruneIndex);
            setUserData('chatHistory', prunedHistory);
        } else {
            setUserData('chatHistory', fullChatHistory);
        }
    };
    
    function escapeHtml(unsafe) {
        if (typeof unsafe !== 'string') return '';
        return unsafe
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function parseMarkdownToHTML(text) {
        let html = text;
        html = escapeHtml(html);

        html = html.replace(/```(\w*)\n([\s\S]*?)\n```/g, (match, lang, code) => `<pre><code class="language-${lang || 'text'}">${code}</code></pre>`);
        html = html.replace(/^(#{1,6})\s(.*)$/gm, (match, hashes, content) => `<h${hashes.length}>${content}</h${hashes.length}>`);
        html = html.replace(/^>\s(.*)$/gm, '<blockquote>$1</blockquote>');
        html = html.replace(/^((\s*([*+-]|\d+\.)\s.*)+)$/gm, (match) => {
            const isOrdered = /^\s*\d+\./.test(match);
            const tag = isOrdered ? 'ol' : 'ul';
            const items = match.split('\n').filter(Boolean).map(item => `<li>${item.replace(/^\s*([*+-]|\d+\.)\s/, '')}</li>`).join('');
            return `<${tag}>${items}</${tag}>`;
        });
        html = html.replace(/^---\s*$/gm, '<hr>');

        html = html.replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1" class="galvan-img-attachment">');
        html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
        html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>');
        html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>');
        html = html.replace(/`(.*?)`/g, '<code>$1</code>');

        return html.replace(/\n/g, '<br>');
    }
    
    function renderChatHistoryToDOM(historyArrayToRender) {
        chatsContainer.innerHTML = ""; messageCounter = 0;
        if (!historyArrayToRender) return;
        historyArrayToRender.forEach((entry, index) => {
            if (!entry || !entry.role || !entry.parts) return;
            let messageHTML = '';
            const textPart = entry.parts.find(p => p.text);
            const filePart = entry.parts.find(p => p.fileData);

            if (textPart) { 
                messageHTML += parseMarkdownToHTML(textPart.text).replace(/<br>/g, '\n'); 
            } 
            if (filePart && filePart.fileData) {
                const fileData = filePart.fileData;
                const safeFileName = escapeHtml(fileData.fileName || 'attached_file');
                const mimeType = fileData.mime_type || 'application/octet-stream';
                const isImage = mimeType.startsWith('image/');
                const base64Data = fileData.data; 
                if (isImage && base64Data) messageHTML += `<img src="data:${mimeType};base64,${base64Data}" alt="${safeFileName}" class="galvan-img-attachment" />`;
                else messageHTML += `<div class="galvan-file-attachment">${getFileIconSVG(mimeType, safeFileName)}<p>${safeFileName}</p></div>`;
            }
            const messageClass = entry.role === 'user' ? 'user-message' : 'bot-message';
            const messageDiv = createMessageElement(`<div class="galvan-message-text">${messageHTML || '<i>(content missing)</i>'}</div>`, messageClass);
            messageDiv.dataset.timestamp = entry.timestamp || Date.now(); 
            messageDiv.style.animationDelay = `${Math.min(index * 0.06, 0.6)}s`;
            
            if (entry.role === 'user') { addPressAndHoldListener(messageDiv); }
            chatsContainer.appendChild(messageDiv);
            if (entry.role === 'model') addResponseActionButtons(messageDiv);
        });
         if (historyArrayToRender.length > 0 && !body.classList.contains('chats-active')) body.classList.add("chats-active");
        scrollToBottom("auto");
        updatePromptNavButtons();
    }
    
    const loadFullChatHistoryFromStorage = () => {
        const loadedHistory = getUserData('chatHistory');
        currentChatSession = [];
        renderChatHistoryToDOM(currentChatSession);
        return loadedHistory && loadedHistory.length > 0;
    };

    const clearAllChatHistory = () => {
        currentChatSession = [];
        setUserData('chatHistory', []);
        renderChatHistoryToDOM(currentChatSession);
        showTemporaryToast("cleared");
        body.classList.remove('chats-active');
        setActiveNavButton(homeBtn, commandBar);
        populateHistoryViewIncommandBar();
    };

    const loadChatTurnIntoSession = (startIndex, endIndex) => {
        const fullChatHistory = getUserData('chatHistory');
        currentChatSession = fullChatHistory.slice(0, endIndex + 1); 
        renderChatHistoryToDOM(currentChatSession);
        closecommandBarExpandedView(); 
        setActiveNavButton(mainHistoryNavBtn, commandBar); 
        body.classList.add('chats-active');
        showTemporaryToast("Loaded");
    };

    const getRelativeDateString = (d) => {
        const date = new Date(d);
        const today = new Date();
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);

        const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();

        if (isSameDay(date, today)) return 'Today';
        if (isSameDay(date, yesterday)) return 'Yesterday';
        
        return date.toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    };

    const createHistoryItemElement = (startIndex, endIndex) => {
        const fullChatHistory = getUserData('chatHistory');
        const userEntry = fullChatHistory[startIndex];
        const userText = userEntry.parts.find(p => p.text)?.text || "User query (no text)";
        
        const historyItemDiv = document.createElement('div');
        historyItemDiv.classList.add('galvan-history-item');
        historyItemDiv.dataset.turnStartIndex = startIndex;
        historyItemDiv.dataset.turnEndIndex = endIndex;

        const itemTimestamp = new Date(userEntry.timestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
        
        historyItemDiv.innerHTML = `
            <p class="galvan-history-item-query">${escapeHtml(userText.substring(0, 150))}${userText.length > 150 ? '...' : ''}</p>
            <div class="galvan-history-item-header">
                <span class="galvan-history-item-timestamp">${itemTimestamp}</span>
                <button class="galvan-history-item-delete-btn" aria-label="Delete this turn"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>
            </div>`;

        historyItemDiv.querySelector('.galvan-history-item-delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm("Delete this conversation turn? This will remove it from your history permanently.")) {
                deleteHistoryTurnFromFull(startIndex, endIndex);
            }
        });

        historyItemDiv.addEventListener('click', () => {
            loadChatTurnIntoSession(startIndex, endIndex);
        });

        return historyItemDiv;
    };

    const populateHistoryViewIncommandBar = () => {
        if (!historyView) return;

        const toolbar = historyView.querySelector('.galvan-history-options-toolbar');
        historyView.innerHTML = ''; 
        if (toolbar) historyView.appendChild(toolbar);

        const fullChatHistory = getUserData('chatHistory') || [];

        if (fullChatHistory.length === 0) {
            historyView.classList.add('empty-history');
            historyView.insertAdjacentHTML('beforeend', `<div class="galvan-empty-history-message">
                 <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
                   <p>Nothing yet.<br>Have a conversation!</p>
            </div>`);
            return;
        }

        historyView.classList.remove('empty-history');

        const historyTurns = [];
        for (let i = 0; i < fullChatHistory.length; i++) {
            if (fullChatHistory[i].role === 'user') {
                let endIndex = i;
                while (endIndex + 1 < fullChatHistory.length && fullChatHistory[endIndex + 1].role === 'model') {
                    endIndex++;
                }
                historyTurns.push({ startIndex: i, endIndex: endIndex, timestamp: fullChatHistory[i].timestamp });
            }
        }

        const groupedByDate = historyTurns.reduce((acc, turn) => {
            const dateStr = getRelativeDateString(new Date(turn.timestamp));
            if (!acc[dateStr]) acc[dateStr] = [];
            acc[dateStr].push(turn);
            return acc;
        }, {});

        const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
             const dateA = new Date(groupedByDate[a][0].timestamp);
             const dateB = new Date(groupedByDate[b][0].timestamp);
             return dateB - dateA;
        });

        sortedDates.forEach(dateStr => {
            const dateHeader = document.createElement('div');
            dateHeader.className = 'galvan-history-date-header';
            dateHeader.textContent = dateStr;
            historyView.appendChild(dateHeader);

            const dateGroupContainer = document.createElement('div');
            dateGroupContainer.className = 'galvan-history-date-group';

            const turnsForDate = groupedByDate[dateStr].sort((a, b) => b.timestamp - a.timestamp);
            
            turnsForDate.forEach(turn => {
                const historyItemDiv = createHistoryItemElement(turn.startIndex, turn.endIndex);
                dateGroupContainer.appendChild(historyItemDiv);
            });

            historyView.appendChild(dateGroupContainer);
        });
    };
    
    const deleteHistoryTurnFromFull = (startIndex, endIndex) => {
        let fullChatHistory = getUserData('chatHistory');
        const deletedTimestamp = fullChatHistory[startIndex].timestamp;
        fullChatHistory.splice(startIndex, (endIndex - startIndex + 1)); 
        setUserData('chatHistory', fullChatHistory);
        if (currentChatSession.length > 0 && currentChatSession[0].timestamp === deletedTimestamp) {
            currentChatSession = [];
            renderChatHistoryToDOM([]);
        }
        populateHistoryViewIncommandBar(); 
        showTemporaryToast("Conversation turn deleted.");
        if (fullChatHistory.length === 0) { body.classList.remove('chats-active'); setActiveNavButton(homeBtn, commandBar); }
    };
    
    if(historyClearAllBtnIncommandBar) historyClearAllBtnIncommandBar.addEventListener('click', () => { if (confirm("Are you sure?")) clearAllChatHistory(); });

    const populateNoticesViewIncommandBar = () => {
        if (!noticesView) return;
        noticesView.innerHTML = ''; 

        const header = document.createElement('div');
        header.className = 'galvan-notice-list-view-header';
        header.textContent = `Galvan UI 8.5`;
        noticesView.appendChild(header);

        const noticeGroup = document.createElement('div');
        noticeGroup.classList.add('galvan-notice-version-group');
        noticeGroup.innerHTML = `
            <h3>(Major Update)</h3>
            <ul>
                <li><strong>New Liquid Animations:</strong> Introducting a new liquid animation with advanced customisations to make your UI your Way.</li>
                <li><strong>Dynamic Design:</strong> Worked on a more personalised liquid glass way search and command bar that looook's awesome</li>
                <li><strong>Enhanced Lock Screen:</strong> The PIN lock screen now features a more elegant, fluid, and optimized liquid glass animations.</li>
                <li><strong>Liquid inspired Histoy and more:</strong>Liquid glass added new ui and personalised look in the new history panel.</li>
                <li><strong>Great! Optimizations:</strong> Improved scrolling and animation performance across the app for a slicker experience and introduced smoooothy way to use with new glass animations.</li>
            </ul>`;
        noticesView.appendChild(noticeGroup);
    };

    const checkUnreadNotices = () => {
        let lastSeenVersion = getUserData('lastSeenNotice') || "0.0.0";
        const hasUnread = CURRENT_APP_VERSION_FOR_NOTICE !== lastSeenVersion;
        
        [noticeNavBtn, commandBarExpandedTopNav.querySelector('#notice-btn-cloned')].forEach(btn => {
            if (btn) btn.classList.toggle('has-unread-notice', hasUnread);
        });
    };
    
    const addPressAndHoldListener = (messageDiv) => {
        let pressTimer = null;
        const startPress = (e) => {
            if (e.type === 'touchstart') e.preventDefault();
            isLongPress = false;
            pressTimer = setTimeout(() => {
                isLongPress = true;
                messageBeingEditedTimestamp = messageDiv.dataset.timestamp;
                const textElement = messageDiv.querySelector('.galvan-message-text');
                if (textElement) {
                    const historyEntry = currentChatSession.find(entry => String(entry.timestamp) === messageBeingEditedTimestamp);
                    const rawTextToEdit = historyEntry?.parts?.find(p => p.text)?.text || textElement.textContent.trim();
                    promptInput.value = rawTextToEdit; promptInput.focus(); promptInput.dispatchEvent(new Event('input')); 
                    showTemporaryToast("Editing message.");
                    messageDiv.style.outline = `2px dashed var(--current-icon-active)`; 
                }
            }, 700);
        };
        const cancelPress = () => {
            clearTimeout(pressTimer);
            if (isLongPress) {
                setTimeout(() => { if (messageDiv.dataset.timestamp !== messageBeingEditedTimestamp) { messageDiv.style.outline = 'none'; }}, 1000);
            }
        };
        messageDiv.addEventListener('mousedown', startPress);
        messageDiv.addEventListener('mouseup', cancelPress);
        messageDiv.addEventListener('mouseleave', cancelPress);
        messageDiv.addEventListener('touchstart', startPress, { passive: false });
        messageDiv.addEventListener('touchend', cancelPress);
        messageDiv.addEventListener('touchcancel', cancelPress);
    };

    const createMessageElement = (htmlContent, ...classes) => {
         const div = document.createElement("div"); div.classList.add("galvan-message", ...classes);
         if (!htmlContent.startsWith('<div class="galvan-message-text">') && !htmlContent.startsWith('<p class="galvan-message-text">')) {
            htmlContent = `<div class="galvan-message-text">${htmlContent}</div>`;
         }
         div.innerHTML = `<div class="galvan-message-content"><div class="galvan-message-bubble">${htmlContent}</div></div>`;
         div.dataset.timestamp = Date.now(); div.style.animationDelay = `${messageCounter * 0.13}s`;
         messageCounter = (messageCounter + 1) % 7; return div;
    };
    
    const clearThinkingAnimations = (textElement) => {
        clearTimeout(thinkingTimeout);
        if (textElement) {
            const dots = textElement.querySelector('.galvan-thinking-dots-pulse');
            const stage = textElement.querySelector('.galvan-thinking-stage-text');
            if (dots) dots.style.display = 'none';
            if (stage) stage.innerHTML = '';
            if (body.classList.contains('hide-ai-thoughts') && textElement.classList.contains('js-thinking-placeholder')) {
                textElement.classList.remove('js-thinking-placeholder');
            }
        }
    };
    
    const showThinkingStages = (textElement) => {
        clearThinkingAnimations(textElement); 
        const showThoughts = getUserData('showAiThoughts');
        if (!showThoughts) { 
            textElement.innerHTML = ''; 
            textElement.classList.add('js-thinking-placeholder'); 
            return; 
        }
        
        let dotsPulse = textElement.querySelector('.galvan-thinking-dots-pulse');
        if (!dotsPulse) {
            dotsPulse = document.createElement('div');
            dotsPulse.className = 'galvan-thinking-dots-pulse';
            dotsPulse.innerHTML = '<span></span><span></span><span></span>';
            textElement.insertBefore(dotsPulse, textElement.firstChild);
        }
        dotsPulse.style.display = 'inline-flex'; 

        const stages = [ "Analyzing...", "Thinking...", "Consulting...", "Processing...", "Formulating...", "Cross-referencing...", "Evaluating...", "Refining...", "Engaging...", "Synthesizing...", "Verifying...", "Constructing...", "Searching...", "Working...", "Deep diving...", "Unpacking...", "Exploring...", "Considering...", "Gathering...", "Compiling...", "Structuring...", "Checking...", "Perfecting...", "Just a moment...", "Deducing...", "Calculating...", "Reasoning...", "Connecting...", "Digging...", "Uncovering...", "Crafting...", "Let me think...", "Deliberating...", "Investigating...", "Probing...", "Examining...", "Sifting...", "Concentrating...", "Focusing...", "Accessing models...", "Querying algorithms...", "Applying power...", "One moment...", "Reflecting...", "Developing...", "Brewing ideas...", "Gears turning...", "Seeking outcome...", "Finalizing...", "Preparing...", "Almost there..." ];
        let stageIndex = Math.floor(Math.random() * stages.length);
        
        let stageTextContainer = textElement.querySelector('.galvan-thinking-stage-text');
        if (!stageTextContainer) {
            stageTextContainer = document.createElement('span');
            stageTextContainer.className = 'galvan-thinking-stage-text';
            textElement.appendChild(stageTextContainer);
        }
        stageTextContainer.style.display = 'inline-block'; 
        
        const updateStage = () => {
            const showThoughtsCurrent = getUserData('showAiThoughts');
            if (!textElement.closest('.loading') || !showThoughtsCurrent) { 
                clearThinkingAnimations(textElement); return; 
            }
            stageTextContainer.innerHTML = ''; const currentStageText = stages[stageIndex]; const words = currentStageText.split(/(\s+)/);
            words.forEach((word, i) => { if (word.trim() === '') stageTextContainer.appendChild(document.createTextNode(word)); else { const span = document.createElement('span'); span.textContent = word; span.classList.add('elastic-span'); span.style.animationDelay = `${i * 0.035}s`; stageTextContainer.appendChild(span); }});
            stageIndex = (stageIndex + 1) % stages.length; thinkingTimeout = setTimeout(updateStage, 2200 + Math.random() * 1300);
        }; updateStage();
    };
    
    const typingEffect = (rawText, textElement, botMsgDiv, addActions = true) => {
        clearThinkingAnimations(textElement);
        textElement.innerHTML = "";
        botMsgDiv.classList.remove("loading");
    
        const renderedHtml = parseMarkdownToHTML(rawText);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = renderedHtml;
        const allNodes = Array.from(tempDiv.childNodes);
        
        let nodeIndex = 0;
        let charIndex = 0;
        
        function typeNext() {
            if (controller && controller.signal.aborted) {
                resetSendButton();
                return;
            }
            if (nodeIndex >= allNodes.length) {
                if (addActions) addResponseActionButtons(botMsgDiv);
                resetSendButton();
                saveFullChatHistory();
                requestAnimationFrame(() => scrollToBottom("smooth")); 
                return;
            }
            
            const node = allNodes[nodeIndex];
            
            if (node.nodeType === Node.TEXT_NODE) {
                if (charIndex < node.textContent.length) {
                    const span = document.createElement('span');
                    span.textContent = node.textContent[charIndex];
                    span.className = 'elastic-span';
                    textElement.appendChild(span);
                    charIndex++;
                } else {
                    nodeIndex++;
                    charIndex = 0;
                }
            } else { // Element node
                textElement.appendChild(node);
                nodeIndex++;
            }
            
            if (charIndex % 5 === 0) {
                scrollToBottom("auto");
            }

            typingInterval = setTimeout(typeNext, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--typing-speed') || '15'));
        }
    
        typingInterval = setTimeout(typeNext, 0);
    };

    const getResponseActionSVG = (action) => {
        const svgs = { like: '<svg viewBox="0 0 24 24"><path d="M7 10.29V20s0 .55.44.83c.41.26.91.37 1.52.37H17.5c.91 0 1.69-.55 1.95-1.33l2.47-7.81C22.06 11.63 22 11.3 22 11V9c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L12.17 0 6.58 6.59A1.93 1.93 0 006 7.99V18H3V7.99A1.93 1.93 0 013.42 7c.03 0 .05-.01.08-.01L4 7h3v3.29z" fill-rule="evenodd"/></svg>', dislike: '<svg viewBox="0 0 24 24"><path d="M17 13.71V4s0-.55-.44-.83c-.41-.26-.91-.37-1.52-.37H6.5c-.91 0-1.69.55-1.95 1.33L2.08 12.19C1.94 12.37 2 12.7 2 13v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41-.17-.79-.44 1.06L11.83 24l5.59-6.59A1.93 1.93 0 0018 16.01V6h3v10.01c0 .08-.01.16-.01.23L20 16h-3v-2.29z" fill-rule="evenodd"/></svg>', copy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>', refresh: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>', copied_check: '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>' }; return svgs[action] || '';
    }
    const addResponseActionButtons = (botMsgDiv) => {
        const messageContent = botMsgDiv.querySelector('.galvan-message-content'); if (!messageContent || messageContent.querySelector('.galvan-ai-response-actions')) return;
        const actionsDiv = document.createElement('div'); actionsDiv.classList.add('galvan-ai-response-actions'); let userMessageTimestamp = null; let currentElement = botMsgDiv;
        while (currentElement.previousElementSibling) { currentElement = currentElement.previousElementSibling; if (currentElement.classList.contains('user-message') && currentElement.dataset.timestamp) { userMessageTimestamp = currentElement.dataset.timestamp; break; }}
        const regenerateButtonHTML = userMessageTimestamp ? `<button class="galvan-response-action-button" data-action="regenerate" data-user-msg-timestamp="${userMessageTimestamp}" aria-label="Regenerate response">${getResponseActionSVG('refresh')}</button>` : '';
        actionsDiv.innerHTML = `<button class="galvan-response-action-button" data-action="like" aria-label="Like response">${getResponseActionSVG('like')}</button><button class="galvan-response-action-button" data-action="dislike" aria-label="Dislike response">${getResponseActionSVG('dislike')}</button><button class="galvan-response-action-button" data-action="copy" aria-label="Copy response">${getResponseActionSVG('copy')}</button>${regenerateButtonHTML}`;
        const bubble = messageContent.querySelector('.galvan-message-bubble'); if (bubble) { bubble.insertAdjacentElement('afterend', actionsDiv); actionsDiv.querySelectorAll('.galvan-response-action-button').forEach(button => button.addEventListener('click', handleResponseActionClick));}
    };
    const handleResponseActionClick = (e) => {
        const button = e.currentTarget; const action = button.dataset.action; const messageDiv = button.closest('.galvan-message'); const botMsgDivToFade = button.closest('.bot-message'); 
        let responseText = ''; if (messageDiv && messageDiv.dataset.timestamp) { const historyEntry = currentChatSession.find(entry => String(entry.timestamp) === messageDiv.dataset.timestamp && entry.role === 'model'); responseText = historyEntry?.parts?.find(p => p.text)?.text || messageDiv.querySelector('.galvan-message-text')?.textContent.trim() || ''; }
        if (action === 'like' || action === 'dislike') { const otherAction = action === 'like' ? 'dislike' : 'like'; const otherButton = messageDiv?.querySelector(`.galvan-response-action-button[data-action="${otherAction}"]`); const wasActive = button.classList.contains(action === 'like' ? 'liked' : 'disliked'); button.classList.remove('liked', 'disliked'); otherButton?.classList.remove('liked', 'disliked'); if (!wasActive) { button.classList.add(action === 'like' ? 'liked' : 'disliked'); button.style.transform = 'scale(1.35)'; setTimeout(() => button.style.transform = 'scale(1)', 280); } else { button.style.transform = 'scale(0.8)'; setTimeout(() => button.style.transform = 'scale(1)', 220); }}
        else if (action === 'copy' && responseText) { navigator.clipboard.writeText(responseText).then(() => { const originalIconHTML = button.innerHTML; const iconColor = getComputedStyle(document.documentElement).getPropertyValue('--current-like-color'); button.innerHTML = getResponseActionSVG('copied_check'); const checkSVG = button.querySelector('svg'); if (checkSVG) checkSVG.style.fill = iconColor; showTemporaryToast("Copied to clipboard"); setTimeout(() => { button.innerHTML = originalIconHTML; }, 1900); }).catch(err => { console.error('Failed to copy text: ', err); showTemporaryToast("Copy failed!"); });}
        else if (action === 'regenerate' && botMsgDivToFade) {
            if (body.classList.contains("bot-responding")) return; const userMsgTimestamp = button.dataset.userMsgTimestamp; if (!userMsgTimestamp) { console.error("Regen failed: No user message timestamp."); return; }
            let userMsgIndexInSession = currentChatSession.findIndex(entry => String(entry.timestamp) === userMsgTimestamp && entry.role === 'user');
            if (userMsgIndexInSession !== -1) {
                botMsgDivToFade.classList.add('message-regenerating-out'); 
                setTimeout(() => { if (botMsgDivToFade.parentNode) botMsgDivToFade.remove(); }, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--message-regen-out-duration') || '0.4') * 1000);
                
                let fullHistory = getUserData('chatHistory');
                const userMsgIndexInFull = fullHistory.findIndex(entry => String(entry.timestamp) === userMsgTimestamp && entry.role === 'user');
                if (userMsgIndexInFull !== -1) fullHistory.splice(userMsgIndexInFull + 1);

                currentChatSession.splice(userMsgIndexInSession + 1); 
                setUserData('chatHistory', fullHistory);
                
                setSendButtonState('stop'); messageCounter = 0; 
                const newBotMsgDiv = createMessageElement(`<div class="galvan-message-text"></div>`, "bot-message", "loading");
                chatsContainer.appendChild(newBotMsgDiv); scrollToBottom();
                const contextForApi = [...currentChatSession]; 
                if (IS_API_KEY_VALID) generateResponse_API(newBotMsgDiv, contextForApi); 
                else { const targetUserEntry = currentChatSession[userMsgIndexInSession]; const userTextPart = targetUserEntry.parts.find(p => p.text); const userFilePart = targetUserEntry.parts.find(p => p.fileData); simulateAIResponse_Simulated(userTextPart?.text || "", userFilePart?.fileData, newBotMsgDiv, contextForApi); }
            } else { console.error("Regen failed: Could not find user prompt in current session."); showTemporaryToast("Regeneration failed."); }
        }
    };

    const stopResponseGeneration = () => {
        if (!body.classList.contains("bot-responding")) return;
        controller?.abort(); 
        if (typingInterval) { clearTimeout(typingInterval); typingInterval = null; }
        const loadingMsg = chatsContainer.querySelector(".bot-message.loading");
        if (loadingMsg) { 
            const textElement = loadingMsg.querySelector(".galvan-message-text");
            clearThinkingAnimations(textElement); 
            loadingMsg.classList.remove("loading"); 
            if (textElement && textElement.innerHTML.trim() === "") { 
                 textElement.innerHTML = "Stopped."; 
                 textElement.style.color = getComputedStyle(document.documentElement).getPropertyValue('--current-error-text'); 
            }
            if (!loadingMsg.querySelector('.galvan-ai-response-actions')) addResponseActionButtons(loadingMsg); 
        } else { 
            const lastBotMsg = Array.from(chatsContainer.querySelectorAll(".bot-message")).pop(); 
            if(lastBotMsg && !lastBotMsg.querySelector('.galvan-ai-response-actions')) addResponseActionButtons(lastBotMsg); 
        }
        resetSendButton(); scrollToBottom('auto');
    };

    const setSendButtonState = (state) => {
        if (state === 'stop') { sendBtn.classList.add('stop-active'); sendBtn.disabled = false; sendBtn.setAttribute('aria-label', 'Stop generating'); body.classList.add("bot-responding"); promptWrapper.classList.add("processing"); promptInput.disabled = true; addFileBtn.disabled = true; }
        else { sendBtn.classList.remove('stop-active'); sendBtn.disabled = (promptInput.value.trim() === '' && !userData.file.data); sendBtn.setAttribute('aria-label', 'Send message'); body.classList.remove("bot-responding"); promptWrapper.classList.remove("processing"); promptInput.disabled = false; addFileBtn.disabled = false; }
    };
    const resetSendButton = () => { setSendButtonState('send'); };

    const generateResponse_API = async (botMsgDiv, contextHistory) => {
         if (!IS_API_KEY_VALID) return;
         const textElement = botMsgDiv.querySelector(".galvan-message-text");
         if (!textElement) { console.error("API Error: Text element missing."); botMsgDiv.remove(); resetSendButton(); return; }
         controller = new AbortController(); 
         showThinkingStages(textElement);
         try {
             const apiHistory = contextHistory.map(entry => ({ role: entry.role, parts: entry.parts.map(part => part.fileData ? { inline_data: { mime_type: part.fileData.mime_type, data: part.fileData.data }} : part)}));
             const requestBody = { contents: apiHistory, generationConfig: { temperature: 0.7, topK: 40, topP: 0.95 } }; 
             const response = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json", "Accept": "application/json" }, body: JSON.stringify(requestBody), signal: controller.signal }); 
             
             if (controller.signal.aborted) return; 
             clearThinkingAnimations(textElement); 

             if (!response.ok) { let errorMsg = `API Error (${response.status})`; let errorDetails = ""; try { const errorData = await response.json(); console.error("API Error Data:", errorData); errorDetails = errorData.error?.message || JSON.stringify(errorData.error); if (errorDetails) errorMsg += `: ${errorDetails}`; } catch (e) { try { const textError = await response.text(); console.error("API Error Text:", textError); errorMsg += ` - ${textError.substring(0, 100)}`; } catch (textE) {} } throw new Error(errorMsg); }
             const data = await response.json();
             if (data.promptFeedback?.blockReason) throw new Error(`Content blocked: ${data.promptFeedback.blockReason}`);
             const candidate = data.candidates?.[0];
             const responseText = candidate?.content?.parts?.[0]?.text?.trim() ?? null;
             
             if (responseText === null) {
                 const finishReason = candidate?.finishReason;
                 if (finishReason && finishReason !== "STOP") throw new Error(`Response stopped: ${finishReason}.`);
                 throw new Error("Invalid or empty response from API.");
             }

             const modelEntry = { role: "model", parts: [{ text: responseText }], timestamp: Date.now() }; 
             currentChatSession.push(modelEntry);
             let fullHistory = getUserData('chatHistory') || [];
             fullHistory.push(modelEntry);
             setUserData('chatHistory', fullHistory);
             
             typingEffect(responseText, textElement, botMsgDiv, true);
         } catch (error) { 
            if (error.name === 'AbortError') return;
            console.error("API Processing Failed:", error); 
            clearThinkingAnimations(textElement); 
            if (typingInterval) { clearTimeout(typingInterval); typingInterval = null; } 
            botMsgDiv.classList.remove("loading"); 
            textElement.innerHTML = `Error: ${escapeHtml(error.message)}`; 
            textElement.style.color = getComputedStyle(document.documentElement).getPropertyValue('--current-error-text'); 
            addResponseActionButtons(botMsgDiv);
         } finally { 
            if (!controller.signal.aborted) { resetSendButton(); } 
            controller = null; 
        }
    };
    const simulateAIResponse_Simulated = (prompt, fileInfo, botMsgDiv, contextHistory) => {
        const textElement = botMsgDiv.querySelector('.galvan-message-text');
        setSendButtonState('stop'); 
        showThinkingStages(textElement); 
        const delay = 400 + Math.random() * 500;
        thinkingTimeout = setTimeout(() => { 
            if (controller && controller.signal.aborted) return; 
            if (body.classList.contains("bot-responding")) { 
                clearThinkingAnimations(textElement); 
                let answer = `Simulated answer for "${prompt || 'your thoughtful query'}"`; 
                if (fileInfo && fileInfo.fileName) answer += ` with the attached file *${fileInfo.fileName}*`; 
                const randomAnswers = [ `${answer}.\n\nThis is a **carefully crafted** (simulated) response.\nMy _(pretend)_ algorithms have analyzed this request extensively.\n\nHere's a sample code block:\n\`\`\`javascript\nfunction greet(name) {\n  console.log(\`Hello, \${name}!\`); // Template literal example\n}\ngreet("User");\n\`\`\`\n\n## More Details\n\n*   Point one about AI.\n*   Point two about simulation.\n    *   Nested sub-point for fun.\n\n1.  Ordered item 1: AI is fascinating.\n2.  Ordered item 2: Simulation helps testing.\n\n> This is a blockquote to make a simulated point stand out.\n\nCheck out [this example link](https://example.com) for more.\n\n---\n\nThat's all for this simulated response! Feel free to ask more.`, `${answer}? An excellent question. After (simulated) \`deep learning\` cycles, here's my synthesized insight.\n\n![Simulated Placeholder Image](https://via.placeholder.com/200x100/007bff/FFFFFF?Text=Simulated+Visual) \n\n### Key Takeaways:\n- Simulation is key.\n- AI can learn (even in pretend scenarios).\n- More data would (theoretically) improve this response.`, `${answer}... Processing...\n\nMy simulated **neural network** (which is just code, _really_) suggests the following.\n\n#### Sub-Section A\nSome detailed points here.\n\n##### Sub-Sub-Section B\nEven more granular points.\n\n\`\`\`python\n# This is a Python code block example\ndef main():\n    print("Simulating Python!")\n\nif __name__ == "__main__":\n    main()\n\`\`\`\n\nThat concludes this simulation section.` ]; 
                const chosenAnswer = randomAnswers[Math.floor(Math.random() * randomAnswers.length)]; 
                
                const modelEntry = { role: "model", parts: [{ text: chosenAnswer }], timestamp: Date.now() }; 
                currentChatSession.push(modelEntry);
                let fullHistory = getUserData('chatHistory') || [];
                fullHistory.push(modelEntry);
                setUserData('chatHistory', fullHistory);

                typingEffect(chosenAnswer, textElement, botMsgDiv, true); 
            }
        }, delay);
    };

    const handleFormSubmit = (e) => {
         e.preventDefault(); 
         if (sendBtn.classList.contains('stop-active')) { stopResponseGeneration(); return; }
         
         const userMessageText = promptInput.value.trim(); 
         if (!userMessageText && !userData.file.data) return;
         if (!body.classList.contains('chats-active')) body.classList.add("chats-active");
         if (!body.classList.contains('suggestions-scrolled')) body.classList.add('suggestions-scrolled');

         const fileToSend = userData.file.data ? { ...userData.file } : null;
         
         let fullHistory = getUserData('chatHistory') || [];
         
         if (messageBeingEditedTimestamp || promptHistoryIndex !== -1) {
            let editTimestamp;
            if (messageBeingEditedTimestamp) {
                editTimestamp = messageBeingEditedTimestamp;
            } else {
                editTimestamp = userPromptsHistory[promptHistoryIndex]?.timestamp;
            }

            if (editTimestamp) {
                const editIndexFull = fullHistory.findIndex(entry => String(entry.timestamp) === String(editTimestamp) && entry.role === 'user');
                if (editIndexFull !== -1) {
                    fullHistory.splice(editIndexFull + 1); 
                }
                const editIndexSession = currentChatSession.findIndex(entry => String(entry.timestamp) === String(editTimestamp) && entry.role === 'user');
                if (editIndexSession !== -1) {
                    currentChatSession.splice(editIndexSession + 1);
                }
            }
         }

         const turnTimestamp = Date.now();
         const userHistoryEntry = { role: "user", parts: [], timestamp: turnTimestamp }; 
         if (userMessageText) userHistoryEntry.parts.push({ text: userMessageText }); 
         if (fileToSend) userHistoryEntry.parts.push({ fileData: { fileName: fileToSend.fileName, mime_type: fileToSend.mime_type, data: fileToSend.data }}); 
         currentChatSession.push(userHistoryEntry); 
         fullHistory.push(userHistoryEntry);
         
         if (messageBeingEditedTimestamp) {
             const originalMsgDiv = Array.from(chatsContainer.querySelectorAll('.user-message')).find(div => div.dataset.timestamp === messageBeingEditedTimestamp);
             if(originalMsgDiv) originalMsgDiv.style.outline = 'none';
         }

         renderChatHistoryToDOM(currentChatSession);
         
         setUserData('chatHistory', fullHistory);
         setActiveNavButton(mainHistoryNavBtn, commandBar);
         scrollToBottom('auto'); promptInput.value = ""; promptInput.style.height = 'auto'; 
         fileUploadWrapper.classList.remove("active"); userData.file = {}; resetSendButton();
         
         messageBeingEditedTimestamp = null;
         promptHistoryIndex = -1;
         updatePromptNavButtons();
         
         setSendButtonState('stop');
         setTimeout(() => { 
            const botMsgDiv = createMessageElement(`<div class="galvan-message-text"></div>`, "bot-message", "loading"); 
            chatsContainer.appendChild(botMsgDiv); scrollToBottom(); 
            if (IS_API_KEY_VALID) generateResponse_API(botMsgDiv, [...currentChatSession]); 
            else simulateAIResponse_Simulated(userMessageText, fileToSend, botMsgDiv, [...currentChatSession]);
        }, 50);
    };
    promptForm.addEventListener("submit", handleFormSubmit);

    // --- NEW: Prompt History Navigation Logic ---
    const updatePromptNavButtons = () => {
        userPromptsHistory = currentChatSession.filter(m => m.role === 'user');
        const hasHistory = userPromptsHistory.length > 0;
        promptNavButtonsContainer.classList.toggle('visible', hasHistory);

        if (!hasHistory) {
            promptHistoryIndex = -1;
            return;
        }
        
        // If current index is out of bounds (e.g., after deleting history), reset it.
        if (promptHistoryIndex >= userPromptsHistory.length) {
            promptHistoryIndex = userPromptsHistory.length -1;
        }

        promptNavUpBtn.disabled = promptHistoryIndex === 0;
        promptNavDownBtn.disabled = promptHistoryIndex === -1 || promptHistoryIndex === userPromptsHistory.length - 1;
    };

    const navigatePromptHistory = (direction) => {
        if (userPromptsHistory.length === 0) return;

        if (promptHistoryIndex === -1) {
            // If starting from a new prompt, go to the last one
            promptHistoryIndex = userPromptsHistory.length - 1;
        } else {
            promptHistoryIndex += direction;
        }

        // Clamp the index
        if (promptHistoryIndex < 0) promptHistoryIndex = 0;
        if (promptHistoryIndex >= userPromptsHistory.length) promptHistoryIndex = userPromptsHistory.length - 1;

        const promptToShow = userPromptsHistory[promptHistoryIndex];
        if (promptToShow) {
            const textPart = promptToShow.parts.find(p => p.text);
            promptInput.value = textPart ? textPart.text : "";
            promptInput.dispatchEvent(new Event('input')); // To resize textarea
        }
        
        updatePromptNavButtons();
    };
    
    promptNavUpBtn.addEventListener('click', () => navigatePromptHistory(-1));
    promptNavDownBtn.addEventListener('click', () => navigatePromptHistory(1));
    
    promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp' && promptInput.selectionStart === 0) {
            e.preventDefault();
            navigatePromptHistory(-1);
        } else if (e.key === 'ArrowDown' && promptInput.selectionStart === promptInput.value.length) {
            e.preventDefault();
            navigatePromptHistory(1);
        } else {
            // Any other key press resets the navigation
            promptHistoryIndex = -1;
            updatePromptNavButtons();
        }
    });


    const getFileIconSVG = (mimeType, fileName = '') => { const genericFileSVG = '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>'; if (!mimeType) return genericFileSVG; if (mimeType.startsWith('image/')) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>'; if (mimeType === 'application/pdf') return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm11.5 1.5h1v-1h-1v1z"/></svg>'; if (mimeType.startsWith('text/')) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>'; if (mimeType.includes('spreadsheet') || mimeType.includes('excel') || /\.(xlsx?|csv|numbers)$/i.test(fileName)) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-4h2v4zm4 0h-2v-4h2v4zm4 0h-2v-4h2v4zm0-6H7V7h10v4z"/></svg>'; if (mimeType.includes('presentation') || mimeType.includes('powerpoint') || /\.(pptx?|key)$/i.test(fileName)) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M4 3h16c.55 0 1 .45 1 1v16c0 .55-.45 1-1 1H4c-.55 0-1-.45-1-1V4c0-.55.45-1 1-1zm10 8.41L12.41 10 11 11.41 12.59 13 11 14.59 12.41 16 14 14.41 15.59 16 17 14.59 15.41 13 17 11.41 15.59 10 14 11.41zM6 5h2v2H6V5zm0 4h2v2H6V9zm0 4h2v2H6v-2zm0 4h2v2H6v-2z"/></svg>'; if (mimeType.includes('document') || mimeType.includes('word') || /\.(docx?|rtf|pages)$/i.test(fileName)) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>'; if (mimeType.startsWith('audio/')) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>'; if (mimeType.startsWith('video/')) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M18 3v2h-2V3H8v2H6V3H4v18h2v-2h2v2h8v-2h2v2h2V3h-2zM8 17H6v-2h2v2zm0-4H6v-2h2v2zm0-4H6V7h2v2zm10 8h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/></svg>'; if (mimeType.includes('zip') || mimeType.includes('compressed') || /\.(zip|rar|7z)$/i.test(fileName)) return '<svg viewBox="0 0 24 24" class="file-icon-svg"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V6h5.17l2 2H20v10zm-8-4h2v2h-2v-2zm-4 0h2v2h-2v-2zm8 0h2v2h-2v-2z"/></svg>'; return genericFileSVG; };
    fileInput.addEventListener("change", () => { const file = fileInput.files[0]; if (!file) return; const MAX_FILE_SIZE = 15 * 1024 * 1024; if (file.size > MAX_FILE_SIZE) { showTemporaryToast(`File exceeds ${MAX_FILE_SIZE / 1024 / 1024}MB limit.`); fileInput.value = ""; return; } const isImage = file.type.startsWith("image/"); const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const base64String = e.target.result.split(",")[1]; const safeFileName = file.name.replace(/</g, "<").replace(/>/g, ">"); fileNameElement.textContent = safeFileName; if (isImage) { filePreviewImage.src = e.target.result; filePreviewImage.style.display = 'block'; filePreviewIconSVG.style.display = 'none'; } else { filePreviewIconSVG.innerHTML = getFileIconSVG(file.type, file.name); filePreviewImage.style.display = 'none'; filePreviewIconSVG.style.display = 'inline-block'; } fileUploadWrapper.classList.add("active"); userData.file = { fileName: file.name, data: base64String, mime_type: file.type || 'application/octet-stream', isImage }; if (!body.classList.contains("bot-responding")) sendBtn.disabled = false; fileInput.value = ""; }; reader.onerror = (e) => { console.error("File reading error:", e); showTemporaryToast("Error reading file."); fileInput.value = ""; fileUploadWrapper.classList.remove("active"); userData.file = {}; if (!body.classList.contains("bot-responding")) sendBtn.disabled = promptInput.value.trim() === ''; } });
    addFileBtn.addEventListener("click", () => { if(addFileBtn.disabled || !getUserData('enableAttachments')) return; fileInput.click(); });
    cancelFileBtn.addEventListener("click", () => { userData.file = {}; fileUploadWrapper.classList.remove("active"); if (!body.classList.contains("bot-responding")) sendBtn.disabled = promptInput.value.trim() === ''; });
    
    promptInput.addEventListener('input', () => { 
        promptInput.style.height = 'auto'; 
        const scrollHeight = promptInput.scrollHeight; 
        const maxHeight = parseInt(getComputedStyle(promptInput).maxHeight) || 100; 
        promptInput.style.height = Math.min(scrollHeight, maxHeight) + 'px'; 
        if (!body.classList.contains("bot-responding")) sendBtn.disabled = promptInput.value.trim() === '' && !userData.file.data;
        
        // ADD THIS LINE
        promptWrapper.classList.toggle('has-text', promptInput.value.trim() !== '' || userData.file.data);
    });
    
    sendBtn.disabled = promptInput.value.trim() === '' && !userData.file.data;

    const setActiveNavButton = (activeBtn, navGroupEl) => { 
        if (!navGroupEl) return;
        navGroupEl.querySelectorAll('.galvan-nav-btn').forEach(btn => btn.classList.remove('active'));
        if (activeBtn) activeBtn.classList.add('active');

        const homeButtonInGroup = navGroupEl.querySelector('#home-btn') || navGroupEl.querySelector('#home-btn-cloned');
        if (homeButtonInGroup) {
             const isHomeActive = activeBtn === homeButtonInGroup;
             const currentHomeFilled = homeButtonInGroup.querySelector('.icon-home-filled');
             const currentHomeOutline = homeButtonInGroup.querySelector('.icon-home-outline');
             if(currentHomeFilled) currentHomeFilled.style.display = isHomeActive ? 'block' : 'none';
             if(currentHomeOutline) currentHomeOutline.style.display = isHomeActive ? 'none' : 'block';
        }
    };

    const opencommandBarExpandedView = (viewName, triggeredByMainBarButton = null) => {
        if (commandBarContainer.classList.contains('expanded') && activecommandBarView === viewName && triggeredByMainBarButton === activecommandBarMainButtonOpener) {
            closecommandBarExpandedView(); return;
        }
        commandBarContainer.classList.add('expanded'); body.classList.add('command-bar-expanded');
        populateExpandedTopNav(); 
        [settingsView, historyView, noticesView].forEach(v => { if (v) { v.classList.remove('active-view'); v.style.display = 'none'; }});
        
        activecommandBarMainButtonOpener = triggeredByMainBarButton;
        let targetView, activeTopNavButtonId;
        
        commandBarContainer.classList.toggle('settings-view-active', viewName === 'settings');

        switch(viewName) {
            case 'history':
                targetView = historyView;
                populateHistoryViewIncommandBar();
                activeTopNavButtonId = 'history-btn-cloned';
                break;
            case 'notices':
                targetView = noticesView;
                populateNoticesViewIncommandBar();
                setUserData('lastSeenNotice', CURRENT_APP_VERSION_FOR_NOTICE);
                checkUnreadNotices();
                activeTopNavButtonId = 'notice-btn-cloned';
                break;
            default: // settings
                viewName = 'settings';
                targetView = settingsView;
                activeTopNavButtonId = 'command-bar-settings-btn-cloned';
                break;
        }

        if (targetView) { 
            targetView.style.display = 'flex'; 
            requestAnimationFrame(() => targetView.classList.add('active-view')); 
            Array.from(targetView.children).forEach((child, index) => {
                child.style.animationDelay = `${0.1 + index * 0.05}s`;
            });
        }
        activecommandBarView = viewName;
        setActiveNavButton(commandBarExpandedTopNav.querySelector(`#${activeTopNavButtonId}`), commandBarExpandedTopNav);
        if (triggeredByMainBarButton) { setActiveNavButton(triggeredByMainBarButton, commandBar);
        } else { const mainBarEquivalentId = activeTopNavButtonId.replace('-cloned',''); const mainBarEquivalent = document.getElementById(mainBarEquivalentId); if(mainBarEquivalent) setActiveNavButton(mainBarEquivalent, commandBar); }
    };
    const closecommandBarExpandedView = () => {
        commandBarContainer.classList.remove('expanded', 'settings-view-active');
        body.classList.remove('command-bar-expanded');
        activecommandBarView = null; activecommandBarMainButtonOpener = null;
        if (body.classList.contains('chats-active')) { setActiveNavButton(mainHistoryNavBtn, commandBar); } 
        else { setActiveNavButton(homeBtn, commandBar); }
    };
    
    if(homeBtn) homeBtn.addEventListener("click", () => {
        if (commandBarContainer.classList.contains('expanded')) closecommandBarExpandedView();
        _goHome();
    }); 

    if(suggestionsContainer) suggestionsContainer.addEventListener('scroll', () => { clearTimeout(scrollTimeout); scrollTimeout = setTimeout(() => { body.classList.toggle('suggestions-scrolled', suggestionsContainer.scrollTop > 70); }, 50); }, { passive: true });

    const populateExpandedTopNav = () => {
        commandBarExpandedTopNav.innerHTML = '';
        const mainNavButtons = commandBar.querySelectorAll('.galvan-nav-btn');
        mainNavButtons.forEach((btn, index) => { 
            if (btn.id === 'command-bar-logo-placeholder') return;
            const clone = btn.cloneNode(true); clone.id = btn.id + "-cloned"; 
            clone.classList.remove('active'); 
            clone.style.animation = `topNavIconEnter 0.35s var(--ease-out-quint) ${0.05 * index}s forwards`;
            
            if (clone.id === 'home-btn-cloned') {
                 if(clone.querySelector('.icon-home-filled')) clone.querySelector('.icon-home-filled').style.display = 'none';
                 if(clone.querySelector('.icon-home-outline')) clone.querySelector('.icon-home-outline').style.display = 'block';
                 clone.addEventListener('click', () => { closecommandBarExpandedView(); _goHome(); });
            } else if (clone.id === 'history-btn-cloned') { clone.addEventListener('click', () => opencommandBarExpandedView('history', mainHistoryNavBtn));
            } else if (clone.id === 'notice-btn-cloned') { clone.addEventListener('click', () => opencommandBarExpandedView('notices', noticeNavBtn));
            } else if (clone.id === 'theme-toggle-btn-cloned') { clone.addEventListener('click', () => { applyLightDarkMode(!body.classList.contains("light-mode"), true); saveLightDarkModePreference(); });
            } else if (clone.id === 'command-bar-settings-btn-cloned') { clone.addEventListener('click', () => opencommandBarExpandedView('settings', commandBarSettingsBtn)); }
            commandBarExpandedTopNav.appendChild(clone);
        });
        applyLightDarkMode(currentThemeIsLight, true); checkUnreadNotices(); 
    };
    
    [mainHistoryNavBtn, noticeNavBtn, commandBarSettingsBtn].forEach(btn => {
        if (btn) {
            btn.addEventListener('click', () => {
                let viewToOpen = '';
                if (btn.id === 'history-btn') viewToOpen = 'history';
                else if (btn.id === 'notice-btn') viewToOpen = 'notices';
                else if (btn.id === 'command-bar-settings-btn') viewToOpen = 'settings';
                
                opencommandBarExpandedView(viewToOpen, btn);
            });
        }
    });

    if(settingToggleSuggestionsSwitch) settingToggleSuggestionsSwitch.addEventListener('change', (e) => { body.classList.toggle('hide-suggestions', !e.target.checked); setUserData('showSuggestions', e.target.checked); });
    if(settingToggleAIThoughtsSwitch) settingToggleAIThoughtsSwitch.addEventListener('change', (e) => { body.classList.toggle('hide-ai-thoughts', !e.target.checked); setUserData('showAiThoughts', e.target.checked); const loadingMsgText = chatsContainer.querySelector(".bot-message.loading .galvan-message-text"); if (loadingMsgText) { clearThinkingAnimations(loadingMsgText); if (body.classList.contains("bot-responding")) { showThinkingStages(loadingMsgText); } } });

    [
        { el: settingToggleAttachmentsSwitch, key: 'enableAttachments', default: true, callback: (checked) => { if(addFileBtn) addFileBtn.style.display = checked ? 'flex' : 'none'; } },
        { el: settingToggleAutoUpdateSwitch, key: 'autoUpdate', default: true },
    ].forEach(item => { if (item.el) { item.el.addEventListener('change', (e) => { setUserData(item.key, e.target.checked); if (item.callback) item.callback(e.target.checked); }); } });

    if (settingCheckUpdatesBtn) {
        settingCheckUpdatesBtn.addEventListener('click', () => {
            showTemporaryToast(`You are on ${CURRENT_APP_VERSION_FOR_NOTICE}. No new updates available.`);
        });
    }
    const performResetAll = () => {
        resetOverlay.classList.add('show');
        setTimeout(() => {
            const oldLockSettings = {
                appLockEnabled: getUserData('appLockEnabled'),
                appLockType: getUserData('appLockType'),
                appLockCode: getUserData('appLockCode'),
            };

            appSettings = { ...getDefaultSettings(), ...oldLockSettings };
            saveSettings();
            
            loadLightDarkModePreference();
            loadFontPreferences();
            loadVVShapePreference();
            loadBlurPreference();
            applyColorPalette('galvan', false);
            renderColorPaletteOptions();
            
            const defaultSettings = [
                { el: settingToggleSuggestionsSwitch, key: 'showSuggestions', class: 'hide-suggestions', inverse: true },
                { el: settingToggleAIThoughtsSwitch, key: 'showAiThoughts', class: 'hide-ai-thoughts', inverse: true },
                { el: settingToggleAttachmentsSwitch, key: 'enableAttachments', callback: (checked) => { if(addFileBtn) addFileBtn.style.display = checked ? 'flex' : 'none'; } },
                { el: settingToggleAutoUpdateSwitch, key: 'autoUpdate' },
                { el: settingToggleSystemThemeSwitch, key: 'syncWithSystemTheme' }
            ];
            
            defaultSettings.forEach(s => {
                const defaultValue = getDefaultSettings()[s.key];
                if (s.el) s.el.checked = defaultValue;
                if (s.class) body.classList.toggle(s.class, s.inverse ? !defaultValue : defaultValue);
                if (s.callback) s.callback(defaultValue);
            });

            resetOverlay.classList.remove('show');
            showTemporaryToast("Done");
        }, 1500); 
    };

    if (settingResetAllBtn) {
        settingResetAllBtn.addEventListener('click', () => {
            if (confirm("Reset Everything?")) {
                performResetAll();
            }
        });
    }

    const applyColorPalette = (paletteId, savePreference = true) => {
        const palette = COLOR_PALETTES.find(p => p.id === paletteId);
        const rootStyle = document.documentElement.style;
    
        ['light', 'dark'].forEach(mode => {
            Object.keys(paletteVariableMap).forEach(paletteKeyInJS => {
                const cssSuffix = paletteVariableMap[paletteKeyInJS];
                const cssVarName = `--app-${cssSuffix}-${mode}`;
                let valueToSet;
                
                if (palette && !palette.isDefault && palette[mode] && palette[mode][paletteKeyInJS] !== undefined) {
                    valueToSet = palette[mode][paletteKeyInJS];
                } else {
                    valueToSet = baseThemeVariables[mode][cssVarName] || '';
                }
                rootStyle.setProperty(cssVarName, valueToSet);
            });
        });
        
        const currentIsLight = body.classList.contains('light-mode');
        body.classList.remove('light-mode');
        requestAnimationFrame(() => body.classList.add(currentIsLight ? 'light-mode' : 'dark-mode'));
    
        if (savePreference) {
            setUserData('colorPalette', paletteId);
        }
        renderColorPaletteOptions();
    };

    const renderColorPaletteOptions = () => {
        if (!colorPaletteOptionsContainer) return;
        colorPaletteOptionsContainer.innerHTML = '';
        const activePaletteId = getUserData('colorPalette') || 'galvan';

        COLOR_PALETTES.forEach(palette => {
            const btn = document.createElement('button');
            btn.classList.add('galvan-color-palette-item');
            if (palette.id === activePaletteId) btn.classList.add('active-palette');
            btn.dataset.paletteId = palette.id;
            
            const p = palette.preview;
            const preview = document.createElement('div');
            preview.className = 'galvan-palette-preview-wrapper';
            preview.style.backgroundColor = p.bg;

            preview.innerHTML = `
                <div class="preview-bubble" style="background: ${p.bubble};">Hello!</div>
                <div class="preview-accent-bar">
                    <span style="background-color: ${p.accent1};"></span>
                    <span style="background-color: ${p.accent2};"></span>
                </div>
            `;
            
            const name = document.createElement('div');
            name.classList.add('galvan-palette-name');
            name.textContent = palette.name;
            
            btn.appendChild(preview);
            btn.appendChild(name);
            btn.addEventListener('click', () => {
                applyColorPalette(palette.id, true); 
                showTemporaryToast(`${palette.name} selected.`);
            });
            colorPaletteOptionsContainer.appendChild(btn);
        });
    };

     const DEFAULT_SUGGESTIONS = [
        { id: `default_1`, text: 'A story on AI', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>' },
        { id: `default_2`, text: 'Get me app idea', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline><line x1="10" y1="20" x2="14" y2="4"></line></svg>' },
        { id: `default_3`, text: 'Explain AI', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>' },
        { id: `default_4`, text: 'Plan a trip', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>' },
    ];

    const getSuggestions = () => {
        const custom = getUserData('customSuggestions') || [];
        return [...custom, ...DEFAULT_SUGGESTIONS];
    };

    const renderSuggestions = () => {
        if (!suggestionsContainer) return;
        suggestionsContainer.innerHTML = '';
        const allSuggestions = getSuggestions();

        allSuggestions.forEach(suggestion => {
            const isCustom = suggestion.id.startsWith('custom_');

            const item = document.createElement('div');
            item.className = 'galvan-suggestions-item';
            item.dataset.id = suggestion.id;
            item.dataset.text = suggestion.text;
            item.dataset.isCustom = isCustom;

            item.innerHTML = `
                <div class="galvan-suggestion-actions-background">
                    <div class="galvan-suggestion-delete-action">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </div>
                </div>
                <div class="galvan-suggestion-item-inner">
                    <div class="galvan-suggestion-content">
                        <span class="icon">${suggestion.icon}</span>
                        <span class="text">${escapeHtml(suggestion.text)}</span>
                    </div>
                </div>
            `;
            
            suggestionsContainer.appendChild(item);
            addSuggestionSwipeListeners(item);
        });
    };

    const addSuggestionSwipeListeners = (item) => {
        const inner = item.querySelector('.galvan-suggestion-item-inner');
        const deleteAction = item.querySelector('.galvan-suggestion-delete-action');
        const isCustom = item.dataset.isCustom === 'true';

        let startX = 0, currentX = 0, isDragging = false;
        const SWIPE_THRESHOLD = 80;

        const onDragStart = (e) => {
            if (!isCustom) return;
            isDragging = true;
            startX = e.pageX || e.touches[0].pageX;
            inner.style.transition = 'none';
            deleteAction.style.transition = 'none';
            item.classList.add('is-swiping');
        };

        const onDragMove = (e) => {
            if (!isDragging || !isCustom) return;
            e.preventDefault();
            currentX = (e.pageX || e.touches[0].pageX) - startX;
            currentX = Math.min(0, currentX); 

            inner.style.transform = `translateX(${currentX}px)`;
            deleteAction.style.transform = `translateX(${item.clientWidth + currentX}px)`;
        };

        const onDragEnd = () => {
            if (!isDragging || !isCustom) return;
            isDragging = false;
            item.classList.remove('is-swiping');

            inner.style.transition = 'transform 0.4s var(--ease-soft-spring)';
            deleteAction.style.transition = 'transform 0.4s var(--ease-soft-spring)';

            if (currentX < -SWIPE_THRESHOLD) { // Reveal and lock
                inner.style.transform = `translateX(-${deleteAction.clientWidth}px)`;
                deleteAction.style.transform = `translateX(${item.clientWidth - deleteAction.clientWidth}px)`;
                
                deleteAction.onclick = (e) => {
                    e.stopPropagation();
                    deleteSuggestion(item.dataset.id, item);
                };
            } else { // Snap back
                inner.style.transform = 'translateX(0)';
                deleteAction.style.transform = 'translateX(100%)';
            }
            currentX = 0;
        };

        inner.addEventListener('click', (e) => {
            if (Math.abs(currentX) > 5) {
                e.preventDefault();
                e.stopPropagation();
            } else {
                sendSuggestion(item.dataset.text);
            }
        }, true);
        
        inner.addEventListener('mousedown', onDragStart);
        inner.addEventListener('touchstart', onDragStart, { passive: true });
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('touchmove', onDragMove, { passive: false });
        document.addEventListener('mouseup', onDragEnd);
        document.addEventListener('touchend', onDragEnd);
    };

    const sendSuggestion = (text) => {
        if (body.classList.contains("bot-responding")) return;
        promptInput.value = text;
        promptInput.focus();
        sendBtn.disabled = false;
        promptInput.dispatchEvent(new Event('input'));
        const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
        promptForm.dispatchEvent(submitEvent);
    };

    const deleteSuggestion = (id, element) => {
        element.classList.add('deleting');
        element.style.transform = 'translateX(-100%) scale(0.8)';
        element.style.opacity = '0';
        element.style.maxHeight = '0px';
        element.style.marginBottom = '0px';
        element.style.padding = '0';
        
        setTimeout(() => {
            let custom = getUserData('customSuggestions').filter(s => s.id !== id);
            setUserData('customSuggestions', custom);
            element.remove();
            showTemporaryToast('Suggestion removed.');
        }, 500);
    };

    // --- NEW: Bottom Sheet Selector Logic ---
    const openBottomSheet = (selectId) => {
        const selectDataMap = {
            'vv-shape': { title: 'Logo design', options: VV_SHAPES, current: getUserData('vvShape'), callback: applyVVShape },
            'font-family': { title: 'Font', options: FONT_FAMILIES, current: getUserData('fontFamily'), callback: applyFontFamily },
            'font-size': { title: 'Wave Size', options: FONT_SIZES, current: getUserData('fontSize'), callback: applyFontSize },
            'app-lock-type': { title: 'No lock system', options: APP_LOCK_TYPES, current: getUserData('appLockType'), callback: () => {} }
        };

        const selectData = selectDataMap[selectId];
        if (!selectData) return;

        bottomSheetTitle.textContent = selectData.title;
        bottomSheetOptionsList.innerHTML = '';

        Object.keys(selectData.options).forEach((key, index) => {
            const option = selectData.options[key];
            const li = document.createElement('li');
            li.className = 'galvan-bottom-sheet-option';
            li.dataset.value = key;
            li.style.animationDelay = `${0.1 + index * 0.04}s`;

            const isSelected = key === selectData.current;
            if (isSelected) li.classList.add('selected');

            li.innerHTML = `
                <span>${option.name}</span>
                <span class="check-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                </span>
            `;

            li.addEventListener('click', () => {
                selectData.callback(key);
                updateCustomSelect(selectId, key);
                closeBottomSheet();
            });

            bottomSheetOptionsList.appendChild(li);
        });

        bottomSheetOverlay.classList.add('visible');
    };

    const closeBottomSheet = () => {
        bottomSheetOverlay.classList.remove('visible');
    };

    bottomSheetCloseBtn.addEventListener('click', closeBottomSheet);
    bottomSheetOverlay.addEventListener('click', (e) => {
        if (e.target === bottomSheetOverlay) {
            closeBottomSheet();
        }
    });

    const setupCustomSelects = () => {
        document.querySelectorAll('.galvan-custom-select-trigger').forEach(trigger => {
            const selectId = trigger.dataset.selectId;
            updateCustomSelect(selectId, getUserData(selectId)); // Initial text
            trigger.addEventListener('click', () => openBottomSheet(selectId));
        });
    };

    const updateCustomSelect = (selectId, value) => {
        const trigger = document.querySelector(`.galvan-custom-select-trigger[data-select-id="${selectId}"]`);
        if (!trigger) return;
        
        const dataMap = {
            'vv-shape': { options: VV_SHAPES },
            'font-family': { options: FONT_FAMILIES },
            'font-size': { options: FONT_SIZES },
            'app-lock-type': { options: APP_LOCK_TYPES }
        };
        const data = dataMap[selectId];

        if (data && data.options[value]) {
            trigger.textContent = data.options[value].name;
        }
    };
    
    // [REFACTORED] UI 30 - App Lock Logic
    const setLockEnabled = (enabled) => {
        setUserData('appLockEnabled', enabled);
        if (settingToggleAppLock) settingToggleAppLock.checked = enabled;
        appLockTypeSettingItem.style.display = enabled ? 'flex' : 'none';
        if (!enabled) {
            setUserData('appLockCode', null);
            showTemporaryToast('App Lock disabled.');
        }
    };
    
    const initializeLockScreen = () => {
        if (getUserData('appLockEnabled') && getUserData('appLockCode')) {
            lockState = 'locked';
            showLockScreen();
        } else {
            hideLockScreen();
        }
    };

    const showLockScreen = () => {
        container.classList.add('locked');
        pinInput = '';
        updatePinDots();
        pinLockOverlay.classList.add('visible');
        pinLockContainer.classList.remove('error');

        pinLockAvatarContainer.innerHTML = '';
        const avatarClone = vvStructureContainer.cloneNode(true);
        avatarClone.removeAttribute('style');
        pinLockAvatarContainer.appendChild(avatarClone);

        if (lockState === 'set') {
            pinLockTitle.textContent = `Set New PIN`;
            pinLockSubtitle.textContent = `Enter a 4-digit PIN.`;
        } else if (lockState === 'confirm') {
            pinLockTitle.textContent = `Confirm PIN`;
            pinLockSubtitle.textContent = 'Re-enter your PIN to confirm.';
        } else { // 'locked'
            pinLockTitle.textContent = `Enter PIN`;
            pinLockSubtitle.textContent = 'Enter your PIN to unlock.';
        }
    };

    const hideLockScreen = () => {
        container.classList.remove('locked');
        pinLockOverlay.classList.remove('visible');
    };
    
    const processLockInput = (input) => {
        if (lockState === 'locked') {
            if (input === getUserData('appLockCode')) {
                hideLockScreen();
                showTemporaryToast('Welcome!');
            } else {
                pinLockContainer.classList.add('error');
                pinLockSubtitle.textContent = 'Incorrect PIN. Please try again.';
                setTimeout(() => { pinInput = ''; updatePinDots(); }, 400);
            }
        } else if (lockState === 'set') {
            temporaryLockValue = input;
            lockState = 'confirm';
            showLockScreen();
        } else if (lockState === 'confirm') {
            if (input === temporaryLockValue) {
                setUserData('appLockCode', input);
                setLockEnabled(true);
                lockState = 'locked';
                hideLockScreen();
                showTemporaryToast('App Lock enabled!');
            } else {
                pinLockContainer.classList.add('error');
                pinLockSubtitle.textContent = "PINs don't match. Start over.";
                lockState = 'set';
                temporaryLockValue = '';
                setTimeout(showLockScreen, 1000);
            }
        }
    };

    const updatePinDots = () => pinDots.forEach((dot, i) => dot.classList.toggle('filled', i < pinInput.length));
    
    pinKeypad.addEventListener('click', (e) => {
        const keyElement = e.target.closest('.galvan-pin-key');
        if (!keyElement) return;
        const key = keyElement.dataset.key;
        
        pinLockContainer.classList.remove('error');
        if (key === 'backspace') {
            pinInput = pinInput.slice(0, -1);
        } else if (pinInput.length < 4 && !isNaN(parseInt(key))) {
            pinInput += key;
        }
        
        updatePinDots();
        if (pinInput.length === 4) {
            setTimeout(() => processLockInput(pinInput), 200);
        }
    });

    lockScreenForgotBtn.addEventListener('click', () => {
        if(confirm("Forgot PIN? This will reset all app data, including history and settings, to clear the lock. This cannot be undone. Proceed?")) {
            localStorage.clear();
            resetOverlay.classList.add('show');
            setTimeout(() => location.reload(), 1500);
        }
    });

    if (settingToggleAppLock) {
        settingToggleAppLock.addEventListener('change', (e) => {
            const isEnabled = e.target.checked;
            if (isEnabled) {
                if (!getUserData('appLockCode')) {
                    lockState = 'set';
                    showLockScreen();
                    closecommandBarExpandedView();
                } else {
                    setLockEnabled(true);
                }
            } else {
                setLockEnabled(false);
            }
        });
    }

    const initializeApp = () => {
        captureBaseThemeVariables(); 
        loadSettings();

        if (getUserData('syncWithSystemTheme')) {
            applyLightDarkMode(!MQL.matches, false);
        } else {
            loadLightDarkModePreference();
        }

        initializeLockScreen();
        loadFullChatHistoryFromStorage(); 
        loadVVImagePreference(); 
        loadBlurPreference(); 
        loadFontPreferences();
        loadVVShapePreference();
        
        checkUnreadNotices();
        applyColorPalette(getUserData('colorPalette') || 'galvan', false);
        renderSuggestions();

        const initialSettings = [
            { el: settingToggleSuggestionsSwitch, key: 'showSuggestions', class: 'hide-suggestions', inverse: true },
            { el: settingToggleAIThoughtsSwitch, key: 'showAiThoughts', class: 'hide-ai-thoughts', inverse: true },
            { el: settingToggleAttachmentsSwitch, key: 'enableAttachments', callback: (checked) => { if(addFileBtn) addFileBtn.style.display = checked ? 'flex' : 'none'; } },
            { el: settingToggleAutoUpdateSwitch, key: 'autoUpdate' },
            { el: settingToggleAppLock, key: 'appLockEnabled' },
            { el: settingToggleSystemThemeSwitch, key: 'syncWithSystemTheme' }
        ];
        initialSettings.forEach(s => {
            const value = getUserData(s.key) ?? getDefaultSettings()[s.key];
            if (s.el) s.el.checked = value;
            if (s.class) body.classList.toggle(s.class, s.inverse ? !value : defaultValue);
            if (s.callback) s.callback(value);
        });
        
        appLockTypeSettingItem.style.display = getUserData('appLockEnabled') ? 'flex' : 'none';

        if ((getUserData('chatHistory') || []).length > 0) {
             currentChatSession = [...getUserData('chatHistory')];
             renderChatHistoryToDOM(currentChatSession);
             setActiveNavButton(mainHistoryNavBtn, commandBar); body.classList.add('chats-active'); 
        } else {
             setActiveNavButton(homeBtn, commandBar); body.classList.remove('chats-active'); 
        }
         _goHome(true); 

        body.classList.add('app-loaded'); 
        setupCustomSelects(); 
        if(settingAppVersionDisplay) settingAppVersionDisplay.textContent = CURRENT_APP_VERSION_FOR_NOTICE;
        body.classList.remove('bot-responding', 'suggestions-scrolled', 'command-bar-expanded');
        sendBtn.disabled = true;
        
        vvIsEditing = false; updateVVControlsVisibility(); 

        console.log(`Galvan AI Initialized (${CURRENT_APP_VERSION_FOR_NOTICE})`);
        if (!IS_API_KEY_VALID) { console.warn("API Key invalid/not configured. Simulation Mode."); if (!sessionStorage.getItem('demoToastShown')) { showTemporaryToast("Demo mode: API Key issue. Responses simulated."); sessionStorage.setItem('demoToastShown', 'true'); }}
        else { console.log("API Key Valid."); sessionStorage.removeItem('demoToastShown'); }
        
        promptInput.dispatchEvent(new Event('input')); 
        updateBlurControlVisibility(); 
    };

    // --- Final App Initialization ---
    initializeApp();

</script>